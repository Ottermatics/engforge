<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.eng.pipes &mdash; engforge 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/readthedocs-custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/test.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.eng.pipes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.eng.pipes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;We&#39;ll use the QP formulation to develop a fluid analysis system for fluids</span>
<span class="sd">start with single phase and move to others</span>


<span class="sd">1) Pumps Power = C x Q x P </span>
<span class="sd">2) Compressor = C x (QP) x (PR^C2 - 1)</span>
<span class="sd">3) Pipes = dP = C x fXL/D x V^2 / 2g</span>
<span class="sd">4) Pipe Fittings / Valves = dP = C x V^2 (fXL/D +K)   |   K is a constant, for valves it can be interpolated between closed and opened</span>
<span class="sd">5) Splitters &amp; Joins: Handle fluid mixing</span>
<span class="sd">6) Phase Separation (This one is gonna be hard)</span>
<span class="sd">7) Heat Exchanger dP = f(V,T) - phase change issues</span>
<span class="sd">8) Filtration dP = k x Vxc x (Afrontal/Asurface) &quot;linear&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">engforge.components</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">engforge.configuration</span> <span class="kn">import</span> <span class="n">forge</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">engforge.tabulation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">system_property</span><span class="p">,</span>
    <span class="n">NUMERIC_VALIDATOR</span><span class="p">,</span>
    <span class="n">STR_VALIDATOR</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">engforge.eng.fluid_material</span> <span class="kn">import</span> <span class="n">FluidMaterial</span>
<span class="kn">from</span> <span class="nn">engforge.common</span> <span class="kn">import</span> <span class="n">G_grav_constant</span>
<span class="kn">from</span> <span class="nn">engforge.attr_slots</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.attr_signals</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.logging</span> <span class="kn">import</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span> <span class="nn">engforge.system</span> <span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span> <span class="nn">engforge.properties</span> <span class="kn">import</span> <span class="o">*</span>


<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">import</span> <span class="nn">attr</span><span class="o">,</span> <span class="nn">attrs</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">fluids</span>

<span class="kn">import</span> <span class="nn">attrs</span>


<div class="viewcode-block" id="PipeLog">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeLog.html#engforge.eng.pipes.PipeLog">[docs]</a>
<span class="k">class</span> <span class="nc">PipeLog</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">):</span>
    <span class="k">pass</span></div>



<span class="n">log</span> <span class="o">=</span> <span class="n">PipeLog</span><span class="p">()</span>

<span class="c1">#TODO: add compressibility effects</span>
<div class="viewcode-block" id="PipeNode">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeNode.html#engforge.eng.pipes.PipeNode">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">PipeNode</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>

    <span class="n">_segments</span><span class="p">:</span> <span class="nb">list</span>  <span class="c1"># created on init</span>

    <span class="k">def</span> <span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_segments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipe</span><span class="p">:</span> <span class="s2">&quot;PipeFlow&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pipe</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pipe already added: </span><span class="si">{</span><span class="n">pipe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">segments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segments</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">sum_of_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pipe_seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">node_s</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">-=</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">Q</span>
            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">node_e</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">Q</span>
        <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="PipeFlow">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeFlow.html#engforge.eng.pipes.PipeFlow">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">PipeFlow</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="n">D</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">Slot</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">FluidMaterial</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">flow</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># Geometric Propreties</span>
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">A</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the cross sectional area of pipe in [m2]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">3.1415</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the sectional circmerence of pipe&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">3.1415</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>

    <span class="c1"># Fluid Propreties</span>
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the volumetric flow through this pipe in [m3/s]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Mf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the massflow through this pipe in [kg/s]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">reynoldsNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the flow reynolds number&quot;&quot;&quot;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Material Properties Exposure</span>
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">density</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">viscosity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">viscosity</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">enthalpy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">enthalpy</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_T</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">new_T</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">P</span>

    <span class="nd">@P</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_P</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">new_P</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dP_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to pressure&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dP_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to potential&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dP_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Fvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the fluidized vector for 1D CFD for continuity:0, and momentum:1&quot;&quot;&quot;</span>
        <span class="c1"># TODO: add energy eq</span>
        <span class="c1"># TODO: 1D CFD Pipe Network Solver :)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># TODO: include Txx</span></div>



<div class="viewcode-block" id="Pipe">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.Pipe.html#engforge.eng.pipes.Pipe">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">PipeFlow</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
    <span class="n">node_s</span> <span class="o">=</span> <span class="n">Slot</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">PipeNode</span><span class="p">,</span> <span class="n">default_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">node_e</span> <span class="o">=</span> <span class="n">Slot</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">PipeNode</span><span class="p">,</span> <span class="n">default_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">roughness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">bend_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">straight_method</span> <span class="o">=</span> <span class="s2">&quot;Clamond&quot;</span>
    <span class="n">laminar_method</span> <span class="o">=</span> <span class="s2">&quot;Schmidt laminar&quot;</span>
    <span class="n">turbulent_method</span> <span class="o">=</span> <span class="s2">&quot;Schmidt turbulent&quot;</span>

    <span class="k">def</span> <span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_s</span><span class="o">.</span><span class="n">add_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_e</span><span class="o">.</span><span class="n">add_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Lx</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_e</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_s</span><span class="o">.</span><span class="n">x</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Ly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_e</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_s</span><span class="o">.</span><span class="n">y</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Lz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_e</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_s</span><span class="o">.</span><span class="n">z</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Lhz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: The length of pipe element in the XY plane&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">L</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: The absolute length of pipe element&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">inclination</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the inclination angle in degrees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lhz</span><span class="p">))</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">friction_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The friction factor considering bend radius&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bend_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reynoldsNumber</span>
            <span class="k">return</span> <span class="n">fluids</span><span class="o">.</span><span class="n">friction</span><span class="o">.</span><span class="n">friction_factor</span><span class="p">(</span>
                <span class="n">re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roughness</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">straight_method</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reynoldsNumber</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bend_radius</span>
            <span class="k">return</span> <span class="n">fluids</span><span class="o">.</span><span class="n">friction</span><span class="o">.</span><span class="n">friction_factor_curved</span><span class="p">(</span>
                <span class="n">re</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span>
                <span class="n">dc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roughness</span><span class="p">,</span>
                <span class="n">laminar_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">laminar_method</span><span class="p">,</span>
                <span class="n">turbulent_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">turbulent_method</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">Kpipe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss coeffient of this pipe section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to pressure&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kpipe</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to potential&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span> <span class="o">*</span> <span class="mf">9.81</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_f</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_p</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span></div>



<span class="c1"># Specalized Nodes</span>
<div class="viewcode-block" id="FlowNode">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.FlowNode.html#engforge.eng.pipes.FlowNode">[docs]</a>
<span class="k">class</span> <span class="nc">FlowNode</span><span class="p">(</span><span class="n">PipeNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base For Boundary Condition Nodes of&quot;&quot;&quot;</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="PipeFitting">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeFitting.html#engforge.eng.pipes.PipeFitting">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">PipeFitting</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">,</span> <span class="n">PipeFlow</span><span class="p">):</span>
    <span class="n">Kfitting</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to pressure&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kfitting</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The loss of pressure in the pipe due to potential&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">dP_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_f</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_p</span></div>



<span class="c1"># TODO: Add in fitting numbers:</span>
<span class="c1">#https://neutrium.net/fluid-flow/pressure-loss-from-fittings-excess-head-k-method/</span>
<span class="c1"># https://neutrium.net/fluid-flow/discharge-coefficient-for-nozzles-and-orifices/</span>
<span class="sd">&quot;&quot;&quot;                          Fitting                      Types       K</span>
<span class="sd">0                       45° Elbow         Standard (R/D = 1)    0.35</span>
<span class="sd">1                       45° Elbow    Long Radius (R/D = 1.5)    0.20</span>
<span class="sd">2                90° Elbow Curved         Standard (R/D = 1)    0.75</span>
<span class="sd">3                90° Elbow Curved    Long Radius (R/D = 1.5)    0.45</span>
<span class="sd">4      90° Elbow Square or Mitred                        NaN    1.30</span>
<span class="sd">5                       180° Bend               Close Return    1.50</span>
<span class="sd">6                Tee, Run Through             Branch Blanked    0.40</span>
<span class="sd">7                   Tee, as Elbow            Entering in run    1.00</span>
<span class="sd">8                   Tee, as Elbow         Entering in branch    1.00</span>
<span class="sd">9             Tee, Branching Flow                        NaN    1.00</span>
<span class="sd">10                       Coupling                        NaN    0.04</span>
<span class="sd">11                          Union                        NaN    0.04</span>
<span class="sd">12                     Gate valve                 Fully Open    0.17</span>
<span class="sd">13                     Gate valve                   3/4 Open    0.90</span>
<span class="sd">14                     Gate valve                   1/2 Open    4.50</span>
<span class="sd">15                     Gate valve                   1/4 Open   24.00</span>
<span class="sd">16                Diaphragm valve                 Fully Open    2.30</span>
<span class="sd">17                Diaphragm valve                   3/4 Open    2.60</span>
<span class="sd">18                Diaphragm valve                   1/2 Open    4.30</span>
<span class="sd">19                Diaphragm valve                   1/4 Open   21.00</span>
<span class="sd">20        Globe valve, Bevel Seat                 Fully Open    6.00</span>
<span class="sd">21        Globe valve, Bevel Seat                   1/2 Open    9.50</span>
<span class="sd">22  Globe Valve, Composition seat                 Fully Open    6.00</span>
<span class="sd">23  Globe Valve, Composition seat                   1/2 Open    8.50</span>
<span class="sd">24                      Plug disk                 Fully Open    9.00</span>
<span class="sd">25                      Plug disk                   3/4 Open   13.00</span>
<span class="sd">26                      Plug disk                   1/2 Open   36.00</span>
<span class="sd">27                      Plug disk                   1/4 Open  112.00</span>
<span class="sd">28                    Angle valve                 Fully Open    2.00</span>
<span class="sd">29       Y valve or blowoff valve                 Fully Open    3.00</span>
<span class="sd">30                      Plug cock                \theta = 5°    0.05</span>
<span class="sd">31                      Plug cock               \theta = 10°    0.29</span>
<span class="sd">32                      Plug cock               \theta = 20°    1.56</span>
<span class="sd">33                      Plug cock               \theta = 40°   17.30</span>
<span class="sd">34                      Plug cock               \theta = 60°  206.00</span>
<span class="sd">35                Butterfly valve                \theta = 5°    0.24</span>
<span class="sd">36                Butterfly valve               \theta = 10°    0.52</span>
<span class="sd">37                Butterfly valve               \theta = 20°    1.54</span>
<span class="sd">38                Butterfly valve               \theta = 40°   10.80</span>
<span class="sd">39                Butterfly valve               \theta = 60°  118.00</span>
<span class="sd">40                    Check valve                      Swing    2.00</span>
<span class="sd">41                    Check valve                       Disk   10.00</span>
<span class="sd">42                    Check valve                       Ball   70.00</span>
<span class="sd">43                     Foot valve                        NaN   15.00</span>
<span class="sd">44                    Water meter                       Disk    7.00</span>
<span class="sd">45                    Water meter                     Piston   15.00</span>
<span class="sd">46                    Water meter  Rotary (star-shaped disk)   10.00</span>
<span class="sd">47                    Water meter              Turbine-wheel    6.00&quot;&quot;&quot;</span>


<span class="c1">#</span>
<div class="viewcode-block" id="FlowInput">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.FlowInput.html#engforge.eng.pipes.FlowInput">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">FlowInput</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="n">flow_in</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">sum_of_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_in</span>
        <span class="k">for</span> <span class="n">pipe_seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">node_s</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">-=</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">Q</span>
            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">node_e</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">pipe_seg</span><span class="o">.</span><span class="n">Q</span>
        <span class="k">return</span> <span class="n">out</span></div>



<span class="c1">#</span>
<span class="c1"># class PressureInput(FlowNode):</span>
<span class="c1">#     pressure_in: float = attrs.field()</span>
<span class="c1">#</span>
<span class="c1"># class PressureOut(FlowNode):</span>
<span class="c1">#     pressure_out: float = attrs.field()</span>


<div class="viewcode-block" id="Pump">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.Pump.html#engforge.eng.pipes.Pump">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">Pump</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates a pump with power input, max flow, and max pressure by assuming a flow characteristic&quot;&quot;&quot;</span>

    <span class="n">max_flow</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
    <span class="n">max_pressure</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
    <span class="c1"># throttle: float</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">design_flow_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: a tuple output of flow vector, and pressure vector&quot;&quot;&quot;</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_flow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pressure</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">flow</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_flow</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>

<div class="viewcode-block" id="Pump.dPressure">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.Pump.html#engforge.eng.pipes.Pump.dPressure">[docs]</a>
    <span class="k">def</span> <span class="nf">dPressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_flow</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The pressure the pump generates&quot;&quot;&quot;</span>
        <span class="n">flow</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_flow_curve</span>
        <span class="k">assert</span> <span class="n">current_flow</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Flow must be positive&quot;</span>
        <span class="k">assert</span> <span class="n">current_flow</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_flow</span><span class="p">,</span> <span class="s2">&quot;Flow must be less than max flow&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">current_flow</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">dP</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pump.power">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.Pump.html#engforge.eng.pipes.Pump.power">[docs]</a>
    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_flow</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The power used considering in watts&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dPressure</span><span class="p">(</span><span class="n">current_flow</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_flow</span></div>
</div>



<div class="viewcode-block" id="PipeSystem">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeSystem.html#engforge.eng.pipes.PipeSystem">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">PipeSystem</span><span class="p">(</span><span class="n">System</span><span class="p">):</span>
    <span class="n">in_node</span> <span class="o">=</span> <span class="n">Slot</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">PipeNode</span><span class="p">)</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span>
    <span class="n">items</span><span class="p">:</span> <span class="nb">dict</span>

    <span class="k">def</span> <span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe_flow</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_from_pipe_or_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assemble_solvers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assemble_solvers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">cycle_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)):</span>
            <span class="n">cycle_attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_cycle_redisual_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">pipes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found cycle: </span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                <span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)[</span><span class="s2">&quot;pipe&quot;</span><span class="p">]</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cs</span> <span class="o">==</span> <span class="n">pipe</span><span class="o">.</span><span class="n">node_e</span><span class="o">.</span><span class="n">system_id</span><span class="p">:</span>
                    <span class="c1"># reverse</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">pipes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pipe</span><span class="p">,</span> <span class="n">mult</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">res_func</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">mult</span> <span class="ow">in</span> <span class="n">pipes</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">pipe</span><span class="o">.</span><span class="n">dP_tot</span>
                <span class="k">return</span> <span class="n">out</span> <span class="o">/</span> <span class="mf">1000.0</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle_attr_name</span><span class="p">,</span> <span class="n">res_func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span><span class="p">[</span><span class="n">cycle_attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle_attr_name</span><span class="p">)</span>

        <span class="n">bf</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">bf</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;sum_of_flows&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FlowInput</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deadend: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># self.flow_solvers[nid] = Ref(node,&#39;sum_of_flows&#39;)</span>

        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FlowInput</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;sum_of_flows&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipe_flow</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_flow</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_F</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">F_keyword_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;defines the order of inputs in ordered mode for calcF&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_solvers</span><span class="p">)}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">PipeNode</span><span class="p">)}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Pipe</span><span class="p">)}</span>

    <span class="c1"># Pipe System Composition</span>
<div class="viewcode-block" id="PipeSystem.add_to_graph">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeSystem.html#engforge.eng.pipes.PipeSystem.add_to_graph">[docs]</a>
    <span class="k">def</span> <span class="nf">add_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_or_pipe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recursively add node or pipe elements&quot;&quot;&quot;</span>

        <span class="n">idd</span> <span class="o">=</span> <span class="n">node_or_pipe</span><span class="o">.</span><span class="n">system_id</span>

        <span class="c1"># Early Exit</span>
        <span class="k">if</span> <span class="n">idd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idd</span>

        <span class="k">elif</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">idd</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">idd</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="n">idd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_pipe</span><span class="p">,</span> <span class="n">PipeNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">idd</span><span class="p">):</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">idd</span><span class="p">,</span> <span class="n">sys_id</span><span class="o">=</span><span class="n">idd</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node_or_pipe</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_or_pipe</span>

            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">node_or_pipe</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_pipe</span><span class="p">,</span> <span class="n">Pipe</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">node_or_pipe</span><span class="o">.</span><span class="n">node_s</span>
            <span class="n">nodee</span> <span class="o">=</span> <span class="n">node_or_pipe</span><span class="o">.</span><span class="n">node_e</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">system_id</span><span class="p">):</span>
                <span class="n">nsid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nsid</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">system_id</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">nodee</span><span class="o">.</span><span class="n">system_id</span><span class="p">):</span>
                <span class="n">neid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nodee</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neid</span> <span class="o">=</span> <span class="n">nodee</span><span class="o">.</span><span class="n">system_id</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">nsid</span><span class="p">,</span> <span class="n">neid</span><span class="p">):</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">nsid</span><span class="p">,</span> <span class="n">neid</span><span class="p">,</span> <span class="n">sys_id</span><span class="o">=</span><span class="n">idd</span><span class="p">,</span> <span class="n">pipe</span><span class="o">=</span><span class="n">node_or_pipe</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_or_pipe</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not a node or pipe: </span><span class="si">{</span><span class="n">node_or_pipe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idd</span></div>


<div class="viewcode-block" id="PipeSystem.create_graph_from_pipe_or_node">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.pipes.PipeSystem.html#engforge.eng.pipes.PipeSystem.create_graph_from_pipe_or_node">[docs]</a>
    <span class="k">def</span> <span class="nf">create_graph_from_pipe_or_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_or_pipe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a networkx graph from a pipe or node&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_pipe</span><span class="p">,</span> <span class="n">PipeNode</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">node_or_pipe</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_pipe</span><span class="p">,</span> <span class="n">Pipe</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">node_or_pipe</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not a node or pipe: </span><span class="si">{</span><span class="n">node_or_pipe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span></div>


    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyvis.network</span> <span class="kn">import</span> <span class="n">Network</span>

            <span class="n">net</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">net</span><span class="o">.</span><span class="n">from_nx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;process_graph.html&quot;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span></div>





<span class="c1">#TODO: update compressibility:</span>
<span class="c1"># </span>
<span class="c1"># import control as ct</span>
<span class="c1"># import numpy as np</span>
<span class="c1"># from engforge.components import Component, forge</span>
<span class="c1"># from matplotlib.pylab import *</span>
<span class="c1"># </span>
<span class="c1"># DT_DFLT = 1E-3</span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class Accumulator(Component):</span>
<span class="c1"># </span>
<span class="c1">#     Rt: float = 5000</span>
<span class="c1">#     Pref: float = 1E6</span>
<span class="c1">#     Lref: float = 5</span>
<span class="c1">#     Aact: float = 5</span>
<span class="c1">#     Cact: float = 0.1</span>
<span class="c1">#     Mact: float = 0.1</span>
<span class="c1">#     Pmax: float = 7E8</span>
<span class="c1">#     tlast: float = 0</span>
<span class="c1">#     Kwall: float = 1</span>
<span class="c1"># </span>
<span class="c1">#     lim_marg: float = 0.01</span>
<span class="c1">#     min_dt: float = DT_DFLT</span>
<span class="c1"># </span>
<span class="c1">#     model: &#39;InputOutputSystem&#39; = None</span>
<span class="c1"># </span>
<span class="c1">#     discrete: bool = True</span>
<span class="c1">#     pressure_mode: bool = False #false is flow based</span>
<span class="c1"># </span>
<span class="c1">#     def __on_init__(self):</span>
<span class="c1">#         #handle defined pressure mode</span>
<span class="c1">#         if self.pressure_mode:</span>
<span class="c1">#             if not self.discrete:</span>
<span class="c1">#                 self.model =  ct.NonlinearIOSystem(self.pr_update_accumulator,self.pr_accumulator_output,inputs=(&#39;Pi&#39;,),outputs=(&#39;Pc&#39;,&#39;Qc&#39;,&#39;Pout&#39;),states=(&#39;x&#39;,&#39;v&#39;),name= self.name if self.name else &#39;accumul    ator&#39;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.model =  ct.NonlinearIOSystem(self.pr_discrete_update_accumulator,self.pr_accumulator_output,inputs=(&#39;Pi&#39;,),outputs=(&#39;Pc&#39;,&#39;Qc&#39;,&#39;Pout&#39;),states=(&#39;x&#39;,&#39;v&#39;),name= self.name if self.name else &#39;accumulator&#39;,dt=True)</span>
<span class="c1">#         else:</span>
<span class="c1">#             if not self.discrete:</span>
<span class="c1">#                 self.model =  ct.NonlinearIOSystem(self.w_update_accumulator,self.w_output,inputs=(&#39;Qc&#39;,),outputs=(&#39;Pc&#39;,&#39;Pout&#39;),states=(&#39;x&#39;),name= self.name if self.name else &#39;accumulator&#39;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.model =  ct.NonlinearIOSystem(self.w_discrete_update_accumulator, self.w_output,inputs=(&#39;Qc&#39;,),outputs=(&#39;Pc&#39;,&#39;Pout&#39;),states=(&#39;x&#39;),name= self.name if self.name else &#39;accumulator&#39;,dt=True)                </span>
<span class="c1">#                 </span>
<span class="c1">#     def w_update_accumulator(self,t,x,u,params):</span>
<span class="c1">#         Rt = params.get(&#39;Rt&#39;,self.Rt) #Pa/(m3/s)</span>
<span class="c1">#         Pref = params.get(&#39;Pref&#39;,self.Pref)</span>
<span class="c1">#         Lref = params.get(&#39;Lref&#39;,self.Lref)</span>
<span class="c1">#         Aact = params.get(&#39;Aact&#39;,self.Aact)</span>
<span class="c1">#         Cact = params.get(&#39;Cact&#39;,self.Cact)</span>
<span class="c1">#         Mact = params.get(&#39;Mact&#39;,self.Mact)</span>
<span class="c1">#         Kwall = params.get(&#39;Kwall&#39;,self.Kwall)</span>
<span class="c1">#         Pmax = params.get(&#39;Pmax&#39;,self.Pmax)</span>
<span class="c1"># </span>
<span class="c1">#         qin  = u[0]</span>
<span class="c1">#         </span>
<span class="c1">#         xact   = x[0]</span>
<span class="c1">#         #Pi  = x[0]</span>
<span class="c1">#         </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             self.dt = dt = self.model.dt</span>
<span class="c1"># </span>
<span class="c1">#         else: #infer dt</span>
<span class="c1">#             if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#                 self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#                 self.tlast = t</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1"># </span>
<span class="c1">#         #determine rate of x change (positive compresses accumulator (x-&gt;0))</span>
<span class="c1">#         xdot = -qin/Aact</span>
<span class="c1"># </span>
<span class="c1">#         xmin = Pref*Lref/Pmax</span>
<span class="c1"># </span>
<span class="c1">#         #limit xdot to prevent over/under shoot</span>
<span class="c1">#         if xact + dt * xdot &gt; Lref*(1-self.lim_marg):</span>
<span class="c1">#             xdot = (Lref-xact)/dt</span>
<span class="c1">#         elif xact + dt * xdot &lt; xmin:</span>
<span class="c1">#             xdot = (xmin-xact)/dt</span>
<span class="c1"># </span>
<span class="c1">#         return xdot</span>
<span class="c1">#     </span>
<span class="c1">#     def w_discrete_update_accumulator(self,t,x,u,params):</span>
<span class="c1">#         v = self.w_update_accumulator(t,x,u,params)</span>
<span class="c1">#         dt = self.model.dt</span>
<span class="c1"># </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             dt = self.model.dt</span>
<span class="c1">#         else:</span>
<span class="c1">#             dt = self.dt</span>
<span class="c1"># </span>
<span class="c1">#         xnew= x[0] + v*dt</span>
<span class="c1"># </span>
<span class="c1">#         return xnew</span>
<span class="c1">#     </span>
<span class="c1">#     def w_output(self,t,x,u,params):</span>
<span class="c1">#         Rt = params.get(&#39;Rt&#39;,self.Rt) #Pa/(m3/s)</span>
<span class="c1">#         Pref = params.get(&#39;Pref&#39;,self.Pref)</span>
<span class="c1">#         Lref = params.get(&#39;Lref&#39;,self.Lref)</span>
<span class="c1">#         Aact = params.get(&#39;Aact&#39;,self.Aact)</span>
<span class="c1">#         Cact = params.get(&#39;Cact&#39;,self.Cact)</span>
<span class="c1">#         Mact = params.get(&#39;Mact&#39;,self.Mact)</span>
<span class="c1">#         Kwall = params.get(&#39;Kwall&#39;,self.Kwall)</span>
<span class="c1">#         Pmax = params.get(&#39;Pmax&#39;,self.Pmax)</span>
<span class="c1"># </span>
<span class="c1">#         qin  = u[0]</span>
<span class="c1">#         </span>
<span class="c1">#         xact   = x[0]   </span>
<span class="c1"># </span>
<span class="c1">#         xmin = Pref*Lref/Pmax</span>
<span class="c1"># </span>
<span class="c1">#         Pcomp = Pref*Lref / max(xmin,xact)             </span>
<span class="c1"># </span>
<span class="c1">#         #junction pressure is higher than pcomp when accumulator is compressed</span>
<span class="c1">#         Pi = Pcomp + qin*Rt</span>
<span class="c1"># </span>
<span class="c1">#         return [Pcomp,Pi]</span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1">#                 </span>
<span class="c1"># </span>
<span class="c1">#     def pr_update_accumulator(self,t,x,u,params):</span>
<span class="c1">#         &quot;&quot;&quot;takes the current accumulator position, external pressure, and accumulator constants to determine the rate of change of accumulator position&quot;&quot;&quot;</span>
<span class="c1">#         Rt = params.get(&#39;Rt&#39;,self.Rt) #Pa/(m3/s)</span>
<span class="c1">#         Pref = params.get(&#39;Pref&#39;,self.Pref)</span>
<span class="c1">#         Lref = params.get(&#39;Lref&#39;,self.Lref)</span>
<span class="c1">#         Aact = params.get(&#39;Aact&#39;,self.Aact)</span>
<span class="c1">#         Cact = params.get(&#39;Cact&#39;,self.Cact)</span>
<span class="c1">#         Mact = params.get(&#39;Mact&#39;,self.Mact)</span>
<span class="c1">#         Kwall = params.get(&#39;Kwall&#39;,self.Kwall)</span>
<span class="c1">#         Pmax = params.get(&#39;Pmax&#39;,self.Pmax)</span>
<span class="c1"># </span>
<span class="c1">#         Pi = u[0]</span>
<span class="c1">#         #print(x,u)</span>
<span class="c1">#         xact = x[0]</span>
<span class="c1">#         v    = x[1]</span>
<span class="c1"># </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             self.dt = dt = self.model.dt</span>
<span class="c1"># </span>
<span class="c1">#         else: #infer dt</span>
<span class="c1">#             if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#                 self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#                 self.tlast = t</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1"># </span>
<span class="c1">#         xmin = Pref*Lref/Pmax</span>
<span class="c1"># </span>
<span class="c1">#         Pcomp = Pref*Lref / max(max(xmin,xact),Lref)</span>
<span class="c1">#         dP = Pcomp-Pi</span>
<span class="c1">#         sgn = np.sign(dP)</span>
<span class="c1"># </span>
<span class="c1">#         #FIXME: remove since dP is based on equillibritum</span>
<span class="c1">#         #xeq = max(min(Pref*Lref/Pi,Lref),xmin)</span>
<span class="c1">#         #K = 0*self.Kwall*(xeq-xact)/Lref</span>
<span class="c1">#         K = 0</span>
<span class="c1"># </span>
<span class="c1">#         xdot =  sgn * ( abs(dP) / ( Rt * Aact**2.))**0.5/Lref</span>
<span class="c1">#         dvdt = ((xdot-v) - K)/Mact - Cact*Aact*v*abs(v)/Mact</span>
<span class="c1"># </span>
<span class="c1">#         x_proj = v * dt + xact</span>
<span class="c1"># </span>
<span class="c1">#         #Consider projected limits</span>
<span class="c1">#         if x_proj &gt;= Lref*(1-self.lim_marg):</span>
<span class="c1">#             vin = v</span>
<span class="c1">#             v = (Lref-xact)/dt#,-1*Lref/10/dt)</span>
<span class="c1">#             dvdt = (v-vin)/dt</span>
<span class="c1"># </span>
<span class="c1">#         elif x_proj &lt;= xmin: </span>
<span class="c1">#             vin = v</span>
<span class="c1">#             v = (0 - xact)/dt</span>
<span class="c1">#             dvdt = (v-vin)/dt</span>
<span class="c1"># </span>
<span class="c1">#         return v,dvdt</span>
<span class="c1"># </span>
<span class="c1">#     def pr_discrete_update_accumulator(self,t,x,u,params):</span>
<span class="c1">#         v,dvdt = self.pr_update_accumulator(t,x,u,params)</span>
<span class="c1">#         dt = self.model.dt</span>
<span class="c1"># </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             dt = self.model.dt</span>
<span class="c1">#         else:</span>
<span class="c1">#             dt = self.dt</span>
<span class="c1"># </span>
<span class="c1">#         xnew= x[0] + v*dt</span>
<span class="c1">#         vnew = x[1] + dvdt*dt</span>
<span class="c1"># </span>
<span class="c1">#         return xnew,vnew</span>
<span class="c1"># </span>
<span class="c1">#     def pr_accumulator_output(self,t,x,u,params):</span>
<span class="c1">#         &quot;&quot;&quot;returns accumulator pressure and flow (in positive)&quot;&quot;&quot;    </span>
<span class="c1">#         Rt = params.get(&#39;Rt&#39;,self.Rt) #Pa/(m3/s)</span>
<span class="c1">#         Pref = params.get(&#39;Pref&#39;,self.Pref)</span>
<span class="c1">#         Lref = params.get(&#39;Lref&#39;,self.Lref)</span>
<span class="c1">#         Aact = params.get(&#39;Aact&#39;,self.Aact)</span>
<span class="c1">#         Cact = params.get(&#39;Cact&#39;,self.Cact)</span>
<span class="c1">#         Mact = params.get(&#39;Mact&#39;,self.Mact)</span>
<span class="c1">#         Pmax = params.get(&#39;Pmax&#39;,self.Pmax)</span>
<span class="c1">#         #dt = params.get(&#39;dt&#39;,self.dt)</span>
<span class="c1"># </span>
<span class="c1">#         Pi = u[0]</span>
<span class="c1">#         xact = x[0]</span>
<span class="c1">#         v    = x[1]</span>
<span class="c1"># </span>
<span class="c1">#         xmin = Pref*Lref/Pmax</span>
<span class="c1">#         Pcomp = Pref*Lref / max(xmin,xact)</span>
<span class="c1">#         Q = v*Aact</span>
<span class="c1">#         return [Pcomp,Q,Pi]</span>
<span class="c1">#     </span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class Motor(Component):</span>
<span class="c1">#     &quot;&quot;&quot;Nonlinear motor with parasitics with fixed displacement&quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#     I: float = 1</span>
<span class="c1">#     D: float = 1E-6</span>
<span class="c1">#     Cd: float = 0.0</span>
<span class="c1">#     Ckloss: float = 0</span>
<span class="c1">#     f: float = 0.0</span>
<span class="c1">#     N: float = 1000</span>
<span class="c1"># </span>
<span class="c1">#     min_dt: float = DT_DFLT</span>
<span class="c1">#     model: &#39;InputOutputSystem&#39; = None</span>
<span class="c1">#     discrete: bool = True</span>
<span class="c1">#     tlast = 0   </span>
<span class="c1"># </span>
<span class="c1">#     def __on_init__(self):</span>
<span class="c1">#         #print(self.name)</span>
<span class="c1">#         if not self.discrete:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.update_motor, self.motor_output, inputs=(&#39;P1&#39;,&#39;P2&#39;), outputs=(&#39;Trq&#39;,&#39;Q&#39;,&#39;Pwr&#39;,&#39;Pin&#39;,&#39;Pout&#39;), state=(&#39;w&#39;,), name=self.name if self.name else &#39;motor&#39;)         </span>
<span class="c1">#         else:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.discrete_update_motor, self.motor_output, inputs=(&#39;P1&#39;,&#39;P2&#39;), outputs=(&#39;Trq&#39;,&#39;Q&#39;,&#39;Pwr&#39;,&#39;Pin&#39;,&#39;Pout&#39;), state=(&#39;w&#39;,), name=self.name if self.name else &#39;motor&#39;,dt=True) </span>
<span class="c1">#             self.tlast = 0   </span>
<span class="c1"># </span>
<span class="c1">#     def update_motor(self,t,x,u,params):</span>
<span class="c1">#         &quot;&quot;&quot;updates the motor acceleration based on pressure differential and nonlinear parasitics&quot;&quot;&quot;</span>
<span class="c1">#         I = params.get(&#39;I&#39;,self.I)</span>
<span class="c1">#         D = params.get(&#39;D&#39;,self.D)</span>
<span class="c1">#         Cd = params.get(&#39;Cd&#39;,self.Cd)</span>
<span class="c1">#         Ckloss = params.get(&#39;Ckloss&#39;,self.Ckloss)</span>
<span class="c1">#         f = params.get(&#39;f&#39;,self.f)</span>
<span class="c1">#         N = params.get(&#39;N&#39;,self.N)</span>
<span class="c1">#         </span>
<span class="c1">#         P1 = u[0]</span>
<span class="c1">#         P2 = u[1]</span>
<span class="c1">#         w = x[0]</span>
<span class="c1"># </span>
<span class="c1">#         Q = D*(w/(2*3.14159))</span>
<span class="c1">#         dPq = np.sign(Q)*Ckloss*Q**2</span>
<span class="c1">#         </span>
<span class="c1">#         dw_torque = (D/(2*np.pi))* ((P1 - P2)-dPq)</span>
<span class="c1">#         dw_friction = w*f*N</span>
<span class="c1">#         dw_drag = w*abs(w)*Cd</span>
<span class="c1">#         </span>
<span class="c1">#         return (dw_torque - dw_friction - dw_drag)/I</span>
<span class="c1">#     </span>
<span class="c1">#     def discrete_update_motor(self,t,x,u,params):</span>
<span class="c1">#         dw = self.update_motor(t,x,u,params)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             self.dt = dt = self.model.dt</span>
<span class="c1"># </span>
<span class="c1">#         else: #infer dt</span>
<span class="c1">#             if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#                 self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#                 self.tlast = t</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1"># </span>
<span class="c1">#         return x[0] + dw*self.dt</span>
<span class="c1">#         </span>
<span class="c1">#     def motor_output(self,t,x,u,params):</span>
<span class="c1">#         &quot;&quot;&quot;calculates torque, flow and power output&quot;&quot;&quot;</span>
<span class="c1">#         I = params.get(&#39;I&#39;,self.I)</span>
<span class="c1">#         D = params.get(&#39;D&#39;,self.D)</span>
<span class="c1">#         Cd = params.get(&#39;Cd&#39;,self.Cd)</span>
<span class="c1">#         Ckloss = params.get(&#39;Ckloss&#39;,self.Ckloss)</span>
<span class="c1">#         f = params.get(&#39;f&#39;,self.f)</span>
<span class="c1">#         N = params.get(&#39;N&#39;,self.N)</span>
<span class="c1">#         </span>
<span class="c1">#         P1 = u[0]</span>
<span class="c1">#         P2 = u[1]</span>
<span class="c1">#         w = x[0]</span>
<span class="c1">#         </span>
<span class="c1">#         Q = (w/2*3.14159)*D</span>
<span class="c1">#         dPq = np.sign(Q)*Ckloss*Q**2</span>
<span class="c1"># </span>
<span class="c1">#         dP = (P1 - P2) - dPq</span>
<span class="c1"># </span>
<span class="c1">#         Trq = D * dP / (2*3.14159)</span>
<span class="c1">#         Pwr = dP * Q</span>
<span class="c1">#         return [Trq, Q, Pwr,P1,P2]   </span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class Actuator(Component):</span>
<span class="c1">#     Ap: float = 1</span>
<span class="c1">#     mp: float = 0.5</span>
<span class="c1">#     bp: float = 0.1</span>
<span class="c1">#     Kwall: float = 1000</span>
<span class="c1">#     Lstroke: float = 1   </span>
<span class="c1">#     </span>
<span class="c1">#     min_dt = DT_DFLT</span>
<span class="c1">#     lim_marg = 0.01</span>
<span class="c1">#     </span>
<span class="c1">#     lim = None # true if high, false if low and none otherwise</span>
<span class="c1"># </span>
<span class="c1">#     model: &#39;InterConnectedSystem&#39; = None</span>
<span class="c1"># </span>
<span class="c1">#     discrete: bool = True</span>
<span class="c1"># </span>
<span class="c1">#     tlast = 0</span>
<span class="c1"># </span>
<span class="c1">#     def __on_init__(self):</span>
<span class="c1">#         if self.discrete:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.discrete_update_fnc,self.output_fnc,state=(&#39;x&#39;,&#39;v&#39;),outputs=(&#39;Q1&#39;,&#39;Q2&#39;,&#39;P1&#39;,&#39;P2&#39;),inputs=(&#39;F&#39;,&#39;P1&#39;,&#39;P2&#39;),dt=True,name=self.name if self.name else &#39;actuator&#39;)</span>
<span class="c1"># </span>
<span class="c1">#         else:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.update_fnc,self.output_fnc,state=(&#39;x&#39;,&#39;v&#39;),outputs=(&#39;Q1&#39;,&#39;Q2&#39;,&#39;P1&#39;,&#39;P2&#39;),inputs=(&#39;F&#39;,&#39;P1&#39;,&#39;P2&#39;),name=self.name if self.name else &#39;actuator&#39;)</span>
<span class="c1"># </span>
<span class="c1">#             </span>
<span class="c1"># </span>
<span class="c1">#     def update_fnc(self,t,x,u,params):</span>
<span class="c1">#         Ap = params.get(&#39;Ap&#39;,self.Ap)</span>
<span class="c1">#         mp = params.get(&#39;mp&#39;,self.mp)</span>
<span class="c1">#         bp = params.get(&#39;bp&#39;,self.bp)</span>
<span class="c1">#         Kwall = params.get(&#39;Kwall&#39;,self.Kwall)</span>
<span class="c1">#         Lstroke = params.get(&#39;Lstroke&#39;,self.Lstroke)</span>
<span class="c1"># </span>
<span class="c1">#         xpos = x[0]</span>
<span class="c1">#         v = x[1]</span>
<span class="c1"># </span>
<span class="c1">#         f = u[0]</span>
<span class="c1">#         p1 = u[1]</span>
<span class="c1">#         p2 = u[2]</span>
<span class="c1">#         </span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             dt = self.model.dt</span>
<span class="c1">#             self.dt = dt</span>
<span class="c1"># </span>
<span class="c1">#         else: #infer dt</span>
<span class="c1">#             if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#                 self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#                 self.tlast = t</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1"># </span>
<span class="c1">#         if xpos &gt; Lstroke:</span>
<span class="c1">#             #print(&#39;kpos&#39;)</span>
<span class="c1">#             K = self.Kwall*(xpos-Lstroke)</span>
<span class="c1">#         elif xpos &lt; 0:</span>
<span class="c1">#             #print(&#39;kneg&#39;)</span>
<span class="c1">#             K = self.Kwall*(xpos - 0)</span>
<span class="c1">#         else:</span>
<span class="c1">#             K = 0</span>
<span class="c1">#         </span>
<span class="c1">#         daf = f - (p1-p2)*Ap</span>
<span class="c1">#         dad = bp*v*abs(v)</span>
<span class="c1">#         dvdt = (daf - dad - K*daf)/mp    </span>
<span class="c1"># </span>
<span class="c1">#         x_proj = v * dt + xpos</span>
<span class="c1">#         </span>
<span class="c1">#         if x_proj &gt;= Lstroke*(1-self.lim_marg):</span>
<span class="c1">#             vin = v</span>
<span class="c1">#             v = (Lstroke-xpos)/dt</span>
<span class="c1">#             dvdt = min((v-vin)/dt,dvdt)</span>
<span class="c1">#     </span>
<span class="c1">#         elif x_proj &lt;= self.lim_marg: </span>
<span class="c1">#             vin = v</span>
<span class="c1">#             v = (0 - xpos)/dt</span>
<span class="c1">#             dvdt = max((v-vin)/dt,dvdt)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         return [v,dvdt]</span>
<span class="c1">#     </span>
<span class="c1">#     def discrete_update_fnc(self,t,x,u,params):</span>
<span class="c1">#         v,dvdt = self.update_fnc(t,x,u,params)</span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             dt = self.model.dt</span>
<span class="c1">#         else:</span>
<span class="c1">#             dt = self.dt</span>
<span class="c1"># </span>
<span class="c1">#         if hasattr(self,&#39;last_a&#39;):</span>
<span class="c1">#             dvdt = (self.last_a + dvdt)/2</span>
<span class="c1">#             v = (self.last_v + v)/2</span>
<span class="c1"># </span>
<span class="c1">#         vnew = v + dvdt*dt</span>
<span class="c1">#         newx = x[0] + v*dt</span>
<span class="c1"># </span>
<span class="c1">#         if newx &lt; 0:</span>
<span class="c1">#             newx = 0</span>
<span class="c1">#             if vnew &lt; 0:</span>
<span class="c1">#                 vnew = 0</span>
<span class="c1"># </span>
<span class="c1">#         elif newx &gt; self.Lstroke:</span>
<span class="c1">#             newx = self.Lstroke</span>
<span class="c1">#             if vnew &gt; 0:</span>
<span class="c1">#                 vnew = 0</span>
<span class="c1"># </span>
<span class="c1">#         self.last_x = newx</span>
<span class="c1">#         self.last_v = vnew</span>
<span class="c1">#         self.last_a = dvdt</span>
<span class="c1"># </span>
<span class="c1">#         return newx, vnew</span>
<span class="c1"># </span>
<span class="c1">#     def output_fnc(self,t,x,u,params):</span>
<span class="c1">#         Ap = params.get(&#39;Ap&#39;,self.Ap)</span>
<span class="c1"># </span>
<span class="c1">#         v = x[1]</span>
<span class="c1"># </span>
<span class="c1">#         Q1 = -1*v * Ap</span>
<span class="c1">#         Q2 = v * Ap</span>
<span class="c1"># </span>
<span class="c1">#         return [Q1,Q2,u[1],u[2]]</span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class Pipe(Component):</span>
<span class="c1">#     &#39;&#39;&#39;models pressure change and flow Q from nodes with pressure P1-&gt;P2&#39;&#39;&#39;</span>
<span class="c1">#     Kp:float = 1 #TODO: better friction model</span>
<span class="c1">#     </span>
<span class="c1">#     flow_input: bool = False</span>
<span class="c1">#     model: &#39;InputOutputSystem&#39; = None</span>
<span class="c1"># </span>
<span class="c1">#     def __on_init__(self):</span>
<span class="c1">#         if not self.flow_input:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.pipe_flow,self.pipe_flow_output,state=(&#39;Q&#39;),inputs=(&#39;P1&#39;,&#39;P2&#39;),outputs=(&#39;P1o&#39;,&#39;P2o&#39;,&#39;Q&#39;),dt=True,name=self.name if self.name else &#39;pipe&#39;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.pipe_pressure,self.pipe_pressure_output,state=(&#39;P2&#39;),inputs=(&#39;P1&#39;,&#39;Q&#39;),outputs=(&#39;P1o&#39;,&#39;P2&#39;,&#39;Q&#39;),dt=True,name=self.name if self.name else &#39;pipe&#39;)</span>
<span class="c1"># </span>
<span class="c1">#     def pipe_flow(self,t,x,u,params):</span>
<span class="c1">#         Kp = params.get(&#39;Kp&#39;,self.Kp)</span>
<span class="c1">#         p1 = u[0]</span>
<span class="c1">#         p2 = u[1]</span>
<span class="c1">#         dP = (p2-p1)</span>
<span class="c1">#         return -1*np.sign(dP)*(abs(dP)/Kp)**0.5</span>
<span class="c1">#         </span>
<span class="c1">#     def pipe_pressure(self,t,x,u,params):</span>
<span class="c1">#         Kp = params.get(&#39;Kp&#39;,self.Kp)</span>
<span class="c1">#         p1 = u[0]</span>
<span class="c1">#         q = u[1]</span>
<span class="c1">#         return -1*np.sign(q)*Kp*q**2 + p1</span>
<span class="c1">#         </span>
<span class="c1">#     def pipe_flow_output(self,t,x,u,params):</span>
<span class="c1">#         return [u[0],u[1],x[0]]</span>
<span class="c1">#         </span>
<span class="c1">#     def pipe_pressure_output(self,t,x,u,params):</span>
<span class="c1">#         return [u[0],x[0],u[1]]</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class Valve(Component):</span>
<span class="c1">#     Ao: float = 0.1 #area</span>
<span class="c1">#     ts: float = 30/1000. #seconds</span>
<span class="c1">#     rho: float = 1000</span>
<span class="c1">#     Cd: float = 0.1</span>
<span class="c1">#     discrete_control: bool = True    # contorl signal is zero or one, vs a goal</span>
<span class="c1">#     </span>
<span class="c1">#     tlast = 0</span>
<span class="c1">#     min_dt:float = 1E-3</span>
<span class="c1"># </span>
<span class="c1">#     def update_alpha(self,t,x,u,params):        </span>
<span class="c1">#         ts = params.get(&#39;ts&#39;,self.ts)</span>
<span class="c1">#         uctl = u[0]</span>
<span class="c1">#         alpha = x[0]</span>
<span class="c1">#         </span>
<span class="c1">#         if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#             self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#             self.tlast = t</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1"># </span>
<span class="c1">#         dA = 1.0 / ts</span>
<span class="c1">#         </span>
<span class="c1">#         if self.discrete_control:</span>
<span class="c1">#             if uctl==1:</span>
<span class="c1">#                 if alpha &lt; 1-dA*dt:</span>
<span class="c1">#                     return dA</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     return 1-alpha</span>
<span class="c1">#             elif uctl==0:</span>
<span class="c1">#                 if alpha &gt; dA*dt:</span>
<span class="c1">#                     return dA</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     return 0-alpha</span>
<span class="c1">#         else:</span>
<span class="c1">#             vctl = min(max(uctl,0),1)</span>
<span class="c1">#             d = (uctl-alpha)/dt</span>
<span class="c1">#             dv = max(min(d,dA),-dA)</span>
<span class="c1">#             return dv</span>
<span class="c1">#                 </span>
<span class="c1">#         </span>
<span class="c1">#     def get_flow(self,t,x,u,params):</span>
<span class="c1">#         rho = params.get(&#39;rho&#39;,self.rho)</span>
<span class="c1">#         ts = params.get(&#39;ts&#39;,self.ts)</span>
<span class="c1">#         Cd = params.get(&#39;Cd&#39;,self.Cd)</span>
<span class="c1">#         Ao = params.get(&#39;Ao&#39;,self.Ao)</span>
<span class="c1"># </span>
<span class="c1">#         alpha = x[0]</span>
<span class="c1">#         if alpha &lt; 0.05:</span>
<span class="c1">#             return 0.0 #avoid divide by zero in area</span>
<span class="c1">#         </span>
<span class="c1">#         dP = u[1] </span>
<span class="c1">#         Av = Ao*min(max(alpha,0),1)</span>
<span class="c1">#         return np.sign(dP)*Cd*Av*((2/rho)*abs(dP))**0.5</span>
<span class="c1"># </span>
<span class="c1"># @forge(auto_attribs=True)</span>
<span class="c1"># class PipeJunction(Component):</span>
<span class="c1">#     </span>
<span class="c1">#     n_pipes: int = 2</span>
<span class="c1">#     Vi: float = 1</span>
<span class="c1">#     B: float = 300E3</span>
<span class="c1">#     </span>
<span class="c1">#     min_dt = DT_DFLT</span>
<span class="c1">#     model: &#39;InputOutputSystem&#39; = None</span>
<span class="c1">#     discrete:bool = True</span>
<span class="c1">#     </span>
<span class="c1">#     def __on_init__(self):</span>
<span class="c1">#         state = (&#39;P&#39;,)</span>
<span class="c1">#         inputs = tuple(f&#39;Q{i+1}&#39; for i in range(self.n_pipes))</span>
<span class="c1">#         outins = tuple(f&#39;Qout{i+1}&#39; for i in range(self.n_pipes))</span>
<span class="c1">#         outputs = tuple(list(state)+list(outins)+[&#39;dQ&#39;])</span>
<span class="c1">#         if self.discrete:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.discrete_pressure_update,self.output,inputs=inputs,outputs=outputs,state=state,dt=True,name=self.name if self.name else &#39;junction&#39;)</span>
<span class="c1">#             self.tlast = 0</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.model = ct.NonlinearIOSystem(self.pressure_update,self.output,inputs=inputs,outputs=outputs,state=state,name=self.name if self.name else &#39;junction&#39;)</span>
<span class="c1">#             </span>
<span class="c1">#     def pressure_update(self,t,x,u,params):</span>
<span class="c1">#         #TODO: update compressibility from temp / pressure ect.</span>
<span class="c1">#         B = params.get(&#39;B&#39;,self.B)</span>
<span class="c1">#         Vi = params.get(&#39;Vi&#39;,self.Vi)</span>
<span class="c1">#         sumQ = sum(u)</span>
<span class="c1">#         dPdt = (B/Vi)*sumQ</span>
<span class="c1">#         return dPdt</span>
<span class="c1">#         </span>
<span class="c1">#     def discrete_pressure_update(self,t,x,u,params):</span>
<span class="c1">#         dPdt = self.pressure_update(t,x,u,params)</span>
<span class="c1">#         if self.discrete and isinstance(self.model.dt,float):</span>
<span class="c1">#             dt = self.model.dt</span>
<span class="c1">#             self.dt = dt</span>
<span class="c1"># </span>
<span class="c1">#         else: #infer dt</span>
<span class="c1">#             if t &gt;= self.tlast+self.min_dt:</span>
<span class="c1">#                 self.dt = dt = max(abs(t - self.tlast),self.min_dt)</span>
<span class="c1">#                 self.tlast = t</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.dt = dt = getattr(self,&#39;dt&#39;,self.min_dt)</span>
<span class="c1">#         return self.dt*dPdt + x[0]</span>
<span class="c1">#         </span>
<span class="c1">#     def output(self,t,x,u,parms):</span>
<span class="c1">#         return tuple([x[0]]+list(u)+[sum(u)])</span>
<span class="c1">#       </span>













<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">0.015</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">Po</span> <span class="o">=</span> <span class="mf">1e5</span>

    <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Po</span> <span class="o">*</span> <span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="n">Pin</span> <span class="o">=</span> <span class="mf">1.1e5</span>
    <span class="n">Uin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Ps</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">Pin</span> <span class="o">-</span> <span class="n">Ps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">ui</span>
        <span class="n">F2</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">*</span> <span class="n">ui</span> <span class="o">+</span> <span class="n">ps</span>
        <span class="k">return</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span>

    <span class="k">def</span> <span class="nf">J</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">decodeF</span><span class="p">(</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">):</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">F2</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">up</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">up</span><span class="p">,</span> <span class="n">pp</span>

    <span class="n">plast</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ulast</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">started</span> <span class="ow">or</span> <span class="p">(</span><span class="n">plast</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ulast</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">plast</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ulast</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># inlet</span>
                <span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ui</span> <span class="o">=</span> <span class="n">Uin</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
                <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ui</span>

            <span class="c1"># STATUS</span>
            <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">J1</span><span class="p">,</span> <span class="n">J2</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># PREDICT i+1</span>
            <span class="n">dF1</span><span class="p">,</span> <span class="n">dF2</span> <span class="o">=</span> <span class="n">J1</span><span class="p">,</span> <span class="n">J2</span>
            <span class="n">Fp1</span><span class="p">,</span> <span class="n">Fp2</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">+</span> <span class="n">dF1</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">dF2</span> <span class="o">*</span> <span class="n">L</span>

            <span class="n">up1</span><span class="p">,</span> <span class="n">pp1</span> <span class="o">=</span> <span class="n">decodeF</span><span class="p">(</span><span class="n">Fp1</span><span class="p">,</span> <span class="n">Fp2</span><span class="p">)</span>

            <span class="c1"># CORRECTOR i+1</span>
            <span class="n">Jp1</span><span class="p">,</span> <span class="n">Jp2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">dpF1</span><span class="p">,</span> <span class="n">dpF2</span> <span class="o">=</span> <span class="n">Jp1</span><span class="p">,</span> <span class="n">Jp2</span>

            <span class="c1"># avgGradients</span>
            <span class="n">dF1n</span><span class="p">,</span> <span class="n">dF2n</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dpF1</span> <span class="o">+</span> <span class="n">dF1</span><span class="p">),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dpF2</span> <span class="o">+</span> <span class="n">dF2</span><span class="p">)</span>

            <span class="c1"># Calculate i+1 actual</span>
            <span class="n">Fn1</span><span class="p">,</span> <span class="n">Fn2</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">+</span> <span class="n">dF1n</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">dF2n</span> <span class="o">*</span> <span class="n">L</span>

            <span class="n">un</span><span class="p">,</span> <span class="n">pn</span> <span class="o">=</span> <span class="n">decodeF</span><span class="p">(</span><span class="n">Fn1</span><span class="p">,</span> <span class="n">Fn2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">u</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">un</span>
                <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
            <span class="c1"># if i == 0: #inlet</span>
            <span class="c1">#    ps = p[i]</span>
            <span class="c1">#    ui = Uin(ps)</span>
            <span class="c1">#    u[i] = ui</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Po</span>

            <span class="c1"># STATUS</span>
            <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">J1</span><span class="p">,</span> <span class="n">J2</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># PREDICT i+1</span>
            <span class="n">dF1</span><span class="p">,</span> <span class="n">dF2</span> <span class="o">=</span> <span class="n">J1</span><span class="p">,</span> <span class="n">J2</span>
            <span class="n">Fp1</span><span class="p">,</span> <span class="n">Fp2</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">+</span> <span class="n">dF1</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">dF2</span> <span class="o">*</span> <span class="n">L</span>

            <span class="n">up1</span><span class="p">,</span> <span class="n">pp1</span> <span class="o">=</span> <span class="n">decodeF</span><span class="p">(</span><span class="n">Fp1</span><span class="p">,</span> <span class="n">Fp2</span><span class="p">)</span>

            <span class="c1"># CORRECTOR i+1</span>
            <span class="n">Jp1</span><span class="p">,</span> <span class="n">Jp2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">dpF1</span><span class="p">,</span> <span class="n">dpF2</span> <span class="o">=</span> <span class="n">Jp1</span><span class="p">,</span> <span class="n">Jp2</span>

            <span class="c1"># avgGradients</span>
            <span class="n">dF1n</span><span class="p">,</span> <span class="n">dF2n</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dpF1</span> <span class="o">+</span> <span class="n">dF1</span><span class="p">),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dpF2</span> <span class="o">+</span> <span class="n">dF2</span><span class="p">)</span>

            <span class="c1"># Calculate i+1 actual</span>
            <span class="n">Fn1</span><span class="p">,</span> <span class="n">Fn2</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">+</span> <span class="n">dF1n</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">dF2n</span> <span class="o">*</span> <span class="n">L</span>

            <span class="n">un</span><span class="p">,</span> <span class="n">pn</span> <span class="o">=</span> <span class="n">decodeF</span><span class="p">(</span><span class="n">Fn1</span><span class="p">,</span> <span class="n">Fn2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">u</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">un</span>
                <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>