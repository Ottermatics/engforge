<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.eng.costs &mdash; engforge 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/readthedocs-custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/test.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.eng.costs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.eng.costs</h1><div class="highlight"><pre>
<span></span>
<span class="sd">&quot;&quot;&quot;Defines a CostModel &amp; Economics Component that define &amp; orchestrate cost accounting respectively.</span>

<span class="sd">CostModels can have a `cost_per_item` and additionally calculate a `cumulative_cost` from internally defined `CostModel`s.</span>

<span class="sd">CostModel&#39;s can have cost_property&#39;s which detail how and when a cost should be applied &amp; grouped. By default each CostModel has a `cost_per_item` which is reflected in `item_cost` cost_property set on the `initial` term as a `unit` category. Multiple categories of cost are also able to be set on cost_properties as follows</span>

<span class="sd">```</span>
<span class="sd">@forge</span>
<span class="sd">class Widget(Component,CostModel):</span>

<span class="sd">    @cost_property(mode=&#39;initial&#39;,category=&#39;capex,manufacturing&#39;)</span>
<span class="sd">    def cost_of_XYZ(self):</span>
<span class="sd">        return ...</span>
<span class="sd">```</span>

<span class="sd">Economics models sum CostModel.cost_properties recursively on the parent they are defined. Economics computes the grouped category costs for each item recursively as well as summary properties like annualized values and levalized cost. Economic output is determined by a `fixed_output` or overriding `calculate_production(self,parent)` to dynamically calculate changing economics based on factors in the parent.</span>

<span class="sd">Default costs can be set on any CostModel.Slot attribute, by using default_cost(&lt;slot_name&gt;,&lt;cost&gt;) on the class, this will provide a default cost for the slot if no cost is set on the instance. Custom costs can be set on the instance with custom_cost(&lt;slot_name&gt;,&lt;cost&gt;). If cost is a CostModel, it will be assigned to the slot if it is not already assigned.</span>

<span class="sd">The economics term_length applies costs over the term, using the `cost_property.mode` to determine at which terms a cost should be applied.</span>

<span class="sd">@forge</span>
<span class="sd">class Parent(System,CostModel)</span>

<span class="sd">    econ = Slot.define(Economics) #will calculate parent costs as well</span>
<span class="sd">    cost = Slot.define(Widget) #slots automatically set to none if no input provided</span>

<span class="sd">Parent(econ=Economics(term_length=25,discount_rate=0.05,fixed_output=1000))</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">engforge.components</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">engforge.configuration</span> <span class="kn">import</span> <span class="n">forge</span><span class="p">,</span><span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">engforge.tabulation</span> <span class="kn">import</span> <span class="n">TabulationMixin</span><span class="p">,</span> <span class="n">system_property</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">engforge.properties</span> <span class="kn">import</span> <span class="n">instance_cached</span><span class="p">,</span><span class="n">solver_cached</span><span class="p">,</span><span class="n">cached_system_property</span>
<span class="kn">from</span> <span class="nn">engforge.logging</span> <span class="kn">import</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span> <span class="nn">engforge.component_collections</span> <span class="kn">import</span> <span class="n">ComponentIter</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">attrs</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<div class="viewcode-block" id="CostLog">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostLog.html#engforge.eng.costs.CostLog">[docs]</a>
<span class="k">class</span> <span class="nc">CostLog</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">):</span><span class="k">pass</span></div>

<span class="n">log</span> <span class="o">=</span> <span class="n">CostLog</span><span class="p">()</span>

<span class="c1">#Cost Term Modes are a quick lookup for cost term support</span>
<span class="k">global</span> <span class="n">COST_TERM_MODES</span><span class="p">,</span><span class="n">COST_CATEGORIES</span>
<span class="n">COST_TERM_MODES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">inst</span><span class="p">,</span><span class="n">term</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">term</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">inst</span><span class="p">,</span><span class="n">term</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">term</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s1">&#39;always&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">inst</span><span class="p">,</span><span class="n">term</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="n">category_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">]</span>
<span class="n">COST_CATEGORIES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s1">&#39;misc&#39;</span><span class="p">,))</span>



<div class="viewcode-block" id="cost_property">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.cost_property.html#engforge.eng.costs.cost_property">[docs]</a>
<span class="k">class</span> <span class="nc">cost_property</span><span class="p">(</span><span class="n">system_property</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A thin wrapper over `system_property` that will be accounted by `Economics` Components and apply term &amp; categorization</span>

<span class="sd">    `cost_property` should return a float/int always and will raise an error if the return annotation is different, although annotations are not required and will default to float.</span>

<span class="sd">    #Terms:</span>
<span class="sd">    Terms start counting at 0 and can be evald by the Economic.term_length</span>
<span class="sd">    cost_properties will return their value as system_properties do without regard for the term state, however a CostModel&#39;s costs at a term can be retrived by `costs_at_term`. The default mode is for `initial` cost</span>

<span class="sd">    #Categories:</span>
<span class="sd">    Categories are a way to report cost categories and multiple can be applied to a cost. Categories are grouped by the Economics system at reported in bulk by term and over the term_length</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cost_categories</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">term_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_all_modes</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">COST_TERM_MODES</span>
    <span class="n">_all_categories</span><span class="p">:</span><span class="nb">set</span> <span class="o">=</span> <span class="n">COST_CATEGORIES</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fdel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stochastic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">,</span><span class="n">category</span><span class="p">:</span><span class="n">category_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extends system_property interface with mode &amp; category keywords</span>
<span class="sd">        :param mode: can be one of `initial`,`maintenance`,`always` or a function with signature f(inst,term) as an integer and returning a boolean True if it is to be applied durring that term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fget</span><span class="p">,</span> <span class="n">fset</span><span class="p">,</span> <span class="n">fdel</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">stochastic</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">COST_TERM_MODES</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not in </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">COST_TERM_MODES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_all_modes</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_mode</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> must be cost term str or callable&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cost_categories</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cost_categories</span> <span class="o">=</span> <span class="n">category</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;categories: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1"> not string or list&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_all_categories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">apply_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inst</span><span class="p">,</span><span class="n">term</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">term</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;negative term!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_all_modes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">term_mode</span><span class="p">](</span><span class="n">inst</span><span class="p">,</span><span class="n">term</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="cost_property.get_func_return">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.cost_property.html#engforge.eng.costs.cost_property.get_func_return">[docs]</a>
    <span class="k">def</span> <span class="nf">get_func_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ensures that the function has a return annotation, and that return annotation is in valid sort types&quot;&quot;&quot;</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__annotations__</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">anno</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;system_property input: function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must have valid return annotation of type: </span><span class="si">{</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="o">=</span> <span class="nb">float</span></div>
</div>


<div class="viewcode-block" id="CostModel">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">CostModel</span><span class="p">(</span><span class="n">Configuration</span><span class="p">,</span><span class="n">TabulationMixin</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CostModel is a mixin for components or systems that reports its costs through the `cost` system property, which by default sums the `item_cost` and `sub_items_cost`.</span>

<span class="sd">    `item_cost` is determined by `calculate_item_cost()` which by default uses: `cost_per_item` field to return the item cost, which defaults to `numpy.nan` if not set. Nan values are ignored and replaced with 0.</span>
<span class="sd">    </span>
<span class="sd">    `sub_items_cost` system_property summarizes the costs of any component in a Slot that has a `CostModel` or for SlotS which CostModel.declare_cost(`slot`,default=numeric|CostModelInst|dict[str,float])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_slot_costs</span><span class="p">:</span> <span class="nb">dict</span> <span class="c1">#TODO: insantiate per class</span>

    <span class="n">cost_per_item</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_costs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting default costs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CostModel.update_dflt_costs">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.update_dflt_costs">[docs]</a>
    <span class="k">def</span> <span class="nf">update_dflt_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;updates internal default slot costs if the current component doesn&#39;t exist or isn&#39;t a cost model, this is really a component method but we will use it never the less.</span>
<span class="sd">        </span>
<span class="sd">        This should be called from Component.update() if default costs are used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
            <span class="n">current_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_components</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1">#Check if the cost model will  be accessed</span>
                <span class="n">no_comp</span> <span class="o">=</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_comps</span>
                <span class="n">is_cost</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_comp</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_comps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">CostModel</span><span class="p">)</span>
                <span class="n">dflt_is_cost_comp</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">CostModel</span><span class="p">),</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Component</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">no_comp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_cost</span> <span class="ow">and</span> <span class="n">dflt_is_cost_comp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updating default </span><span class="si">{k}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

                 
<div class="viewcode-block" id="CostModel.set_default_costs">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.set_default_costs">[docs]</a>
    <span class="k">def</span> <span class="nf">set_default_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set default costs if no costs are set&quot;&quot;&quot;</span>
        <span class="n">inter_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_configurations</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">dflt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inter_config</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">attrs</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inter_config</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting default cost </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> from costmodel class, provide a default instance instead!&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">dflt</span><span class="p">())</span>

        <span class="c1">#Reset cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_components</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CostModel.subcls_compile">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.subcls_compile">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">subcls_compile</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">ComponentIter</span><span class="p">),</span> <span class="s1">&#39;component iter not supported&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;compiling costs </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">reset_cls_costs</span><span class="p">()</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reset_cls_costs</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_slot_costs</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="CostModel.default_cost">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.default_cost">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_cost</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">slot_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">cost</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;CostModel&#39;</span><span class="p">],</span><span class="n">warn_on_non_costmodel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide a default cost for Slot items that are not CostModel&#39;s. Cost is applied class wide, but can be overriden with custom_cost per instance&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="nb">type</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;insantiate classes before adding as a cost!&#39;</span>
        <span class="k">assert</span> <span class="n">slot_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;slot </span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1"> doesnt exist&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">dict</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="n">CostModel</span><span class="p">),</span> <span class="s1">&#39;only numeric types or CostModel instances supported&#39;</span>

        <span class="n">atrb</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()[</span><span class="n">slot_name</span><span class="p">]</span>
        <span class="n">atypes</span> <span class="o">=</span> <span class="n">atrb</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">accepted</span>
        <span class="k">if</span> <span class="n">warn_on_non_costmodel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">CostModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">atypes</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;assigning cost to non CostModel based slot </span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">[</span><span class="n">slot_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span></div>


        <span class="c1">#IDEA: create slot if one doesn&#39;t exist, for dictionaries and assign a ComponentDict+CostModel in wide mode?</span>

<div class="viewcode-block" id="CostModel.custom_cost">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.custom_cost">[docs]</a>
    <span class="k">def</span> <span class="nf">custom_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slot_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">cost</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;CostModel&#39;</span><span class="p">],</span><span class="n">warn_on_non_costmodel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes class costs set, and creates a copy of the class costs, then applies the cost numeric or CostMethod in the same way but only for that instance of&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="nb">type</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;insantiate classes before adding as a cost!&#39;</span>
        <span class="k">assert</span> <span class="n">slot_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;slot </span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1"> doesnt exist&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">dict</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="n">CostModel</span><span class="p">),</span> <span class="s1">&#39;only numeric types or CostModel instances supported&#39;</span>

        <span class="n">atrb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()[</span><span class="n">slot_name</span><span class="p">]</span>
        <span class="n">atypes</span> <span class="o">=</span> <span class="n">atrb</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">accepted</span>
        <span class="k">if</span> <span class="n">warn_on_non_costmodel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">CostModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">atypes</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;assigning cost to non CostModel based slot </span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#convert from classinfo    </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">[</span><span class="n">slot_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_costs</span><span class="p">()</span></div>

    
        <span class="c1">#if the cost is a cost model, and there&#39;s nothing assigned to the slot, assign it</span>
        <span class="c1"># if assign_when_missing and isinstance(cost,CostModel):</span>
        <span class="c1">#     if hasattr(self,slot_name) and getattr(self,slot_name) is None:</span>
        <span class="c1">#         self.info(f&#39;assigning custom cost {slot_name} with {cost}&#39;)</span>
        <span class="c1">#         setattr(self,slot_name,cost)</span>
        <span class="c1">#     elif hasattr(self,slot_name):</span>
        <span class="c1">#         self.warning(f&#39;could not assign custom cost to {slot_name} with {cost}, already assigned to {getattr(self,slot_name)}&#39;)</span>


<div class="viewcode-block" id="CostModel.calculate_item_cost">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.calculate_item_cost">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_item_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override this with a parametric model related to this systems attributes and properties&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_per_item</span></div>

    
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">sub_items_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;calculates the total cost of all sub-items, using the components CostModel if it is provided, and using the declared_cost as a backup&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_costs</span><span class="p">()</span>

    <span class="nd">@cost_property</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">item_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
        <span class="n">calc_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_item_cost</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">calc_item</span><span class="p">])</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">combine_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_costs</span><span class="p">()</span>
    
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">itemized_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sums costs of cost_property&#39;s in this item that are present at term=0&quot;&quot;&quot;</span>
        <span class="n">initial_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_term</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_costs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="p">)</span>
    
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">future_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sums costs of cost_property&#39;s in this item that do not appear at term=0&quot;&quot;&quot;</span>
        <span class="n">initial_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_term</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">initial_costs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<div class="viewcode-block" id="CostModel.sum_costs">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.sum_costs">[docs]</a>
    <span class="k">def</span> <span class="nf">sum_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">saved</span><span class="p">:</span><span class="nb">set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">categories</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">term</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sums costs of cost_property&#39;s in this item that are present at term=0, and by category if define as input&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">saved</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="bp">self</span><span class="p">,))</span> <span class="c1">#item cost included!</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">saved</span><span class="p">:</span>
            <span class="n">saved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">itemcst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_itemized_costs</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span><span class="n">categories</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">csts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_costs</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span><span class="n">categories</span><span class="p">,</span><span class="n">term</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">itemcst</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">csts</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">dict_itemized_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">saved</span><span class="p">:</span><span class="nb">set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">categories</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">term</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">test_val</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="n">ccp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">apply_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="o">==</span><span class="n">test_val</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="n">ccp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">cc</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">])}</span>
        <span class="k">return</span> <span class="n">costs</span>
         
    
<div class="viewcode-block" id="CostModel.sub_costs">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.sub_costs">[docs]</a>
    <span class="k">def</span> <span class="nf">sub_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">saved</span><span class="p">:</span><span class="nb">set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">categories</span><span class="p">:</span><span class="nb">tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">term</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;gets items from CostModel&#39;s defined in a Slot attribute or in a slot default, tolerrant to nan&#39;s in cost definitions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">saved</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">sub_tot</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">():</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slot</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">saved</span><span class="p">:</span>
                <span class="c1">#print(f&#39;skipping {slot}:{comp}&#39;)</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">Configuration</span><span class="p">):</span>
                <span class="n">saved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">sum_costs</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span><span class="n">categories</span><span class="p">,</span><span class="n">term</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1"> adding: </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">identity</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">comp</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">comp</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">sub_tot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">cst</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_tot</span><span class="p">,</span><span class="n">sub</span><span class="p">]</span>
                <span class="n">sub_tot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>

            
            <span class="k">elif</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">)</span> <span class="ow">and</span> <span class="n">term</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1">#Add default costs from direct slots</span>
                <span class="n">dflt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span><span class="n">saved</span><span class="p">)</span>                
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sub: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1"> adding slot: </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">identity</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">comp</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">comp</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slot</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">sub_tot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">cst</span><span class="o">=</span> <span class="p">[</span><span class="n">sub_tot</span><span class="p">,</span><span class="n">sub</span><span class="p">]</span>
                <span class="n">sub_tot</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>

            <span class="c1">#add base class slot values when comp was nonee</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#print(f&#39;skipping {slot}:{comp}&#39;)</span>
                <span class="n">comp_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()[</span><span class="n">slot</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">accepted</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">comp_cls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cc</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">sub</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">saved</span><span class="p">)</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sub: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1"> adding dflt: </span><span class="si">{</span><span class="n">slot</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">sub_tot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">cst</span><span class="o">=</span> <span class="p">[</span><span class="n">sub_tot</span><span class="p">,</span><span class="n">sub</span><span class="p">]</span>
                                <span class="n">sub_tot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>
                            <span class="k">break</span> <span class="c1">#only add once</span>
                    

        <span class="k">return</span> <span class="n">sub_tot</span></div>


    <span class="c1">#Cost Term &amp; Category Reporting</span>
<div class="viewcode-block" id="CostModel.costs_at_term">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.costs_at_term">[docs]</a>
    <span class="k">def</span> <span class="nf">costs_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">term</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">test_val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns a dictionary of all costs at term i, with zero if the mode </span>
<span class="sd">        function returns False at that term&quot;&quot;&quot;</span>
        <span class="n">ccp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">apply_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="o">==</span><span class="n">test_val</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="n">ccp</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>        </div>


<div class="viewcode-block" id="CostModel.class_cost_properties">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.CostModel.html#engforge.eng.costs.CostModel.class_cost_properties">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_cost_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns cost_property objects from this class &amp; subclasses&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">cost_property</span><span class="p">)}</span>     </div>

    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cost_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the current values of the current properties&quot;&quot;&quot;</span>
        <span class="n">ccp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="n">ccp</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cost_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns itemized costs grouped by category&quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="n">cc</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_categories</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span> <span class="nf">cost_categories_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">term</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="n">cc</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_categories</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">apply_at_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">term</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">:</span>
                    <span class="n">base</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    
        <span class="k">return</span> <span class="n">base</span>            

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">COST_CATEGORIES</span></div>


<span class="n">cost_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">CostModel</span><span class="p">,</span><span class="nb">dict</span><span class="p">]</span>
<div class="viewcode-block" id="eval_slot_cost">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.eval_slot_cost.html#engforge.eng.costs.eval_slot_cost">[docs]</a>
<span class="k">def</span> <span class="nf">eval_slot_cost</span><span class="p">(</span><span class="n">slot_item</span><span class="p">:</span><span class="n">cost_type</span><span class="p">,</span><span class="n">saved</span><span class="p">:</span><span class="nb">set</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sub_tot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;evaluating slot: </span><span class="si">{</span><span class="n">slot_item</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_item</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
        <span class="n">sub_tot</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">slot_item</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_item</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
        <span class="n">sub_tot</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">slot_item</span><span class="o">.</span><span class="n">sum_costs</span><span class="p">(</span><span class="n">saved</span><span class="p">),</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_item</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">slot_item</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;slot </span><span class="si">{</span><span class="n">slot_item</span><span class="si">}</span><span class="s1"> has class CostModel, using its `item_cost` only, create an instance to fully model the cost&#39;</span><span class="p">)</span>
        <span class="n">sub_tot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">sub_tot</span><span class="p">,</span><span class="n">slot_item</span><span class="o">.</span><span class="n">cost_per_item</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_item</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">sub_tot</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">slot_item</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">sub_tot</span></div>


<div class="viewcode-block" id="gend">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.gend.html#engforge.eng.costs.gend">[docs]</a>
<span class="k">def</span> <span class="nf">gend</span><span class="p">(</span><span class="n">deect</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">deect</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">gend</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span></div>




    
<span class="n">parent_types</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Component</span><span class="p">,</span><span class="s1">&#39;System&#39;</span><span class="p">]</span>

<span class="c1">#TODO: automatically apply economics at problem level if cost_model present, no need for parent econ lookups</span>
<div class="viewcode-block" id="Economics">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.Economics.html#engforge.eng.costs.Economics">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">Economics</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Economics is a component that summarizes costs and reports the economics of a system and its components in a recursive format&quot;&quot;&quot;</span>

    <span class="n">term_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">discount_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">fixed_output</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span>
    <span class="n">terms_per_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">_calc_output</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_costs</span><span class="p">:</span> <span class="nb">float</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_cost_references</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_cost_categories</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_comp_categories</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_comp_costs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent</span><span class="p">:</span><span class="n">parent_types</span>

    <span class="k">def</span> <span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>        

<div class="viewcode-block" id="Economics.update">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.Economics.html#engforge.eng.costs.Economics.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">:</span><span class="n">parent_types</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;econ updating costs: </span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1">#this is kinda expensive to do every time, but we need to do it to get the costs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gather_cost_references</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_production</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_costs</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no economic output!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_costs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no economic costs!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Economics.calculate_production">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.Economics.html#engforge.eng.costs.Economics.calculate_production">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_production</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;must override this function and set economic_output&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed_output</span><span class="p">])</span></div>


<div class="viewcode-block" id="Economics.calculate_costs">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.Economics.html#engforge.eng.costs.Economics.calculate_costs">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recursively accounts for costs in the parent, its children recursively.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_cost_references</span><span class="p">()</span></div>

    
    <span class="c1">#Reference Utilitly Functions   </span>
    <span class="k">def</span> <span class="nf">sum_cost_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cst</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>        
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;item_cost&#39;</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;add item cost: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    
                <span class="n">cst</span> <span class="o">+=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skip cost: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cst</span>

    <span class="k">def</span> <span class="nf">sum_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">get_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">use_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ref</span><span class="o">.</span><span class="n">key</span>
        <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()[</span><span class="n">ref</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># elif ref.key in ref.comp.system_properties_classdef():</span>
        <span class="c1">#     return ref.comp.system_properties_classdef()[ref.key]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     raise KeyError(f&#39;ref key doesnt exist as property: {ref.key}&#39;)</span>

    <span class="k">def</span> <span class="nf">term_fgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="n">prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">comp</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="k">if</span> <span class="n">term</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">prop</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">apply_at_term</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">term</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">sum_term_fgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref_group</span><span class="p">):</span>
        <span class="n">term_funs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">term_fgen</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span> 
                            <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">ref_group</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">t</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">term_funs</span><span class="p">])</span>        

    <span class="c1">#Gather &amp; Set References (the magic!)</span>
    <span class="c1">#TODO: update internal_references callback to problem</span>
<div class="viewcode-block" id="Economics.internal_references">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.costs.Economics.html#engforge.eng.costs.Economics.internal_references">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">recache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;standard component references are &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_references</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_term_eval_functions</span><span class="p">()</span>
        <span class="c1">#Gather all internal economic variables and report costs</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
        
        <span class="c1">#calculate lifecycle costs</span>
        <span class="n">lc_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifecycle_output</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span><span class="p">:</span>
            <span class="n">props</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">refs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">eval_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_references</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">refs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">eval_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_references</span><span class="p">)</span>    

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">lc_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">lc_out</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">d</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lifecycle_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return lifecycle calculations for lcoe&quot;&quot;&quot;</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">totals</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lifecat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">totals</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annul</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span><span class="n">summary</span><span class="p">,</span><span class="s1">&#39;lifecycle&#39;</span><span class="p">:</span><span class="n">totals</span><span class="p">}</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifecycle_dataframe</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lc</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;category&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">and</span> <span class="s1">&#39;cost&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">lc</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;category.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lifecat</span><span class="p">[</span><span class="n">c_</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">totals</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span>
            <span class="n">annul</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms_per_year</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">term_cost</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">LC</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">levalized_cost</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">LO</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">levalized_output</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;levalized_cost&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">LC</span> <span class="o">/</span> <span class="n">LO</span> <span class="k">if</span> <span class="n">LO</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;levalized_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LO</span> <span class="o">/</span> <span class="n">LC</span> <span class="k">if</span> <span class="n">LC</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span> 

        <span class="n">out2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gend</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_term_output</span> <span class="o">=</span> <span class="n">out2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_term_output</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lifecycle_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulates the economics lifecycle and stores the results in a term based dataframe&quot;&quot;&quot;</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">term_length</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span><span class="n">t</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">t</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">terms_per_year</span><span class="p">}</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">sum_f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_category</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">sum_f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_term_cost_category</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">sum_f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_cost</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;term_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">v</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_cost</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;levalized_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tc</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">discount_rate</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">calculate_production</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;levalized_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">discount_rate</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_create_term_eval_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;uses reference summation grouped by categories &amp; component&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_category</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">vrefs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_category</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_term_fgen</span><span class="p">(</span><span class="n">vrefs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_term_cost_category</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">vrefs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_term_cost_category</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_term_fgen</span><span class="p">(</span><span class="n">vrefs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_cost</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_term_comp_cost</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_fgen</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="p">,</span><span class="n">prop</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">_gather_cost_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">:</span><span class="s1">&#39;System&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;put many tabulation.Ref objects into a dictionary to act as additional references for this economics model.</span>
<span class="sd">        </span>
<span class="sd">        References are found from a walk through the parent slots through all child slots&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span> <span class="o">=</span> <span class="n">CST</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">comp_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1">#reset data </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">conf</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="n">check_config</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1">#skip self</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">bse</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="c1">#prevent duplicates&#39;</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">comp_set</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">Configuration</span><span class="p">):</span>
                <span class="n">comp_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">_base</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">kbase</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_base</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">comp_key</span> <span class="o">=</span> <span class="n">_base</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;checking </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1">#Get Costs Directly From the cost model instance</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                <span class="n">comps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding cost model for </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extract_cost_references</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">bse</span><span class="p">)</span>
                
            <span class="c1">#Look For defaults!</span>
            <span class="c1">#1. try looking for already parsed components (top down)</span>
            <span class="k">elif</span> <span class="n">kbase</span> <span class="ow">and</span> <span class="n">kbase</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="n">kbase</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">CostModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp_key</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding cost for </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">compcanidate</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">[</span><span class="n">comp_key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compcanidate</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dflt child costmodel </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_cost_references</span><span class="p">(</span><span class="n">compcanidate</span><span class="p">,</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;cost.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>                    
                        <span class="n">_key</span><span class="o">=</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;cost.item_cost&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dflt child cost for </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">CST</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">,</span><span class="n">comp_key</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_f</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">)</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;unit&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            
            <span class="c1">#2. try looking at the parent</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">CostModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kbase</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">comp_key</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
                
                <span class="n">compcanidate</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">[</span><span class="n">comp_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compcanidate</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dflt parent cost model for </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_extract_cost_references</span><span class="p">(</span><span class="n">compcanidate</span><span class="p">,</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;cost.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dflt parent cost for </span><span class="si">{</span><span class="n">kbase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">comp_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">_key</span><span class="o">=</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;cost.item_cost&#39;</span>
                    <span class="n">CST</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">,</span><span class="n">comp_key</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_f</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">)</span>
                    <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;unit&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unhandled cost: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span> <span class="o">=</span> <span class="n">CST</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anything_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">CST</span>
    
    <span class="k">def</span> <span class="nf">_extract_cost_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conf</span><span class="p">:</span><span class="s1">&#39;CostModel&#39;</span><span class="p">,</span><span class="n">bse</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="c1">#Add cost fields</span>
        <span class="n">_key</span> <span class="o">=</span> <span class="n">bse</span><span class="o">+</span><span class="s1">&#39;item_cost&#39;</span>
        <span class="n">CST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;extracting costs from </span><span class="si">{</span><span class="n">bse</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">conf</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1">#cost properties of conf item</span>
        <span class="k">for</span> <span class="n">cost_nm</span><span class="p">,</span><span class="n">cost_prop</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">class_cost_properties</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_key</span><span class="o">=</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;cost.&#39;</span><span class="o">+</span><span class="n">cost_nm</span>
            <span class="n">CST</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">cost_nm</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>

            <span class="c1">#If there are categories we&#39;ll add references to later sum them</span>
            <span class="k">if</span> <span class="n">cost_prop</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">cost_prop</span><span class="o">.</span><span class="n">cost_categories</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#we&#39;ll reference it as misc</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;misc&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="n">comps_act</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">internal_components</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="o">.</span><span class="n">identity</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">conf</span><span class="si">}</span><span class="s1"> active components: </span><span class="si">{</span><span class="n">comps_act</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1">#add slot costs with current items (skip class defaults)</span>
        <span class="k">for</span> <span class="n">slot_name</span><span class="p">,</span> <span class="n">slot_value</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#Skip items that are internal components</span>
            <span class="k">if</span> <span class="n">slot_name</span> <span class="ow">in</span> <span class="n">comps_act</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skipping slot </span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding slot </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#Check if current slot isn&#39;t occupied</span>
            <span class="n">cur_slot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">slot_name</span><span class="p">)</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="n">bse</span><span class="o">+</span><span class="n">slot_name</span><span class="o">+</span><span class="s1">&#39;.cost.item_cost&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_slot</span><span class="p">,</span><span class="n">Configuration</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CST</span><span class="p">:</span>
                <span class="n">CST</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">,</span><span class="n">slot_name</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">eval_f</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">)</span>

                <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;unit&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">CST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skipping key </span><span class="si">{</span><span class="n">_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#add base class slot values when comp was none</span>
        <span class="k">for</span> <span class="n">compnm</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">internal_configurations</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">none_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1"> looking up base class costs for </span><span class="si">{</span><span class="n">compnm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">comp_cls</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()[</span><span class="n">compnm</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">accepted</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">comp_cls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1"> looking up base slot cost for </span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cc</span><span class="o">.</span><span class="n">_slot_costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">_key</span><span class="o">=</span><span class="n">bse</span><span class="o">+</span><span class="n">compnm</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;.cost.item_cost&#39;</span>
                                <span class="k">if</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">CST</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1"> skipping dflt key </span><span class="si">{</span><span class="n">_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="c1">#break #skip if already added</span>
                                    <span class="k">continue</span>

                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_extract_cost_references</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">bse</span><span class="o">+</span><span class="n">compnm</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding missing cost for </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">compnm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="n">CST</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_slot_costs</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">eval_f</span> <span class="o">=</span> <span class="n">eval_slot_cost</span><span class="p">)</span>

                                    <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;unit&#39;</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_costs</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cost_categories</span><span class="p">[</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_categories</span><span class="p">[</span><span class="n">bse</span><span class="o">+</span><span class="s1">&#39;category.&#39;</span><span class="o">+</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                                
                            <span class="k">break</span> <span class="c1">#only add once </span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">CostModel</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s1"> using actual costs for </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cost_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_references</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">combine_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_costs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_costs</span>
    
    <span class="nd">@system_property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_output</span></div>


<span class="c1">#TODO: add costs for iterable components (wide/narrow modes)</span>
<span class="c1"># if isinstance(conf,ComponentIter):</span>
<span class="c1">#     conf = conf.current</span>
<span class="c1">#     #if isinstance(conf,CostModel):</span>
<span class="c1">#     #    sub_tot += conf.item_cost</span>
<span class="c1"># if isinstance(conf,ComponentIter):</span>
<span class="c1">#     item = conf.current</span>
<span class="c1">#     if conf.wide:</span>
<span class="c1">#         items = item</span>
<span class="c1">#     else:</span>
<span class="c1">#         items = [items]</span>
<span class="c1"># else:</span>
<span class="c1">#     items = [conf]</span>
<span class="c1">#for conf in items:</span>


<span class="c1"># if isinstance(self,CostModel):</span>
<span class="c1">#     sub_tot += self.item_cost</span>

<span class="c1">#accomodate ComponentIter in wide mode</span>
<span class="c1"># if isinstance(self,ComponentIter):</span>
<span class="c1">#     item = self.current</span>
<span class="c1">#     if self.wide:</span>
<span class="c1">#         items = item</span>
<span class="c1">#     else:</span>
<span class="c1">#         items = [items]</span>
<span class="c1"># else:</span>
<span class="c1">#     items = [self]</span>

<span class="c1">#accomodate ComponentIter in wide mode</span>
<span class="c1">#for item in items:</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>