

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.eng.structure &mdash; engforge 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/readthedocs-custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.eng.structure</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.eng.structure</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">attr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Point</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.tabulation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TABLE_TYPES</span><span class="p">,</span>
    <span class="n">NUMERIC_VALIDATOR</span><span class="p">,</span>
    <span class="n">system_property</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.configuration</span><span class="w"> </span><span class="kn">import</span> <span class="n">forge</span><span class="p">,</span> <span class="n">Configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.components</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>

<span class="c1"># from engforge.analysis import Analysis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">system_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.system</span><span class="w"> </span><span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.component_collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ComponentDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.eng.solid_materials</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.common</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.eng.costs</span><span class="w"> </span><span class="kn">import</span> <span class="n">CostModel</span><span class="p">,</span> <span class="n">cost_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.attr_slots</span><span class="w"> </span><span class="kn">import</span> <span class="n">Slot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.eng.prediction</span><span class="w"> </span><span class="kn">import</span> <span class="n">PredictionMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.problem_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProblemExec</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sectionproperties</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sectionproperties.pre.geometry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">geometry</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sectionproperties.pre.library.primitive_sections</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PyNite</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pynite</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimize</span> <span class="k">as</span> <span class="n">sciopt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">itert</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">svm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Options</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">engforge.eng.structure_beams</span><span class="w"> </span><span class="kn">import</span> <span class="n">Beam</span><span class="p">,</span> <span class="n">rotation_matrix_from_vectors</span>

<span class="n">ray_ok</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>

    <span class="n">ray_ok</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="StructureLog">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.StructureLog.html#engforge.eng.structure.StructureLog">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StructureLog</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">):</span>
    <span class="k">pass</span></div>



<span class="n">log</span> <span class="o">=</span> <span class="n">StructureLog</span><span class="p">()</span>

<span class="n">SECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">issubclass</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">geometry</span><span class="o">.</span><span class="n">Geometry</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">type</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">sections</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
    <span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="StopAnalysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.StopAnalysis.html#engforge.eng.structure.StopAnalysis">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StopAnalysis</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<span class="n">nonetype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span>


<div class="viewcode-block" id="sort_max_estimated_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.sort_max_estimated_failures.html#engforge.eng.structure.sort_max_estimated_failures">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sort_max_estimated_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a generator to iterated through (beam,combo,x) as they return the highest fail_fraction for structures&quot;&quot;&quot;</span>

    <span class="n">failures</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="n">dat</span>
        <span class="k">for</span> <span class="n">beamnm</span><span class="p">,</span> <span class="n">estfail</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">estfail</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span></div>



<div class="viewcode-block" id="check_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.check_failures.html#engforge.eng.structure.check_failures">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check if any failures exist in the nested dictonary and return True if there are&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;mesh_failures&quot;</span> <span class="ow">in</span> <span class="n">failures</span> <span class="ow">and</span> <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;mesh_failures&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s2">&quot;actual&quot;</span> <span class="ow">in</span> <span class="n">failures</span> <span class="ow">and</span> <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">bm</span><span class="p">,</span> <span class="n">cases</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">cases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;fails&quot;</span> <span class="ow">in</span> <span class="n">dat</span> <span class="ow">and</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="check_est_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.check_est_failures.html#engforge.eng.structure.check_est_failures">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_est_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check if any failures exist in the nested dictonary and return True if there are&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">bm</span><span class="p">,</span> <span class="n">cases</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">top</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking est fail </span><span class="si">{</span><span class="n">bm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">check_est_failures</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">cases</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<span class="c1"># Mesh Utils</span>
<div class="viewcode-block" id="quad_stress_tensor">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.quad_stress_tensor.html#engforge.eng.structure.quad_stress_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">quad_stress_tensor</span><span class="p">(</span>
    <span class="n">quad</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">combo</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">,</span> <span class="n">inf_val</span><span class="o">=</span><span class="mf">1e24</span><span class="p">,</span> <span class="n">filter_infeasable</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;determines stresses from a plate or quad&quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">quad</span>
    <span class="n">S_xx</span><span class="p">,</span> <span class="n">S_yy</span><span class="p">,</span> <span class="n">Txy</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">membrane</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>
    <span class="n">Qx</span><span class="p">,</span> <span class="n">Qy</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>

    <span class="n">S_xx</span><span class="p">,</span> <span class="n">S_yy</span><span class="p">,</span> <span class="n">Txy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">S_xx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">S_yy</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Txy</span><span class="p">)</span>

    <span class="n">T_zx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Qx</span><span class="p">)</span> <span class="o">/</span> <span class="n">q</span><span class="o">.</span><span class="n">t</span>
    <span class="n">T_yz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Qy</span><span class="p">)</span> <span class="o">/</span> <span class="n">q</span><span class="o">.</span><span class="n">t</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">S_xx</span><span class="p">,</span> <span class="n">Txy</span><span class="p">,</span> <span class="n">T_zx</span><span class="p">],</span> <span class="p">[</span><span class="n">Txy</span><span class="p">,</span> <span class="n">S_yy</span><span class="p">,</span> <span class="n">T_yz</span><span class="p">],</span> <span class="p">[</span><span class="n">T_zx</span><span class="p">,</span> <span class="n">T_yz</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">filter_infeasable</span><span class="p">:</span>
        <span class="c1"># nan converted to zero</span>
        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># convert infite value to a maximum</span>
        <span class="n">infinx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">infs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">infinx</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="n">infinx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">infs</span><span class="p">)</span> <span class="o">*</span> <span class="n">inf_val</span>

    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="node_pt">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.node_pt.html#engforge.eng.structure.node_pt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_pt</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Z</span><span class="p">])</span></div>



<div class="viewcode-block" id="node_info">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.node_info.html#engforge.eng.structure.node_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_info</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
    <span class="c1"># make point arrays</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">node_pt</span><span class="p">(</span><span class="n">quad</span><span class="o">.</span><span class="n">i_node</span><span class="p">)</span>
    <span class="n">jnd</span> <span class="o">=</span> <span class="n">node_pt</span><span class="p">(</span><span class="n">quad</span><span class="o">.</span><span class="n">j_node</span><span class="p">)</span>
    <span class="n">nnd</span> <span class="o">=</span> <span class="n">node_pt</span><span class="p">(</span><span class="n">quad</span><span class="o">.</span><span class="n">n_node</span><span class="p">)</span>
    <span class="n">mnd</span> <span class="o">=</span> <span class="n">node_pt</span><span class="p">(</span><span class="n">quad</span><span class="o">.</span><span class="n">m_node</span><span class="p">)</span>

    <span class="c1"># area of triangle = 0.5 (V1 x V2)</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">jnd</span> <span class="o">-</span> <span class="n">ind</span><span class="p">,</span> <span class="n">nnd</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">jnd</span> <span class="o">-</span> <span class="n">mnd</span><span class="p">,</span> <span class="n">nnd</span> <span class="o">-</span> <span class="n">mnd</span><span class="p">)</span>

    <span class="c1"># info!</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">norm</span><span class="p">(</span><span class="n">C1</span><span class="p">)</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">C2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">quad</span><span class="o">.</span><span class="n">t</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="n">V</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">density</span>

    <span class="c1"># output</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span>
        <span class="n">cog</span><span class="o">=</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="n">jnd</span> <span class="o">+</span> <span class="n">mnd</span> <span class="o">+</span> <span class="n">mnd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span>
        <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
        <span class="n">cost</span><span class="o">=</span><span class="n">mass</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">cost_per_kg</span><span class="p">,</span>
        <span class="n">allowable_stress</span><span class="o">=</span><span class="n">material</span><span class="o">.</span><span class="n">allowable_stress</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="calculate_von_mises_stress">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.calculate_von_mises_stress.html#engforge.eng.structure.calculate_von_mises_stress">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_von_mises_stress</span><span class="p">(</span><span class="n">stress_tensor</span><span class="p">):</span>
    <span class="n">e_val</span><span class="p">,</span> <span class="n">e_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">stress_tensor</span><span class="p">)</span>
    <span class="n">p3</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">e_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.707</span> <span class="o">*</span> <span class="p">((</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span></div>



<div class="viewcode-block" id="calculate_quad_vonmises">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.calculate_quad_vonmises.html#engforge.eng.structure.calculate_quad_vonmises">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_quad_vonmises</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;looks at 9 points over a quad to determine its von mises stresses</span>
<span class="sd">    :returns: a dictinary of&quot;&quot;&quot;</span>
    <span class="n">qvm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itert</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">quad_stress_tensor</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>
        <span class="n">qvm</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">calculate_von_mises_stress</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qvm</span></div>



<div class="viewcode-block" id="BeamDict">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.BeamDict.html#engforge.eng.structure.BeamDict">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BeamDict</span><span class="p">(</span><span class="n">ComponentDict</span><span class="p">):</span>
    <span class="n">component_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">Beam</span><span class="p">)</span></div>



<span class="c1"># TODO: Make analysis, where each load case is a row, but how sytactically?</span>
<div class="viewcode-block" id="Structure">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Structure</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">CostModel</span><span class="p">,</span> <span class="n">PredictionMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A integration between sectionproperties and PyNite, with a focus on ease of use</span>

<span class="sd">    Right now we just need an integration between Sections+Materials and Members, to find, CG, and inertial components</span>

<span class="sd">    Possible Future Additions:</span>
<span class="sd">    1) Structure Motion (free body ie vehicle , multi-strucutre ie robots)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pynite.FEModel3D</span>

    <span class="c1"># _beams: dict = None</span>
    <span class="n">_materials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">default_material</span><span class="p">:</span> <span class="n">SolidMaterial</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">solve_method</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;pdelta&quot;</span><span class="p">)</span>

    <span class="c1"># Default Loading!</span>
    <span class="n">add_gravity_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gravity_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;FZ&quot;</span><span class="p">)</span>
    <span class="n">gravity_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">9.81</span><span class="p">)</span>
    <span class="n">gravity_scalar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gravity_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">)</span>
    <span class="n">gravity_cases</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gravity&quot;</span><span class="p">])</span>
    <span class="n">default_case</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">)</span>
    <span class="n">default_combo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">)</span>

    <span class="c1"># this orchestrates load retrieval</span>
    <span class="n">check_statics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">current_combo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">)</span>
    <span class="c1"># iteration combos iterates over LoadCombos by default</span>
    <span class="n">iteration_combos</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># merge_duplicate_nodes by default</span>
    <span class="n">merge_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

    <span class="c1"># beams</span>
    <span class="n">beams</span> <span class="o">=</span> <span class="n">Slot</span><span class="o">.</span><span class="n">define_iterator</span><span class="p">(</span><span class="n">BeamDict</span><span class="p">,</span> <span class="n">wide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># per execute failure analysis</span>
    <span class="c1"># calculate actual failure will estimate then run failure analysis for bad cases</span>
    <span class="c1"># calculate full failure will run failure analysis without stoping at first failure</span>
    <span class="n">calculate_actual_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">calculate_full_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">failure_solve_method</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="s2">&quot;bisect&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
    <span class="n">failure_records</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># prediciton calculation</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">max_records</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">_prediction_parms</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">min_rec</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">near_margin</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">max_margin</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">max_guess</span> <span class="o">=</span> <span class="mf">1e8</span>

    <span class="n">current_failure_summary</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_always_save_data</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># we dont respond to inputs so use this</span>
    <span class="n">_meshes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_any_solved</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__on_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_combo_failure_analysis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meshes</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initalize_structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_load_combo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_combo</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_name</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span> <span class="s2">&quot;gravity&quot;</span>
        <span class="p">)</span>

        <span class="c1"># turn on prediction of failures with these models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;fails&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;fail_frac&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s2">&quot;beam_fail_frac&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s2">&quot;mesh_fail_frac&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_models</span> <span class="o">=</span> <span class="n">d</span>

        <span class="c1"># finally create the structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_structure</span><span class="p">()</span>

<div class="viewcode-block" id="Structure.create_structure">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.create_structure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use this method to create a structure on init.</span>

<span class="sd">        # Example code for creating a structure</span>
<span class="sd">        frame = Structure()</span>
<span class="sd">        frame.add_material(&quot;default_material&quot;, 2E9, 8E8, 0.3, 7850)</span>

<span class="sd">        # Add nodes</span>
<span class="sd">        node1 = frame.add_node(&quot;Node1&quot;, 0, 0, 0)</span>
<span class="sd">        node2 = frame.add_node(&quot;Node2&quot;, 0, 0, 10)</span>

<span class="sd">        # Add elements</span>
<span class="sd">        element = frame.add_member(&quot;Element1&quot;, &quot;Node1&quot;, &quot;Node2&quot;, &quot;default_material&quot;)</span>

<span class="sd">        # Add supports</span>
<span class="sd">        frame.def_support(&quot;Node1&quot;, True, True, True, True, True, True)</span>
<span class="sd">        frame.def_support(&quot;Node2&quot;, True, True, True, True, True, True)</span>

<span class="sd">        # Add loads</span>
<span class="sd">        self.add_node_load(&quot;Node2&quot;, &quot;FZ&quot;, -100)</span>

<span class="sd">        # Solve the structure</span>
<span class="sd">        self.run() #calls execute!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="c1"># Execution</span>
<div class="viewcode-block" id="Structure.execute">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combos</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;wrapper allowing saving of data by load combo&quot;&quot;&quot;</span>

        <span class="c1"># the string input case, with csv support</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combos</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">combos</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>  <span class="c1"># will be a list!</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running with combos: </span><span class="si">{</span><span class="n">combos</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">iteration_combos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combos</span>
        <span class="k">if</span> <span class="n">iteration_combos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iteration_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">iteration_combos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">combos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">combo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">with</span> <span class="n">ProblemExec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{})</span> <span class="k">as</span> <span class="n">px</span><span class="p">:</span>
                <span class="c1"># reset cached failures</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_combo_failure_analysis</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># run the analysis</span>
                <span class="c1"># self.index += 1</span>
                <span class="n">combo_possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_pre_execute</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>  <span class="c1"># can change combo</span>
                <span class="k">if</span> <span class="n">combo_possible</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span> <span class="o">=</span> <span class="n">combo_possible</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span> <span class="o">=</span> <span class="n">combo</span>
                <span class="n">combo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;running load combo : </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2"> with solver </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solve_method</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;check_statics&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;check_statics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_statics</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_method</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">analyze_linear</span><span class="p">(</span><span class="n">load_combos</span><span class="o">=</span><span class="p">[</span><span class="n">combo</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">load_combos</span><span class="o">=</span><span class="p">[</span><span class="n">combo</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_method</span> <span class="o">==</span> <span class="s2">&quot;pdelta&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">analyze_PDelta</span><span class="p">(</span><span class="n">load_combos</span><span class="o">=</span><span class="p">[</span><span class="n">combo</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_any_solved</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag system properties to save</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_post_execute</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>

                <span class="c1"># backup data saver.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_failures</span><span class="p">()</span>  <span class="c1"># cache failures</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_anything_changed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># change costs</span>

                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="c1"># self.save_data(index=self.index, force=True)</span>
                    <span class="n">px</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>

                <span class="c1"># record results for prediction</span>
                <span class="k">if</span> <span class="n">record</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_record</span>
                    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


    <span class="c1"># Solver Mechanics</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">struct_root_failure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">fail_parm</span><span class="p">,</span>
        <span class="n">base_kw</span><span class="p">,</span>
        <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;target must be positive&quot;</span>
        <span class="n">bkw</span> <span class="o">=</span> <span class="n">base_kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bkw</span><span class="p">[</span><span class="n">fail_parm</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">mult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setattrs</span><span class="p">(</span><span class="n">bkw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;solving root iter: </span><span class="si">{</span><span class="n">bkw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding args to solver: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">wrong_side</span> <span class="o">=</span> <span class="p">(</span><span class="n">mult</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_est_fail_frac</span>
        <span class="n">bf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_beam_est_fail_frac</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_mesh_est_fail_frac</span>
        <span class="k">if</span> <span class="n">wrong_side</span><span class="p">:</span>
            <span class="c1"># min = 1 with an gradual but exponential value from 0</span>
            <span class="n">l10</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ff</span><span class="p">),</span> <span class="n">l10</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="n">exp</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">ff</span>

        <span class="k">if</span> <span class="n">sols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sols</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ff&quot;</span><span class="p">:</span> <span class="n">ff</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;kw&quot;</span><span class="p">:</span> <span class="n">bkw</span><span class="p">,</span> <span class="s2">&quot;mf&quot;</span><span class="p">:</span> <span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;bf&quot;</span><span class="p">:</span> <span class="n">bf</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ran: </span><span class="si">{</span><span class="n">bkw</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">ff</span><span class="si">:</span><span class="s2">5.4f</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">res</span><span class="si">:</span><span class="s2">5.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">determine_failure_load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fail_parm</span><span class="p">,</span>
        <span class="n">base_kw</span><span class="p">,</span>
        <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">target_failure_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span>
        <span class="n">return_sol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># TODO: add reversion logic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_max_parm_dict&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">guess</span> <span class="o">=</span> <span class="n">mult</span> <span class="o">*</span> <span class="mf">1e6</span>
                    <span class="k">if</span> <span class="n">fail_parm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span><span class="p">[</span><span class="n">fail_parm</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_guess</span>
                        <span class="n">maxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_guess</span> <span class="o">*</span> <span class="n">mult</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span><span class="p">[</span><span class="n">fail_parm</span><span class="p">]</span>
                        <span class="n">maxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_guess</span> <span class="o">*</span> <span class="n">mult</span>

                <span class="n">solutions</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># allow passing of args to solver</span>
                <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kw</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding args to solver: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">argsolv</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_root_failure</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">argsolv</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_solve_method</span> <span class="o">==</span> <span class="s2">&quot;bisect&quot;</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span>
                        <span class="n">func</span><span class="p">,</span>
                        <span class="n">x0</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">x1</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                        <span class="n">rtol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                        <span class="n">xtol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">fail_parm</span><span class="p">,</span>
                            <span class="n">base_kw</span><span class="p">,</span>
                            <span class="n">mult</span><span class="p">,</span>
                            <span class="n">target_failure_frac</span><span class="p">,</span>
                            <span class="n">solutions</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">bracket</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mult</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">fail_parm</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}</span><span class="s2">| success: </span><span class="si">{</span><span class="n">ans</span><span class="o">.</span><span class="n">converged</span><span class="si">}</span><span class="s2"> , ans:</span><span class="si">{</span><span class="n">ans</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">, base: </span><span class="si">{</span><span class="n">base_kw</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1"># root</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span>
                        <span class="n">func</span><span class="p">,</span>
                        <span class="n">x0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">x1</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                        <span class="n">rtol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                        <span class="n">xtol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">fail_parm</span><span class="p">,</span>
                            <span class="n">base_kw</span><span class="p">,</span>
                            <span class="n">mult</span><span class="p">,</span>
                            <span class="n">target_failure_frac</span><span class="p">,</span>
                            <span class="n">solutions</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mult</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">fail_parm</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}</span><span class="s2">| success: </span><span class="si">{</span><span class="n">ans</span><span class="o">.</span><span class="n">converged</span><span class="si">}</span><span class="s2"> , ans:</span><span class="si">{</span><span class="n">ans</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">, base: </span><span class="si">{</span><span class="n">base_kw</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">return_sol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">solutions</span>

                <span class="k">if</span> <span class="n">ans</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setattrs</span><span class="p">({</span><span class="n">fail_parm</span><span class="p">:</span> <span class="n">ans</span><span class="o">.</span><span class="n">root</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;save&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">ans</span><span class="o">.</span><span class="n">root</span>

                <span class="k">elif</span> <span class="n">solutions</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solutions</span><span class="p">])</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;ff&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solutions</span><span class="p">])</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;bf&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solutions</span><span class="p">])</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;mf&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solutions</span><span class="p">])</span>
                    <span class="k">return</span>  <span class="c1"># TODO: fit the best solution using regression</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># increase margin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;increasing </span><span class="si">{</span><span class="n">fail_parm</span><span class="si">}</span><span class="s2"> max guess by 100x&quot;</span><span class="p">)</span>
                <span class="n">new_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span><span class="p">[</span><span class="n">fail_parm</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_parm_dict</span><span class="p">[</span><span class="n">fail_parm</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_max</span>
                <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_X_prediction_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_parms</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">base_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_parms</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prediction_record</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the analysis result for prediction&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_prediction_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_est_fail_frac</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;beam_fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_beam_est_fail_frac</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;mesh_fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_mesh_est_fail_frac</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ff</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Structure.record_result">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.record_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stress_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;determines if stress record should be added to prediction_records&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_records</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">ff</span> <span class="o">=</span> <span class="n">stress_dict</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span>

        <span class="c1"># Add the data to the stress records</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">near_margin</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">near_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_prediction_record</span><span class="p">(</span><span class="n">stress_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_margin</span> <span class="ow">and</span> <span class="n">ff</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_margin</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_prediction_record</span><span class="p">(</span><span class="n">stress_dict</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">near_margin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_prediction_record</span><span class="p">(</span><span class="n">stress_dict</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_solved</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="c1"># self._any_solved = False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nothing to save, run() structure first&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Structure.struct_pre_execute">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.struct_pre_execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">struct_pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;yours to override to prep solver or dataframe</span>
<span class="sd">        :returns: combo to run, or None if want to continue with current iteration combos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Structure.struct_post_execute">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.struct_post_execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">struct_post_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;yours to override dataframe&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">initalize_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">pynite</span><span class="o">.</span><span class="n">FEModel3D</span><span class="p">()</span>
        <span class="c1"># self.beams = {}  # this is for us!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created frame...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">:</span>
            <span class="n">material</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add material </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span>
                    <span class="n">uid</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">rho</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>

    <span class="c1"># Merged Feature Calls</span>
<div class="viewcode-block" id="Structure.add_eng_material">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.add_eng_material">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_eng_material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">:</span> <span class="s2">&quot;SolidMaterial&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;adds the material to the structure and returns the pynite id&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span>
                <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span>
                <span class="n">material</span><span class="o">.</span><span class="n">E</span><span class="p">,</span>
                <span class="n">material</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="n">material</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span>
                <span class="n">material</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">material</span><span class="o">.</span><span class="n">unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>

        <span class="k">return</span> <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">mesh_extents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">mesh_extents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mn</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meshes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">minZ</span><span class="p">,</span> <span class="n">maxZ</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nn</span><span class="si">}</span><span class="s2">_node&quot;</span><span class="p">)</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Z</span>
                    <span class="k">if</span> <span class="n">minX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">X</span> <span class="o">&lt;</span> <span class="n">minX</span><span class="p">:</span>
                        <span class="n">minX</span> <span class="o">=</span> <span class="n">X</span>
                    <span class="k">if</span> <span class="n">maxX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">maxX</span><span class="p">:</span>
                        <span class="n">maxX</span> <span class="o">=</span> <span class="n">X</span>
                    <span class="k">if</span> <span class="n">minY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Y</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="p">:</span>
                        <span class="n">minY</span> <span class="o">=</span> <span class="n">Y</span>
                    <span class="k">if</span> <span class="n">maxY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Y</span> <span class="o">&gt;</span> <span class="n">maxY</span><span class="p">:</span>
                        <span class="n">maxY</span> <span class="o">=</span> <span class="n">Y</span>
                    <span class="k">if</span> <span class="n">minZ</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Z</span> <span class="o">&lt;</span> <span class="n">minZ</span><span class="p">:</span>
                        <span class="n">minZ</span> <span class="o">=</span> <span class="n">Z</span>
                    <span class="k">if</span> <span class="n">maxZ</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Z</span> <span class="o">&gt;</span> <span class="n">maxZ</span><span class="p">:</span>
                        <span class="n">maxZ</span> <span class="o">=</span> <span class="n">Z</span>
            <span class="n">mesh_extents</span><span class="p">[</span><span class="n">mn</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">minX</span><span class="o">=</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="o">=</span><span class="n">maxX</span><span class="p">,</span> <span class="n">minY</span><span class="o">=</span><span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="o">=</span><span class="n">maxY</span><span class="p">,</span> <span class="n">minZ</span><span class="o">=</span><span class="n">minZ</span><span class="p">,</span> <span class="n">maxZ</span><span class="o">=</span><span class="n">maxZ</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">mesh_extents</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">quad_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return a dictonary of quads with their mass properties like cog, mass, area and volume&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_quad_info&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_quad_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meshes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">qn</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">material_name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_quad_info</span><span class="p">[</span><span class="n">qn</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_info</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<div class="viewcode-block" id="Structure.add_mesh">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.add_mesh">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;maps to appropriate PyNite mesh generator but also applies loads</span>

<span class="sd">        Currently these types are supported [&#39;rect&#39;,&#39;annulus&#39;,&#39;cylinder&#39;,&#39;triangle&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rect&quot;</span><span class="p">,</span> <span class="s2">&quot;annulus&quot;</span><span class="p">,</span> <span class="s2">&quot;cylinder&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">meshtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;type </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">meshtype</span> <span class="o">==</span> <span class="s2">&quot;rect&quot;</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_rectangle_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meshtype</span> <span class="o">==</span> <span class="s2">&quot;annulus&quot;</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_annulus_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meshtype</span> <span class="o">==</span> <span class="s2">&quot;cylinder&quot;</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cylinder_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meshtype</span> <span class="o">==</span> <span class="s2">&quot;triangle&quot;</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_frustrum_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meshtype</span> <span class="o">==</span> <span class="s2">&quot;cylinderset&quot;</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_mesh_cylinders</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;no mesh made!&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Meshes</span><span class="p">[</span><span class="n">mesh</span><span class="p">])</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshname</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meshes</span><span class="p">[</span><span class="n">meshname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>

        <span class="c1"># Ensure custom mesh is in frame meshes</span>
        <span class="k">if</span> <span class="n">meshname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Meshes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Meshes</span><span class="p">[</span><span class="n">meshname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_duplicate_nodes</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_gravity_force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_gravity_to_mesh</span><span class="p">(</span><span class="n">meshname</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_gravity_to_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying gravity to </span><span class="si">{</span><span class="n">meshname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meshes</span><span class="p">[</span><span class="n">meshname</span><span class="p">]</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">material_name</span><span class="p">]</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">rho</span>

        <span class="k">for</span> <span class="n">elid</span><span class="p">,</span> <span class="n">elmt</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># make node vectors</span>
            <span class="n">n_vecs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">nname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i_node&quot;</span><span class="p">,</span> <span class="s2">&quot;j_node&quot;</span><span class="p">,</span> <span class="s2">&quot;m_node&quot;</span><span class="p">,</span> <span class="s2">&quot;n_node&quot;</span><span class="p">]:</span>
                <span class="n">ni</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elmt</span><span class="p">,</span> <span class="n">nname</span><span class="p">)</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">nname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>
                <span class="n">n_vecs</span><span class="p">[</span><span class="n">nname</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ni</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ni</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">ni</span><span class="o">.</span><span class="n">Z</span><span class="p">])</span>

            <span class="n">ni</span> <span class="o">=</span> <span class="n">n_vecs</span><span class="p">[</span><span class="s2">&quot;i_node&quot;</span><span class="p">]</span>
            <span class="n">nj</span> <span class="o">=</span> <span class="n">n_vecs</span><span class="p">[</span><span class="s2">&quot;j_node&quot;</span><span class="p">]</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">n_vecs</span><span class="p">[</span><span class="s2">&quot;m_node&quot;</span><span class="p">]</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">n_vecs</span><span class="p">[</span><span class="s2">&quot;n_node&quot;</span><span class="p">]</span>

            <span class="c1"># find element area</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ni</span> <span class="o">-</span> <span class="n">nm</span>
            <span class="n">jn</span> <span class="o">=</span> <span class="n">nj</span> <span class="o">-</span> <span class="n">nn</span>

            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">jn</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># get gravity_forcemultiply area x thickness x density/4</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">elmt</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">rho</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gravity_mag</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gravity_scalar</span>
            <span class="n">fnode</span> <span class="o">=</span> <span class="n">fg</span> <span class="o">/</span> <span class="mi">4</span>

            <span class="c1"># apply forces to corner nodes / 4</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gravity_cases</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nname</span><span class="p">,</span> <span class="n">disnode</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_node_load</span><span class="p">(</span>
                        <span class="n">disnode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gravity_dir</span><span class="p">,</span>
                        <span class="n">fnode</span><span class="p">,</span>
                        <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_name</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>
        <span class="k">assert</span> <span class="n">node2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>

        <span class="k">if</span> <span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">:</span>
            <span class="n">material</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;material&quot;</span><span class="p">):</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">material</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;material not defined as input or from default sources!&quot;</span><span class="p">)</span>

        <span class="n">uid</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add material </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span>
                <span class="n">uid</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">rho</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>

        <span class="n">beam_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Beam</span><span class="o">.</span><span class="n">input_attrs</span><span class="p">()}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">beam_attrs</span><span class="p">}</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span>
            <span class="o">**</span><span class="n">beam_attrs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_member</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">i_node</span><span class="o">=</span><span class="n">node1</span><span class="p">,</span>
            <span class="n">j_node</span><span class="o">=</span><span class="n">node2</span><span class="p">,</span>
            <span class="n">material_name</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
            <span class="n">Iy</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">Iy</span><span class="p">,</span>
            <span class="n">Iz</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">Ix</span><span class="p">,</span>
            <span class="n">J</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
            <span class="n">A</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">A</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_gravity_force</span><span class="p">:</span>
            <span class="n">beam</span><span class="o">.</span><span class="n">apply_gravity_force</span><span class="p">(</span><span class="n">z_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_dir</span><span class="p">,</span> <span class="n">z_mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_scalar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">beam</span>

<div class="viewcode-block" id="Structure.add_member_with">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.add_member_with">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_member_with</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">Iy</span><span class="p">,</span> <span class="n">Ix</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">material_rho</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a way to add specific beam properties to calculate stress,</span>
<span class="sd">        This way will currently not caluclate resulatant beam load.</span>
<span class="sd">        #TOOD: Add in a mock section_properties for our own stress calcs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">node1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>
        <span class="k">assert</span> <span class="n">node2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>

        <span class="n">material</span> <span class="o">=</span> <span class="n">SolidMaterial</span><span class="p">(</span>
            <span class="n">density</span><span class="o">=</span><span class="n">material_rho</span><span class="p">,</span> <span class="n">elastic_modulus</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">shear_modulus</span><span class="o">=</span><span class="n">G</span>
        <span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">unique_id</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add material </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span>
                <span class="n">uid</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">rho</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">material_name</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">in_Iy</span><span class="o">=</span><span class="n">Iy</span><span class="p">,</span>
            <span class="n">in_Ix</span><span class="o">=</span><span class="n">Ix</span><span class="p">,</span>
            <span class="n">in_J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span>
            <span class="n">in_A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span>
            <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_gravity_force</span><span class="p">:</span>
            <span class="n">beam</span><span class="o">.</span><span class="n">apply_gravity_force</span><span class="p">(</span><span class="n">z_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_dir</span><span class="p">,</span> <span class="n">z_mag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity_scalar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">add_member</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">i_node</span><span class="o">=</span><span class="n">node1</span><span class="p">,</span>
            <span class="n">j_node</span><span class="o">=</span><span class="n">node2</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
            <span class="n">Iy</span><span class="o">=</span><span class="n">Iy</span><span class="p">,</span>
            <span class="n">Iz</span><span class="o">=</span><span class="n">Ix</span><span class="p">,</span>
            <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span>
            <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">beam</span></div>


    <span class="c1"># OUTPUT</span>

<div class="viewcode-block" id="Structure.beam_dataframe">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.beam_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">beam_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">univ_parms</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_columns</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates a dataframe entry for each beam and combo</span>
<span class="sd">        :param univ_parms: keys represent the dataframe parm, and the values represent the lookup value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span>

        <span class="c1"># determine the possible beam names</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;beams_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">])</span>
        <span class="n">beam_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;beams_&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">beam_parms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">beam_cols</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">beams</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">univ_parms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">univ_parms</span> <span class="o">=</span> <span class="n">beam_parms</span>  <span class="c1"># do not filter parms</span>

        <span class="k">if</span> <span class="n">add_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># loop through parms and beams reorganizing the data:</span>
        <span class="c1"># TODO: look up potential multi-index or pivot method for pandas</span>
        <span class="n">beam_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">add_dat</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">add_columns</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="n">add_dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># this is the data entry</span>
                <span class="n">bc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>
                <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">beam_parms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">univ_parms</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># if parm not in row:</span>
                    <span class="c1"># continue</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parm</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="c1"># if &#39;Z1&#39; in k:</span>
                        <span class="c1"># print(v)</span>
                        <span class="n">bc</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="n">beam_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>  <span class="c1"># uno mas</span>

        <span class="n">dfb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">beam_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfb</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">XM_beam</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">bm</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">bm</span><span class="o">.</span><span class="n">centroid3d</span> <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">XM_quad</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="s2">&quot;cog&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">XM</span> <span class="o">=</span> <span class="n">XM_beam</span> <span class="o">+</span> <span class="n">XM_quad</span>
        <span class="k">return</span> <span class="n">XM</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sum of all beams and quad masses&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

<div class="viewcode-block" id="Structure.masses">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.masses">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">masses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return a dictionary of beam &amp; quad mass&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;beams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">beamname</span><span class="p">,</span> <span class="n">bm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">beams</span><span class="p">[</span><span class="n">beamname</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">for</span> <span class="n">quadname</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">quads</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure_cost_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sum of all beams and quad cost&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;beams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure_cost_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sum of all panels cost&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;quads&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>

    <span class="nd">@cost_property</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="s2">&quot;mfg,material,panels&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">panels_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_cost_panels</span>

    <span class="nd">@cost_property</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="s2">&quot;mfg,material,beams&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">beam_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sum of all beams cost&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">bm</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="nd">@system_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">structure_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sum of all beams and quad cost&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_cost_beams</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_cost_panels</span>

    <span class="nd">@solver_cached</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return a dictionary of beam &amp; quad costs&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;beams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">beamname</span><span class="p">,</span> <span class="n">bm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">beams</span><span class="p">[</span><span class="n">beamname</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">cost</span>
        <span class="k">for</span> <span class="n">quadname</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">quads</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visulize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PyNite</span><span class="w"> </span><span class="kn">import</span> <span class="n">Visualization</span>

        <span class="k">if</span> <span class="s2">&quot;combo_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;combo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_combo</span>
        <span class="n">Visualization</span><span class="o">.</span><span class="n">render_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># TODO: add mesh stress / deflection info min/max ect.</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># out = {}</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LoadCombos</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">case</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">DX</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;dx&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">DX</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;dy&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">DY</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;dz&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">DZ</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RX</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RY</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RZ</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxfx&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnFX</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxfy&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnFY</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxfz&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnFZ</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxmx&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnMX</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxmy&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnMY</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                    <span class="s2">&quot;rxmz&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">RxnMZ</span><span class="p">[</span><span class="n">case</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="c1"># out[case] = pandas.DataFrame(rows)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;case&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">INERTIA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combines all the mass moments of inerita from the internal beams (and other future items!) into one for the sturcture with the parallel axis theorm&quot;&quot;&quot;</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cog</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> inertia...&quot;</span><span class="p">)</span>
            <span class="n">I</span> <span class="o">+=</span> <span class="n">beam</span><span class="o">.</span><span class="n">GLOBAL_INERTIA</span>

        <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">qcog</span> <span class="o">=</span> <span class="n">quad</span><span class="p">[</span><span class="s2">&quot;cog&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span>
            <span class="n">qmass</span> <span class="o">=</span> <span class="n">quad</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>

            <span class="n">qI</span> <span class="o">=</span> <span class="n">qmass</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">qcog</span> <span class="o">*</span> <span class="n">qcog</span><span class="o">.</span><span class="n">T</span>
            <span class="n">I</span> <span class="o">+=</span> <span class="n">qI</span>

        <span class="k">return</span> <span class="n">I</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Fg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;force of gravity&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">g</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c1"># log.info(f&#39;get {attr}&#39;)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="c1"># if attr in dir(self):</span>
        <span class="c1"># return getattr(self,attr)</span>
        <span class="c1"># raise AttributeError(f&#39;{attr} not found!&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="nb">dir</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Structure</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Structure</span><span class="p">)</span>
                <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Nodes</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">members</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Members</span>

    <span class="c1"># Remote Utility Calls (pynite frame integration)</span>
<div class="viewcode-block" id="Structure.merge_displacement_results">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.merge_displacement_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_displacement_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;adds a remotely calculated displacement vector and applies to nodes ala pynite convention&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">_D</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DX</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DY</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DZ</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RX</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RY</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RZ</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Structure.prep_remote_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.prep_remote_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_remote_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;copies PyNite analysis pre-functions&quot;&quot;&quot;</span>
        <span class="c1"># Generate all meshes</span>
        <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Meshes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">is_generated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>

        <span class="c1"># Activate all springs and members for all load combinations</span>
        <span class="k">for</span> <span class="n">spring</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Springs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">combo_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">spring</span><span class="o">.</span><span class="n">active</span><span class="p">[</span><span class="n">combo_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Activate all physical members for all load combinations</span>
        <span class="k">for</span> <span class="n">phys_member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">Members</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">combo_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">phys_member</span><span class="o">.</span><span class="n">active</span><span class="p">[</span><span class="n">combo_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Assign an internal ID to all nodes and elements in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_renumber</span><span class="p">()</span>

        <span class="c1"># Get the auxiliary list used to determine how the matrices will be partitioned</span>
        <span class="n">D1_indices</span><span class="p">,</span> <span class="n">D2_indices</span><span class="p">,</span> <span class="n">D2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_list</span><span class="p">()</span></div>


    <span class="c1"># Failure Analysis Interface (Override your for your cases!)</span>
<div class="viewcode-block" id="Structure.failure_load_combos">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.failure_load_combos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">failure_load_combos</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">report_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">run_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remote_sync</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns or yields a set of load combo names to check failure for.</span>
<span class="sd">        You&#39;re encouraged to override this for your specific cases</span>
<span class="sd">        :param report_info: the report that is generated in `run_failure_analysis` which will dynamically change with</span>
<span class="sd">        :yields: the combo name</span>
<span class="sd">        :returns: None when done</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">report_info</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span>

        <span class="c1"># gravity case first</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_combo</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">report_info</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># you are weak</span>

        <span class="n">iteration_combos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combos</span>
        <span class="k">if</span> <span class="n">iteration_combos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iteration_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">combo_name</span><span class="p">,</span> <span class="n">combo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">combo_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iteration_combos</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">combo_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_combo</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">combo_name</span>

                <span class="c1"># allow time for combo to run</span>
                <span class="k">if</span> <span class="n">remote_sync</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">remote_sync</span><span class="o">.</span><span class="n">ensure</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">combo_name</span><span class="p">)</span>
                    <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">d</span><span class="p">])</span>  <span class="c1"># ,timeout=remote_timeout)</span>

                <span class="n">cfail</span> <span class="o">=</span> <span class="n">failures</span><span class="p">[</span><span class="n">combo_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">check_failures</span><span class="p">(</span><span class="n">cfail</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                        <span class="k">return</span>  <span class="c1"># you are no good</span></div>


<div class="viewcode-block" id="Structure.failure_load_exithandler">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.failure_load_exithandler">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">failure_load_exithandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">report_info</span><span class="p">,</span> <span class="n">run_full</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a callback that is passed the structural combo, the case results</span>

<span class="sd">        Override this function to provide custom exit capability</span>
<span class="sd">        :param combo: the load combo analyzed</span>
<span class="sd">        :param res: the combo failure results</span>
<span class="sd">        :param report_info: the report dictionary</span>
<span class="sd">        :run_full: option to run everything</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_failures</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;combo </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2"> failed!&quot;</span><span class="p">)</span>
            <span class="n">report_info</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StopAnalysis</span><span class="p">()</span></div>


<div class="viewcode-block" id="Structure.run_failure_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.run_failure_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_failure_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">run_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Failure Determination:</span>
<span class="sd">        Beam Stress Estiates are used to determine if a 2D FEA beam/combo analysis should be run. The maximum beam vonmises stress is compared the the beam material allowable stress / saftey factor.</span>

<span class="sd">        Override:</span>
<span class="sd">        Depending on number of load cases, this analysis could take a while. Its encouraged to use a similar pattern of check and exit to reduce load combo size in an effort to fail early. Override this function if nessicary.</span>

<span class="sd">        Case / Beam Ordering:</span>
<span class="sd">        runs the gravity case first and checks for failure to exit early,</span>
<span class="sd">        then all other combos are run</span>
<span class="sd">        :returns: a dictionary with 2D fea failures and estimated failures as well for each beam</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fails&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>  <span class="c1"># innocent till proven guilty</span>
        <span class="n">report</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run the rest of the load cases</span>
            <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_load_combos</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># failure_load_combos returns none on exit</span>
                <span class="k">if</span> <span class="n">combo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">report</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">combo</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>
                <span class="n">fail_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_combo_failure_analysis</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">)</span>
                <span class="n">failures</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail_res</span>
                <span class="c1"># will call</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_load_exithandler</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">fail_res</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">run_full</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">report</span>

        <span class="k">except</span> <span class="n">StopAnalysis</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">report</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;issue in failur analysis&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">report</span>  <span class="c1"># tada!</span></div>


    <span class="c1"># Custom Failure Analysis Tools</span>
<div class="viewcode-block" id="Structure.check_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.check_failures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;exposes check_failures&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">check_failures</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.check_est_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.check_est_failures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_est_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;exposes check_est_failures&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">check_est_failures</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return all failure estimates for all combos&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimated_failures_report</span><span class="p">()</span>

<div class="viewcode-block" id="Structure.check_mesh_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.check_mesh_failures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_mesh_failures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">return_complete</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the von-mises stress / allowable (failure fraction) stresses for each quad in each mesh.</span>
<span class="sd">        :param run_full: if false will exit early on first failure</span>
<span class="sd">        :returns: a dictinary of quad names and their failure fraction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking mesh failure </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">stable</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;failures&quot;</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span> <span class="s2">&quot;stable&quot;</span><span class="p">:</span> <span class="n">stable</span><span class="p">}</span>

        <span class="n">quad_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span>
        <span class="k">for</span> <span class="n">meshname</span><span class="p">,</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meshes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">matid</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">material_name</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span><span class="p">[</span><span class="n">matid</span><span class="p">]</span>
            <span class="n">allowable</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">allowable_stress</span>
            <span class="k">for</span> <span class="n">quadname</span><span class="p">,</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itert</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="n">quad_stress_tensor</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>
                    <span class="n">vm</span> <span class="o">=</span> <span class="n">calculate_von_mises_stress</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
                    <span class="n">fail_frac</span> <span class="o">=</span> <span class="n">vm</span> <span class="o">/</span> <span class="n">allowable</span>
                    <span class="k">if</span> <span class="n">vm</span> <span class="o">*</span> <span class="n">SF</span> <span class="o">&gt;</span> <span class="n">allowable</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">quadname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">:</span>
                            <span class="n">failures</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail_frac</span>
                        <span class="k">elif</span> <span class="n">fail_frac</span> <span class="o">&gt;</span> <span class="n">failures</span><span class="p">[</span><span class="n">quadname</span><span class="p">]:</span>
                            <span class="n">failures</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail_frac</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">return_complete</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">summary</span>
                            <span class="k">return</span> <span class="n">failures</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">quadname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stable</span><span class="p">:</span>
                            <span class="n">stable</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail_frac</span>
                        <span class="k">elif</span> <span class="n">fail_frac</span> <span class="o">&gt;</span> <span class="n">stable</span><span class="p">[</span><span class="n">quadname</span><span class="p">]:</span>
                            <span class="n">stable</span><span class="p">[</span><span class="n">quadname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail_frac</span>

        <span class="k">if</span> <span class="n">return_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">summary</span>
        <span class="k">return</span> <span class="n">failures</span></div>


<div class="viewcode-block" id="Structure.mesh_stress_dataframe">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.mesh_stress_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mesh_stress_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns a dataframe of each quad, its x,y,z coords, vonmises stress and other mass/cost properties in a dataframe&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">combo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">combo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span>
        <span class="n">max_vm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">qn</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Quads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">qvm</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itert</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">S</span> <span class="o">=</span> <span class="n">quad_stress_tensor</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>
                <span class="n">qvm</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">calculate_von_mises_stress</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">max_vm</span><span class="p">[</span><span class="n">qn</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qvm</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">mesh_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">qn</span><span class="p">,</span> <span class="n">maxvm</span> <span class="ow">in</span> <span class="n">max_vm</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">qinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="p">[</span><span class="n">qn</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cog&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">mesh_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span> <span class="s2">&quot;vm&quot;</span><span class="p">:</span> <span class="n">maxvm</span><span class="p">,</span> <span class="o">**</span><span class="n">qinfo</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mesh_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Structure.estimated_failures_report">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.estimated_failures_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimated_failures_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">concentrationFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">methodFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">fail_frac_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">combos</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;uses the beam estimated stresses with specific adders to account for beam 2D stress concentrations and general inaccuracy as well as a fail_fraction to analyze. The estimated loads are very pessimistic with a 250x overestimate&quot;&quot;&quot;</span>

        <span class="c1"># the string input case, with csv support</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combos</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">combos</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>  <span class="c1"># will be a list!</span>

        <span class="c1"># what fraction of allowable stress is generated for this case</span>
        <span class="k">if</span> <span class="n">fail_frac_criteria</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fail_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fail_1</span> <span class="o">=</span> <span class="n">fail_frac_criteria</span> <span class="o">/</span> <span class="p">(</span><span class="n">concentrationFactor</span> <span class="o">*</span> <span class="n">methodFactor</span><span class="p">)</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c1"># df = self.dataframe</span>
        <span class="n">run_combos</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">current_combo</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">failures_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">iteration_combos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combos</span>
        <span class="k">if</span> <span class="n">iteration_combos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iteration_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LoadCombos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># gather forces for each beam</span>
        <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;estimate beam stress: </span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># try each load combo</span>
            <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">iteration_combos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">combo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">run_combos</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># theres, no point</span>

                <span class="k">if</span> <span class="n">combos</span> <span class="ow">and</span> <span class="n">combo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># you are not the chose one(s)</span>

                <span class="c1"># MUST Loop over beams pos and combos to get the correct data for general case of all combos</span>
                <span class="c1"># combo_df = df[df.current_combo == combo]</span>
                <span class="c1"># combo_dict = combo_df.to_dict(&quot;records&quot;)</span>
                <span class="c1"># combo_dict = combo_dict[-1]  # last one is the combo in the case of repeats</span>
                <span class="c1"># loop positions start,mid,end</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>
                    <span class="n">cases</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">get_forces_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">combo</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>
                    <span class="n">beam_fail_frac</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">estimate_stress</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">f</span><span class="p">,</span> <span class="n">force_calc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span>
                    <span class="p">)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">beam_fail_frac</span> <span class="o">*</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">allowable_stress</span>

                    <span class="n">fails</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">fail_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">deltadf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beam_fail_frac</span><span class="p">)</span>
                        <span class="n">fails</span> <span class="o">=</span> <span class="n">deltadf</span> <span class="o">&lt;=</span> <span class="n">beam</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">fail_frac_criteria</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">beam_fail_frac</span> <span class="o">&gt;=</span> <span class="n">fail_1</span><span class="p">:</span>
                        <span class="n">fails</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># record!</span>
                    <span class="k">if</span> <span class="n">fails</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;estimated beam </span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failure at L=</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">% | </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">failures_count</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">failures</span><span class="p">[</span><span class="n">nm</span><span class="p">][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                            <span class="s2">&quot;est_stress&quot;</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                            <span class="s2">&quot;combo&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">,</span>
                            <span class="c1"># &quot;x&quot;: x,</span>
                            <span class="s2">&quot;allowable_stress&quot;</span><span class="p">:</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">allowable_stress</span><span class="p">,</span>
                            <span class="s2">&quot;fail_frac&quot;</span><span class="p">:</span> <span class="n">beam_fail_frac</span><span class="p">,</span>
                            <span class="s2">&quot;loads&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
                        <span class="p">}</span>

                        <span class="c1"># failures[nm][(combo, x)].update(</span>
                        <span class="c1">#     **{</span>
                        <span class="c1">#         k.split(nm + &quot;.&quot;)[-1] if nm in k else k: v</span>
                        <span class="c1">#         for k, v in combo_dict.items()</span>
                        <span class="c1">#         if (&quot;beams&quot; not in k or nm in k) and k not in _d</span>
                        <span class="c1">#     }</span>
                        <span class="c1"># )</span>

        <span class="k">if</span> <span class="n">failures_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combos</span><span class="si">}</span><span class="s2">| </span><span class="si">{</span><span class="n">failures_count</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">failures_count</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">cases</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">% estimated failures: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">failures</span></div>


<div class="viewcode-block" id="Structure.current_failures">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.current_failures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_failures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">concentrationFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">methodFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">fail_frac_criteria</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;uses the beam estimated stresses with specific adders to account for beam 2D stress concentrations and general inaccuracy as well as a fail_fraction to analyze. The estimated loads are very pessimistic with a 250x overestimate by default for beams. mesh stresses are more accurate and failure is determined by fail_fac (von-mises stress / allowable stress)/fail_frac_criteria&quot;&quot;&quot;</span>

        <span class="c1"># what fraction of allowable stress is generated for this case</span>
        <span class="c1"># what fraction of allowable stress is generated for this case</span>

        <span class="n">fail_1</span> <span class="o">=</span> <span class="n">fail_frac_criteria</span> <span class="o">/</span> <span class="p">(</span><span class="n">concentrationFactor</span> <span class="o">*</span> <span class="n">methodFactor</span><span class="p">)</span>

        <span class="c1"># FIXME: only run current combo (remove combo storage)</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">stable</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;beam_failures&quot;</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span> <span class="s2">&quot;beams_stable&quot;</span><span class="p">:</span> <span class="n">stable</span><span class="p">}</span>

        <span class="n">failures_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>

        <span class="n">combo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;determining failures for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># self._lock_est_failures = True</span>
        <span class="c1"># data_dict = self.data_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock_est_failures</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># gather forces for each beam</span>
        <span class="k">for</span> <span class="n">nm</span><span class="p">,</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;estimate beam stress: </span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">checks</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">beam_fail_frac</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">fail_factor_estimate</span>

            <span class="n">fails</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">beam_fail_frac</span> <span class="o">&gt;=</span> <span class="n">fail_1</span><span class="p">:</span>
                <span class="n">fails</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">fails</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;estimated beam </span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failure&quot;</span><span class="p">)</span>
                <span class="n">failures_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">failures</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                    <span class="c1"># &quot;est_stress&quot;: st,</span>
                    <span class="s2">&quot;combo&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">,</span>
                    <span class="c1"># &quot;x&quot;: x,</span>
                    <span class="c1"># &quot;allowable_stress&quot;: beam.material.allowable_stress,</span>
                    <span class="s2">&quot;fail_frac&quot;</span><span class="p">:</span> <span class="n">beam_fail_frac</span><span class="p">,</span>
                    <span class="s2">&quot;fail_critera&quot;</span><span class="p">:</span> <span class="n">fail_frac_criteria</span><span class="p">,</span>
                    <span class="c1"># &quot;loads&quot;: f,</span>
                <span class="p">}</span>

                <span class="c1"># failures[nm][combo].update(</span>
                <span class="c1">#     **{</span>
                <span class="c1">#         k.split(nm + &quot;.&quot;)[-1] if nm in k else k: v</span>
                <span class="c1">#         for k, v in data_dict.items()</span>
                <span class="c1">#         if (&quot;beams&quot; not in k or nm in k) and k not in _d</span>
                <span class="c1">#     }</span>
                <span class="c1"># )</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stable</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                    <span class="c1"># &quot;est_stress&quot;: st,</span>
                    <span class="s2">&quot;combo&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">,</span>
                    <span class="c1"># &quot;x&quot;: x,</span>
                    <span class="c1"># &quot;allowable_stress&quot;: beam.material.allowable_stress,</span>
                    <span class="s2">&quot;fail_frac&quot;</span><span class="p">:</span> <span class="n">beam_fail_frac</span><span class="p">,</span>
                    <span class="s2">&quot;fail_critera&quot;</span><span class="p">:</span> <span class="n">fail_frac_criteria</span><span class="p">,</span>
                    <span class="c1"># &quot;loads&quot;: f,</span>
                <span class="p">}</span>

        <span class="c1"># add mesh failures</span>
        <span class="n">mesh_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mesh_failures</span><span class="p">(</span>
            <span class="n">combo</span><span class="p">,</span>
            <span class="n">run_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_full_failure</span><span class="p">,</span>
            <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">return_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mesh_failures</span> <span class="o">=</span> <span class="n">mesh_summary</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span>
        <span class="n">mesh_success</span> <span class="o">=</span> <span class="n">mesh_summary</span><span class="p">[</span><span class="s2">&quot;stable&quot;</span><span class="p">]</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;mesh_failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_failures</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;mesh_stable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_success</span>

        <span class="c1"># update failures</span>
        <span class="n">mesh_failures_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh_failures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">])</span>

        <span class="n">max_fail_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="n">v</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">beam</span><span class="p">,</span> <span class="n">fails</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fails</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">max_stable_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="n">v</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">beam</span><span class="p">,</span> <span class="n">stables</span> <span class="ow">in</span> <span class="n">stable</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">max_mesh_fail_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh_failures</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">max_mesh_stable_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh_success</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="c1"># Max mesh failure fracs</span>
        <span class="n">max_beam_fail_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_fail_frac</span><span class="p">,</span> <span class="n">max_stable_frac</span><span class="p">)</span>
        <span class="n">max_mesh_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_mesh_fail_frac</span><span class="p">,</span> <span class="n">max_mesh_stable_frac</span><span class="p">)</span>
        <span class="n">max_fail_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_beam_fail_frac</span><span class="p">,</span> <span class="n">max_mesh_frac</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">failures_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">| </span><span class="si">{</span><span class="n">failures_count</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">failures_count</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">checks</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">% estimated failures: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;mesh_fail_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_failures_count</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;beam_fail_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures_count</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;failures_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures_count</span> <span class="o">+</span> <span class="n">mesh_failures_count</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;beams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beams</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;meshs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_failures</span><span class="p">)</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checks</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_info</span><span class="p">)</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;max_mesh_fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_mesh_frac</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;max_beam_fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_beam_fail_frac</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;max_fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_fail_frac</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span> <span class="o">=</span> <span class="n">summary</span>

        <span class="k">return</span> <span class="n">summary</span></div>


    <span class="c1"># Failure Analysis Properties</span>
    <span class="c1"># FIXME: needs a complete rethink as far as caching and reporting properties, consider removing or replacing</span>
    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_est_fail_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;estimated failure fraction for the current result&quot;&quot;&quot;</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;max_fail_frac&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get estimated beam failure frac&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_beam_est_fail_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;max_beam_fail_frac&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get estimated beam failure frac&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_mesh_est_fail_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;max_mesh_fail_frac&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get estimated failure frac&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimated_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;failures_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;could not get estimated failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimated_beam_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;beam_fail_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get estimated beam failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimated_mesh_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;mesh_fail_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get estimated mesh failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actual_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">afc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">afc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">afc</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get actual failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">afc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actual_beam_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">afc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">afc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">afc</span><span class="p">[</span><span class="s2">&quot;beam_failures_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get actual beam failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">afc</span>

    <span class="c1"># @system_property</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actual_mesh_failure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">afc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_failures</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">afc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">afc</span><span class="p">[</span><span class="s2">&quot;mesh_failure_count&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not get actual mesh failure count&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">afc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_current_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lock_est_failures&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_est_failures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;current failures locked&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failures</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span>
        <span class="k">return</span> <span class="n">fc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_actual_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lock_est_failures&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_est_failures</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_combo_failure_analysis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failures</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_failure_summary</span>
            <span class="n">afc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_combo_failure_analysis</span><span class="p">(</span>
                <span class="n">combo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span><span class="p">,</span>
                <span class="n">run_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_full_failure</span><span class="p">,</span>
                <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_full_failure</span><span class="p">,</span>
                <span class="n">failures</span><span class="o">=</span><span class="n">fc</span><span class="p">[</span><span class="s2">&quot;beam_failures&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">afc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_combo_failure_analysis</span>
        <span class="k">return</span> <span class="n">afc</span>

<div class="viewcode-block" id="Structure.run_combo_failure_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.run_combo_failure_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_combo_failure_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">combo</span><span class="p">,</span>
        <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">run_section_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">failures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;runs a single load combo and adds 2d section failures&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;determine combo </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2"> failures...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">failures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimated_failures_report</span><span class="p">(</span><span class="n">combos</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_section_failure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_section_failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_failure_sections</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">failures</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">combo</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_combo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_combo_failure_analysis</span> <span class="o">=</span> <span class="n">out</span>

        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;beam_failures_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mesh_failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_fail</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mesh_failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mesh_failures</span><span class="p">(</span>
            <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span>
        <span class="p">)</span>
        <span class="c1"># perform 2d analysis if any estimated</span>
        <span class="k">if</span> <span class="n">mesh_failures</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_actual_failure</span> <span class="ow">and</span> <span class="n">check_est_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;testing actual failures...&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfail</span> <span class="o">=</span> <span class="n">run_section_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">act_fails</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">x</span><span class="p">:</span> <span class="n">f</span>
                <span class="k">for</span> <span class="n">beam</span><span class="p">,</span> <span class="n">cfail</span> <span class="ow">in</span> <span class="n">dfail</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cfail</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;beam_failures_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">act_fails</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mesh_failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_failures</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">act_fails</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_failures</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dfail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found actual failure...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no estimated failures found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Structure.run_failure_sections">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.Structure.html#engforge.eng.structure.Structure.run_failure_sections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_failure_sections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;takes estimated failures and runs 2D section FEA on those cases&quot;&quot;&quot;</span>
        <span class="n">secton_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># random beam analysis</span>
        <span class="c1"># for beamnm,est_fail_cases in failpairs:</span>
        <span class="n">failed_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">failed_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">sort_max_estimated_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">combo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;running beam sections: </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="si">}</span><span class="s1">%&#39;</span>
            <span class="p">)</span>
            <span class="n">beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span>

            <span class="c1"># prepare for output</span>
            <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secton_results</span><span class="p">:</span>
                <span class="n">secton_results</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;loads&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">get_stress_with_forces</span><span class="p">(</span><span class="o">**</span><span class="n">f</span><span class="p">)</span>

            <span class="n">secton_results</span><span class="p">[</span><span class="n">beamnm</span><span class="p">][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">d_</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;combo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combo</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beamnm</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sss</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_stress</span><span class="p">()</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_vm_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sss</span><span class="p">])</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">allowable_stress</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sss</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span> <span class="o">=</span> <span class="n">ff</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">SF</span>

            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">failed_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
                <span class="n">failed_pos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">secton_results</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                    <span class="k">break</span>  <span class="c1"># next beam!</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> ok @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">failed_beams</span> <span class="ow">or</span> <span class="n">failed_pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fail_count</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2"> across </span><span class="si">{</span><span class="n">failed_beams</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">3.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">failed_pos</span><span class="p">]</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">secton_results</span></div>
</div>



<span class="c1"># TODO: make a multiprocessing version of section failure analysis using shared memory or something</span>


<span class="c1"># Remote Sync Util (locally run with section)</span>
<div class="viewcode-block" id="run_combo_failure_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.run_combo_failure_analysis.html#engforge.eng.structure.run_combo_failure_analysis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_combo_failure_analysis</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;runs a single load combo and adds 2d section failures&quot;&quot;&quot;</span>
    <span class="n">inst</span><span class="o">.</span><span class="n">resetSystemLogs</span><span class="p">()</span>
    <span class="c1"># use parallel failure section</span>
    <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">run_combo_failure_analysis</span><span class="p">(</span>
        <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">,</span> <span class="n">run_section_failure</span><span class="o">=</span><span class="n">run_failure_sections</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="run_failure_sections">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.run_failure_sections.html#engforge.eng.structure.run_failure_sections">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_failure_sections</span><span class="p">(</span>
    <span class="n">struct</span><span class="p">,</span>
    <span class="n">failures</span><span class="p">,</span>
    <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">group_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;takes estimated failures and runs 2D section FEA on those cases&quot;&quot;&quot;</span>

    <span class="n">struct</span><span class="o">.</span><span class="n">resetSystemLogs</span><span class="p">()</span>

    <span class="n">secton_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">skip_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="s2">&quot;_putbeam&quot;</span><span class="p">):</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">_putbeam</span> <span class="o">=</span> <span class="n">put_beams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">put_beams</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">_putbeam</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">sort_max_estimated_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;run remote beam sections: </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="si">}</span><span class="s1">%&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">in</span> <span class="n">skip_beams</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># prep for output</span>
        <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secton_results</span><span class="p">:</span>
            <span class="n">secton_results</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">beams</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span>

        <span class="n">forces</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">get_forces_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

        <span class="c1"># lazy beam puts</span>
        <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">put_beams</span><span class="p">:</span>
            <span class="n">beam_ref</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">_section_properties</span><span class="p">)</span>
            <span class="n">put_beams</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beam_ref</span> <span class="o">=</span> <span class="n">put_beams</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span>

        <span class="n">cur</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">remote_section</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                <span class="n">beam_ref</span><span class="p">,</span>
                <span class="n">beam</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">forces</span><span class="p">,</span>
                <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">allowable_stress</span><span class="p">,</span>
                <span class="n">c</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">SF</span><span class="o">=</span><span class="n">SF</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># run the damn thing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">group_size</span><span class="p">:</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;waiting on </span><span class="si">{</span><span class="n">group_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span>
                <span class="n">beamnm</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>
                <span class="n">combo</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;combo&quot;</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
                <span class="n">secton_results</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span>

                <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">secton_results</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                        <span class="n">skip_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> ok @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done waiting, continue...&quot;</span><span class="p">)</span>

    <span class="c1"># finish them!</span>
    <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;waiting on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done, continue...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
            <span class="n">fail</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span>
            <span class="n">beamnm</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>
            <span class="n">combo</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;combo&quot;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
            <span class="n">secton_results</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span>

            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">secton_results</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                    <span class="n">skip_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> ok @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">secton_results</span></div>



<span class="c1"># Remote Analysis</span>
<div class="viewcode-block" id="parallel_run_failure_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.parallel_run_failure_analysis.html#engforge.eng.structure.parallel_run_failure_analysis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parallel_run_failure_analysis</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">run_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Failure Determination:</span>
<span class="sd">    Beam Stress Estiates are used to determine if a 2D FEA beam/combo analysis should be run. The maximum beam vonmises stress is compared the the beam material allowable stress / saftey factor.</span>

<span class="sd">    Override:</span>
<span class="sd">    Depending on number of load cases, this analysis could take a while. Its encouraged to use a similar pattern of check and exit to reduce load combo size in an effort to fail early. Override this function if nessicary.</span>

<span class="sd">    Case / Beam Ordering:</span>
<span class="sd">    runs the gravity case first and checks for failure to exit early,</span>
<span class="sd">    then all other combos are run</span>
<span class="sd">    :returns: a dictionary with 2D fea failures and esimated failures as well for each beam</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">report</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fails&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>  <span class="c1"># innocent till proven guilty</span>
    <span class="n">report</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run the rest of the load cases</span>
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">failure_load_combos</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="c1"># TODO: handle running list of combos to do simultanious running</span>

            <span class="c1"># run and store data</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">combos</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>
            <span class="c1"># struct_ref = ray.put(struct)</span>

            <span class="c1"># check failures</span>
            <span class="n">fail</span> <span class="o">=</span> <span class="n">run_combo_failure_analysis</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">)</span>

            <span class="n">failures</span><span class="p">[</span><span class="n">combo</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">failure_load_exithandler</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">run_full</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
                <span class="n">purge_combo</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">report</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;issue in failur analysis&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">report</span>  <span class="c1"># tada!</span></div>



<div class="viewcode-block" id="purge_combo">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.purge_combo.html#engforge.eng.structure.purge_combo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">purge_combo</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">combo</span><span class="p">):</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">_D</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">node</span><span class="o">.</span><span class="n">DX</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">DY</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">DZ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">RX</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">RY</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">RZ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>



<span class="k">if</span> <span class="n">ray_ok</span><span class="p">:</span>
    <span class="c1"># Remote Capabilities</span>
    <span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">max_calls</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remote_run_combo</span><span class="p">(</span><span class="n">ref_structure</span><span class="p">,</span> <span class="n">combo</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">StructureLog</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sync_ref</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;actor_ref&quot;</span><span class="p">]</span>
            <span class="n">struct_ref</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;struct_ref&quot;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">ref_structure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struct_ref</span><span class="p">)</span>
            <span class="c1"># sync = ray.get(sync_ref)</span>
            <span class="n">sync</span> <span class="o">=</span> <span class="n">sync_ref</span>
            <span class="c1"># try:</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">resetSystemLogs</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start combo </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># log.info(struct.logger.__dict__)</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">combos</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;combo done </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># assert len(struct.table) == 1, &#39;bad! sync only at beginning and end&#39;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">,</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">struct</span><span class="o">.</span><span class="n">_D</span><span class="p">[</span><span class="n">combo</span><span class="p">],</span>
                <span class="s2">&quot;combo&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">,</span>
                <span class="s2">&quot;st_id&quot;</span><span class="p">:</span> <span class="n">struct</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;putting results for </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">put_combo</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">d</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;issue with remote run&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">retry_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remote_section</span><span class="p">(</span>
        <span class="n">beamsection</span><span class="p">,</span>
        <span class="n">beamname</span><span class="p">,</span>
        <span class="n">forces</span><span class="p">,</span>
        <span class="n">allowable_stress</span><span class="p">,</span>
        <span class="n">combo</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">return_section</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;optimized method to run 2d fea and return a failure determination&quot;&quot;&quot;</span>
        <span class="c1"># TODO: allow post processing ops</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">beamsection</span><span class="o">.</span><span class="n">calculate_stress</span><span class="p">(</span><span class="o">**</span><span class="n">forces</span><span class="p">)</span>

        <span class="n">sss</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_stress</span><span class="p">()</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loads&quot;</span><span class="p">:</span> <span class="n">forces</span><span class="p">,</span> <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="n">beamname</span><span class="p">,</span> <span class="s2">&quot;combo&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">return_section</span><span class="p">:</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sss</span>
        <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;stress_vm_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sss</span><span class="p">])</span>
        <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">allowable_stress</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sss</span><span class="p">])</span>
        <span class="n">d_</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span> <span class="o">=</span> <span class="n">ff</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">SF</span>

        <span class="k">return</span> <span class="n">d_</span>

    <span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parallel_combo_run</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">ref_structure</span><span class="p">,</span> <span class="n">run_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">SF</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># run and store data</span>
        <span class="c1"># self.struct.run(combos=combo)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">StructureLog</span><span class="p">()</span>

        <span class="n">sync</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;actor_ref&quot;</span><span class="p">]</span>
        <span class="n">struct_ref</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;struct_ref&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running structure </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">remote_run_combo</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">ref_structure</span><span class="p">,</span> <span class="n">combo</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;waiting on combo </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">d</span><span class="p">])</span>

        <span class="c1"># check failures</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failure analysis </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="n">remote_combo_failure_analysis</span><span class="p">(</span><span class="n">ref_structure</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">put_failure</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">run_full</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failure analysis done </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># @ray.remote</span>
    <span class="c1"># class RemoteStructuralAnalysis:</span>
    <span class="c1">#     &quot;&quot;&quot;represents a stateful object in a ray cloud contetxt&quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     def __init__(self, structure, *kw):</span>
    <span class="c1">#         self.struct = structure</span>
    <span class="c1">#         self.struct.resetSystemLogs()</span>
    <span class="c1">#         self.struct.prep_remote_analysis()</span>
    <span class="c1">#</span>
    <span class="c1">#         # reference tracking</span>
    <span class="c1">#         self.combos_run = {}</span>
    <span class="c1">#         self.failed = False</span>
    <span class="c1">#         self.report = {&quot;fails&quot;: self.failed}</span>
    <span class="c1">#         self.report[&quot;failures&quot;] = failures = {}</span>
    <span class="c1">#         self.failures = failures</span>
    <span class="c1">#         self.put_beams = {}</span>
    <span class="c1">#</span>
    <span class="c1">#         # can run all combos from base</span>
    <span class="c1">#         self.struct_ref = ray.put(self.struct)</span>
    <span class="c1">#</span>
    <span class="c1">#         # put beams sections for quick analysis</span>
    <span class="c1">#         for beamnm, beam in self.struct.beams.items():</span>
    <span class="c1">#             beam_ref = ray.put(beam._section_properties)</span>
    <span class="c1">#             self.put_beams[beamnm] = beam_ref</span>
    <span class="c1">#</span>
    <span class="c1">#     def get(self, run_id=None):</span>
    <span class="c1">#         self.struct.info(f&quot;getting {len(self.table)}&quot;)</span>
    <span class="c1">#         if run_id is None:</span>
    <span class="c1">#             return self.struct._table</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             return [v for v in self.table if v[&quot;st_id&quot;] == run_id]</span>
    <span class="c1">#</span>
    <span class="c1">#     def put_combo(self, inv):</span>
    <span class="c1">#         &quot;&quot;&quot;add the data from remotely running the load combo&quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#         self.struct.info(f&quot;adding {len(self.struct.table)+1}&quot;)</span>
    <span class="c1">#         self.struct._table[len(self.struct.table) + 1] = inv[&quot;row&quot;]</span>
    <span class="c1">#         self.struct.merge_displacement_results(inv[&quot;combo&quot;], inv[&quot;D&quot;])</span>
    <span class="c1">#         self.combos_run[inv[&quot;combo&quot;]] = inv</span>
    <span class="c1">#         self.struct.info(f&#39;finished analysis of {inv[&quot;combo&quot;]}&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     def put_failure(self, combo, fail, run_full=False):</span>
    <span class="c1">#         self.struct.info(f&quot;finished failure calc of {combo}&quot;)</span>
    <span class="c1">#         self.failures[combo] = fail</span>
    <span class="c1">#         self.struct.failure_load_exithandler(combo, fail, self.report, run_full)</span>
    <span class="c1">#</span>
    <span class="c1">#     async def wait_and_get_failure(self, combo, wait=1, timeout=None):</span>
    <span class="c1">#         if combo in self.failures:</span>
    <span class="c1">#             return self.failures[combo]</span>
    <span class="c1">#</span>
    <span class="c1">#         timeelapsed = 0</span>
    <span class="c1">#</span>
    <span class="c1">#         # wait loop</span>
    <span class="c1">#         while combo not in self.failures:</span>
    <span class="c1">#             self.struct.info(f&quot;waiting on {combo}&quot;)</span>
    <span class="c1">#             if timeout is not None and timeelapsed &gt; timeout:</span>
    <span class="c1">#                 raise TimeoutError(f&quot;combo {combo} not found within timeout&quot;)</span>
    <span class="c1">#             await asyncio.sleep(wait)</span>
    <span class="c1">#             timeelapsed += wait</span>
    <span class="c1">#</span>
    <span class="c1">#         return self.failures[combo]</span>
    <span class="c1">#</span>
    <span class="c1">#     def get_beam_forces(self, beam_name, combo, x):</span>
    <span class="c1">#         beam = self.struct.beams[beam_name]</span>
    <span class="c1">#         return beam.get_forces_at(x, combo)</span>
    <span class="c1">#</span>
    <span class="c1">#     def get_beam_info(self, beam_name):</span>
    <span class="c1">#         r = self.put_beams[beam_name]</span>
    <span class="c1">#         beam = self.struct.beams[beam_name]</span>
    <span class="c1">#         out = {&quot;ref&quot;: r, &quot;allowable&quot;: beam.material.allowable_stress}</span>
    <span class="c1">#         return out</span>
    <span class="c1">#</span>
    <span class="c1">#     def estimated_failures(self, combos):</span>
    <span class="c1">#         return self.struct.estimated_failures_report(combos=combos)</span>
    <span class="c1">#</span>
    <span class="c1">#     def return_structure(self):</span>
    <span class="c1">#         return self.struct</span>
    <span class="c1">#</span>
    <span class="c1">#     async def ensure(self, combo, wait=1, timeout=None):</span>
    <span class="c1">#         if combo in self.combos_run:</span>
    <span class="c1">#             return  # good to go</span>
    <span class="c1">#</span>
    <span class="c1">#         timeelapsed = 0</span>
    <span class="c1">#</span>
    <span class="c1">#         # wait loop</span>
    <span class="c1">#         while combo not in self.combos_run:</span>
    <span class="c1">#             self.struct.info(f&quot;waiting on {combo}&quot;)</span>
    <span class="c1">#             if timeout is not None and timeelapsed &gt; timeout:</span>
    <span class="c1">#                 raise TimeoutError(f&quot;combo {combo} not found within timeout&quot;)</span>
    <span class="c1">#             await asyncio.sleep(wait)</span>
    <span class="c1">#             timeelapsed += wait</span>
    <span class="c1">#</span>
    <span class="c1">#         return  # good to go</span>
    <span class="c1">#</span>
    <span class="c1">#     def run_failure_analysis(self, SF=1.0, run_full=False, **kw):</span>
    <span class="c1">#         &quot;&quot;&quot;</span>
    <span class="c1">#         Failure Determination:</span>
    <span class="c1">#         Beam Stress Estiates are used to determine if a 2D FEA beam/combo analysis should be run. The maximum beam vonmises stress is compared the the beam material allowable stress / saftey factor.</span>
    <span class="c1">#</span>
    <span class="c1">#         Override:</span>
    <span class="c1">#         Depending on number of load cases, this analysis could take a while. Its encouraged to use a similar pattern of check and exit to reduce load combo size in an effort to fail early. Override this function if nessicary.</span>
    <span class="c1">#</span>
    <span class="c1">#         Case / Beam Ordering:</span>
    <span class="c1">#         runs the gravity case first and checks for failure to exit early,</span>
    <span class="c1">#         then all other combos are run</span>
    <span class="c1">#         :returns: a dictionary with 2D fea failures and esimated failures as well for each beam</span>
    <span class="c1">#         &quot;&quot;&quot;</span>
    <span class="c1">#         ctx = ray.get_runtime_context()</span>
    <span class="c1">#         actor_handle = ctx.current_actor</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             cases = []</span>
    <span class="c1">#             ref = {&quot;struct_ref&quot;: self.struct_ref, &quot;actor_ref&quot;: actor_handle}</span>
    <span class="c1">#             # Run the rest of the load cases</span>
    <span class="c1">#             for combo in self.struct.failure_load_combos(</span>
    <span class="c1">#                 self.report, run_full, remote_sync=actor_handle, **kw</span>
    <span class="c1">#             ):</span>
    <span class="c1">#                 d = parallel_combo_run.remote(</span>
    <span class="c1">#                     combo, ref, run_full=run_full, SF=SF</span>
    <span class="c1">#                 )</span>
    <span class="c1">#                 cases.append(d)</span>
    <span class="c1">#</span>
    <span class="c1">#             for coro in asyncio.as_completed(cases):</span>
    <span class="c1">#                 if self.failed and not run_full:</span>
    <span class="c1">#                     self.struct.warning(f&quot;structure failed!&quot;)</span>
    <span class="c1">#                     return self.report</span>
    <span class="c1">#</span>
    <span class="c1">#         except KeyboardInterrupt:</span>
    <span class="c1">#             return self.report</span>
    <span class="c1">#</span>
    <span class="c1">#         except Exception as e:</span>
    <span class="c1">#             self.struct.error(e, &quot;issue in failur analysis&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#         return self.report  # tada!</span>

    <span class="c1"># Remote Sync Util</span>
<div class="viewcode-block" id="remote_combo_failure_analysis">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.remote_combo_failure_analysis.html#engforge.eng.structure.remote_combo_failure_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remote_combo_failure_analysis</span><span class="p">(</span>
        <span class="n">ref_structure</span><span class="p">,</span> <span class="n">combo</span><span class="p">,</span> <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;runs a single load combo and adds 2d section failures&quot;&quot;&quot;</span>

        <span class="n">sync</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;actor_ref&quot;</span><span class="p">]</span>
        <span class="n">struct_ref</span> <span class="o">=</span> <span class="n">ref_structure</span><span class="p">[</span><span class="s2">&quot;struct_ref&quot;</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">StructureLog</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;determine combo </span><span class="si">{</span><span class="n">combo</span><span class="si">}</span><span class="s2"> failures...&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">estimated_failures_report</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">combos</span><span class="o">=</span><span class="n">combo</span><span class="p">)</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failures</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_fail</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># perform 2d analysis if any estimated</span>
        <span class="k">if</span> <span class="n">check_est_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;testing estimated failures...&quot;</span><span class="p">)</span>

            <span class="n">dfail</span> <span class="o">=</span> <span class="n">remote_failure_sections</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">run_full</span><span class="p">,</span> <span class="n">SF</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfail</span>

            <span class="k">if</span> <span class="n">dfail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found actual failure...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no estimated failures found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="remote_failure_sections">
<a class="viewcode-back" href="../../../_autosummary/engforge.eng.structure.remote_failure_sections.html#engforge.eng.structure.remote_failure_sections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remote_failure_sections</span><span class="p">(</span>
        <span class="n">sync</span><span class="p">,</span>
        <span class="n">failures</span><span class="p">,</span>
        <span class="n">run_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">SF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">group_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;takes estimated failures and runs 2D section FEA on those cases&quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">StructureLog</span><span class="p">()</span>

        <span class="n">secton_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">skip_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">sort_max_estimated_failures</span><span class="p">(</span><span class="n">failures</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;run remote beam sections: </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;fail_frac&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="si">}</span><span class="s1">%&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">in</span> <span class="n">skip_beams</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># prep for output</span>
            <span class="k">if</span> <span class="n">beamnm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secton_results</span><span class="p">:</span>
                <span class="n">secton_results</span><span class="p">[</span><span class="n">beamnm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># get from sync</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sync</span><span class="o">.</span><span class="n">ensure</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">get_beam_forces</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">beamnm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">get_beam_info</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
            <span class="n">forces</span><span class="p">,</span> <span class="n">beam_ref</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">])</span>
            <span class="n">beam_ref</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span>
            <span class="n">allowable</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;allowable&quot;</span><span class="p">]</span>

            <span class="n">cur</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">remote_section</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">beam_ref</span><span class="p">,</span> <span class="n">beamnm</span><span class="p">,</span> <span class="n">forces</span><span class="p">,</span> <span class="n">allowable</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">SF</span><span class="o">=</span><span class="n">SF</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># run the damn thing</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">group_size</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;waiting on </span><span class="si">{</span><span class="n">group_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span>
                    <span class="n">beamnm</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>
                    <span class="n">combo</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;combo&quot;</span><span class="p">]</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
                    <span class="n">secton_results</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span>

                    <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">secton_results</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                            <span class="n">skip_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
                    <span class="c1"># else:</span>
                    <span class="c1"># log.info(f&#39;beam {beamnm} ok @ {x*100:3.0f}%| {c}&#39;)</span>

                <span class="n">cur</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done waiting, continue...&quot;</span><span class="p">)</span>

        <span class="c1"># finish them!</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;waiting on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done, continue...&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span>
                <span class="n">beamnm</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>
                <span class="n">combo</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;combo&quot;</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
                <span class="n">secton_results</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]][(</span><span class="n">combo</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span>

                <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;beam </span><span class="si">{</span><span class="n">beamnm</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">3.0f</span><span class="si">}</span><span class="s2">%| </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">secton_results</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_full</span><span class="p">:</span>
                        <span class="n">skip_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beamnm</span><span class="p">)</span>
                <span class="c1"># else:</span>
                <span class="c1"># log.info(f&#39;beam {beamnm} ok @ {x*100:3.0f}%| {c}&#39;)</span>

        <span class="k">return</span> <span class="n">secton_results</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>