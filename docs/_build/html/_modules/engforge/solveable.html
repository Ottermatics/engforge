<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.solveable &mdash; engforge 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/readthedocs-custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/test.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.solveable</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.solveable</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">attrs</span><span class="o">,</span><span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sciopt</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">typing</span>


<span class="c1"># from engforge.dynamics import DynamicsMixin</span>
<span class="kn">from</span> <span class="nn">engforge.attributes</span> <span class="kn">import</span> <span class="n">AttributeInstance</span>
<span class="kn">from</span> <span class="nn">engforge.engforge_attributes</span> <span class="kn">import</span> <span class="n">AttributedBaseMixin</span>
<span class="kn">from</span> <span class="nn">engforge.configuration</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">forge</span>
<span class="kn">from</span> <span class="nn">engforge.properties</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">engforge.solver_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.attr_dynamics</span> <span class="kn">import</span> <span class="n">IntegratorInstance</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">SOLVER_OPTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;minimize&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="SolvableLog">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolvableLog.html#engforge.solveable.SolvableLog">[docs]</a>
<span class="k">class</span> <span class="nc">SolvableLog</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">):</span>
    <span class="k">pass</span></div>




<span class="n">log</span> <span class="o">=</span> <span class="n">SolvableLog</span><span class="p">()</span>

<span class="c1">#Anonymous Update Funcs (solve scoping issue)</span>
<span class="k">def</span> <span class="nf">_update_func</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">eval_kw</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">updt</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">eval_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update| </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_kw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;create method| </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">eval_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">updt</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_update&#39;</span>
    <span class="k">return</span> <span class="n">updt</span>

<span class="k">def</span> <span class="nf">_post_update_func</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">eval_kw</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">updt</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">eval_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">post_update</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_kw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;create post method| </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">eval_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">updt</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_post_update&#39;</span>
    <span class="k">return</span> <span class="n">updt</span>

<span class="k">def</span> <span class="nf">_cost_update</span><span class="p">(</span><span class="n">comp</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">engforge.eng.costs</span> <span class="kn">import</span> <span class="n">Economics</span><span class="p">,</span><span class="n">CostModel</span>    
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">Economics</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">updt</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update economics </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">term_length</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;economics update cb </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">term_length</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
        <span class="n">updt</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_econ_update&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">updt</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update costs </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">update_dflt_costs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cost update cb </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
        <span class="n">updt</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_cost_update&#39;</span>
        
    <span class="k">return</span> <span class="n">updt</span>

<span class="n">dflt_dynamics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dynamics.state&#39;</span><span class="p">:{},</span><span class="s1">&#39;dynamics.input&#39;</span><span class="p">:{},</span><span class="s1">&#39;dynamics.rate&#39;</span><span class="p">:{},</span><span class="s1">&#39;dynamics.output&#39;</span><span class="p">:{},</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">:{}}</span>
<span class="n">skipa_attr_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span><span class="s2">&quot;dynamic_input_vars&quot;</span><span class="p">,</span><span class="s2">&quot;dynamic_state_vars&quot;</span><span class="p">,</span><span class="s2">&quot;dynamic_output_vars&quot;</span><span class="p">)</span>

    
<div class="viewcode-block" id="SolveableMixin">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin">[docs]</a>
<span class="k">class</span> <span class="nc">SolveableMixin</span><span class="p">(</span><span class="n">AttributedBaseMixin</span><span class="p">):</span>  <span class="c1">#&#39;Configuration&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;commonality for components,systems that identifies subsystems and states for solving.</span>

<span class="sd">    This class defines the update structure of components and systems, and the storage of internal references to the system and its components. It also provides a method to iterate over the internal components and their references.</span>

<span class="sd">    Importantly it defines the references to the system and its components, and the ability to set the system state from a dictionary of values across multiple objects. It also provides a method to iterate over the internal components and their references. There are several helper functions to these ends.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: add parent state storage</span>
    <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Configuration&quot;</span>

    <span class="n">_prv_internal_references</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_prv_internal_components</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_prv_internal_systems</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_prv_internal_tabs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_prv_system_references</span><span class="p">:</span> <span class="nb">dict</span>

    <span class="c1"># Update Flow</span>
    <span class="c1">#TODO: pass the problem vs the parent component, then locate this component in the problem and update any references</span>
<div class="viewcode-block" id="SolveableMixin.update">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kwargs comes from eval_kw in solver&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;void updating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SolveableMixin.post_update">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.post_update">[docs]</a>
    <span class="k">def</span> <span class="nf">post_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kwargs comes from eval_kw in solver&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;void post-updating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SolveableMixin.collect_update_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.collect_update_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_update_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eval_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;checks all methods and creates ref&#39;s to execute them later&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.eng.costs</span> <span class="kn">import</span> <span class="n">CostModel</span><span class="p">,</span><span class="n">Economics</span>

        <span class="n">updt_refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kn">from</span> <span class="nn">engforge.components</span> <span class="kn">import</span> <span class="n">Component</span>
        <span class="kn">from</span> <span class="nn">engforge.component_collections</span> <span class="kn">import</span> <span class="n">ComponentIter</span>

        <span class="c1"># Ignore</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_configurations</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">SolveableMixin</span><span class="p">):</span>
                <span class="k">continue</span>            

            <span class="c1">#provide add eval_kw</span>
            <span class="k">if</span> <span class="n">eval_kw</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">eval_kw</span><span class="p">:</span>
                <span class="n">eval_kw_comp</span> <span class="o">=</span> <span class="n">eval_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eval_kw_comp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ekw</span> <span class="o">=</span> <span class="n">eval_kw_comp</span>

            <span class="c1">#Add if its a unique update method (not the passthrough)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,(</span><span class="n">CostModel</span><span class="p">,</span><span class="n">Economics</span><span class="p">)):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">_cost_update</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
                <span class="n">updt_refs</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;._cost_model_&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ref</span>            
            
            <span class="k">elif</span> <span class="n">comp</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">update</span> <span class="o">!=</span> <span class="n">SolveableMixin</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">_update_func</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">ekw</span><span class="p">))</span>
                <span class="n">updt_refs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ref</span>
            
            <span class="c1">#Cost Models</span>


        <span class="n">ignore</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updt_refs</span></div>


<div class="viewcode-block" id="SolveableMixin.collect_post_update_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.collect_post_update_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_post_update_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eval_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;checks all methods and creates ref&#39;s to execute them later&quot;&quot;&quot;</span>
        <span class="n">updt_refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kn">from</span> <span class="nn">engforge.components</span> <span class="kn">import</span> <span class="n">Component</span>
        <span class="kn">from</span> <span class="nn">engforge.component_collections</span> <span class="kn">import</span> <span class="n">ComponentIter</span>

        <span class="c1"># Ignore</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_configurations</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">SolveableMixin</span><span class="p">):</span>
                <span class="k">continue</span>            

            <span class="c1"># provide add eval_kw</span>
            <span class="k">if</span> <span class="n">eval_kw</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">eval_kw</span><span class="p">:</span>
                <span class="n">eval_kw_comp</span> <span class="o">=</span> <span class="n">eval_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eval_kw_comp</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="n">ekw</span> <span class="o">=</span> <span class="n">eval_kw_comp</span>
                
            <span class="c1">#Add if its a unique update method (not the passthrough)</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">post_update</span> <span class="o">!=</span> <span class="n">SolveableMixin</span><span class="o">.</span><span class="n">post_update</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">_post_update_func</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">ekw</span><span class="p">))</span>
                <span class="n">updt_refs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ref</span>

        <span class="n">ignore</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updt_refs</span></div>


    <span class="c1"># internals caching</span>
    <span class="c1"># instance attributes</span>

    <span class="c1">#TODO: move all system / property &amp; identification to the problem_context or new system_identificaiton class (problem/base)</span>
    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;this is just a record of signals from this solvable. dont use this to get the signals, use high level signals strategy #TODO: add signals strategy&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals_attributes</span><span class="p">()}</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">solvers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;this is just a record of any solvable attribute. dont use this to get the attribute, use another strategy&quot;&quot;&quot;</span>        
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvers_attributes</span><span class="p">()}</span>

    <span class="nd">@instance_cached</span><span class="p">(</span><span class="n">allow_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">transients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;this is just a record of any transient attribute. dont use this to get the transient, use another strategy&quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transients_attributes</span><span class="p">()}</span>

<div class="viewcode-block" id="SolveableMixin.internal_components">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.internal_components">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get all the internal components&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prv_internal_components&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_components</span>
        <span class="kn">from</span> <span class="nn">engforge.components</span> <span class="kn">import</span> <span class="n">Component</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()}</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Component</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_components</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="SolveableMixin.internal_systems">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.internal_systems">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get all the internal components&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prv_internal_systems&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_systems</span>
        <span class="kn">from</span> <span class="nn">engforge.system</span> <span class="kn">import</span> <span class="n">System</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()}</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">System</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_systems</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="SolveableMixin.internal_tabulations">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.internal_tabulations">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_tabulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get all the internal tabulations&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.tabulation</span> <span class="kn">import</span> <span class="n">TabulationMixin</span>

        <span class="k">if</span> <span class="n">recache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prv_internal_tabs&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_tabs</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()}</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TabulationMixin</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_tabs</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">return</span> <span class="n">o</span></div>


    <span class="c1"># recursive references</span>
    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">iterable_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds ComponentIter internal_components that are not &#39;wide&#39;&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.component_collections</span> <span class="kn">import</span> <span class="n">ComponentIter</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_components</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ComponentIter</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">wide</span>
        <span class="p">}</span>

<div class="viewcode-block" id="SolveableMixin.internal_references">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.internal_references">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get references to all internal attributes and values, only saving when complete cache info is requested (vs numeric only)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_only</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prv_internal_references&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_references</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_references</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="n">numeric_only</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_only</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_internal_references</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="k">def</span> <span class="nf">_gather_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">():</span>
            <span class="n">pr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numeric_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">numeric_fields</span><span class="p">():</span>
                <span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_fields</span><span class="p">((</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">dict</span><span class="p">)):</span>
                <span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_iterate_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sets the current component for each product combination of iterable_components&quot;&quot;&quot;</span>

        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterable_components</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">yield</span>  <span class="c1"># enter once</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">_gen</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">compkey</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">itemkey</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">compkey</span><span class="p">,</span> <span class="n">itemkey</span>

            <span class="n">iter_vals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">cn</span><span class="p">:</span> <span class="n">_gen</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">_item_gen</span><span class="p">(),</span> <span class="n">cn</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">iter_vals</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                    <span class="c1"># TODO: progress bar or print location</span>
                    <span class="n">components</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span><span class="o">.</span><span class="n">current_item</span> <span class="o">=</span> <span class="n">ikey</span>
                <span class="k">yield</span> <span class="n">out</span>

            <span class="c1"># finally reset the data!</span>
            <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<div class="viewcode-block" id="SolveableMixin.comp_references">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.comp_references">[docs]</a>
    <span class="k">def</span> <span class="nf">comp_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ignore_none_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A cached set of recursive references to any slot component</span>
<span class="sd">        #FIXME: by instance recache on iterative component change or other signals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="n">parent_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ignore_none_comp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">SolveableMixin</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="c1"># Run &amp; Input</span>
    <span class="k">def</span> <span class="nf">_iterate_input_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">,</span>
        <span class="n">cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sequence</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_kw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sys_kw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">method_kw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;applies a permutation of input vars for vars. runs the system instance by applying input to the system and its slot-components, ensuring that the targeted attributes actualy exist.</span>

<span class="sd">        :param revert: will reset the values of X that were recorded at the beginning of the run.</span>
<span class="sd">        :param cb: a callback function that takes the system as an argument cb(system)</span>
<span class="sd">        :param sequence: a list of dictionaries that should be run in order per the outer-product of kwargs</span>
<span class="sd">        :param eval_kw: a dictionary of keyword arguments to pass to the eval function of each component by their name and a set of keyword args. Use this to set values in the component that are not inputs to the system. No iteration occurs upon these values, they are static and irrevertable</span>
<span class="sd">        :param sys_kw: a dictionary of keyword arguments to pass to the eval function of each system by their name and a set of keyword args. Use this to set values in the component that are not inputs to the system. No iteration occurs upon these values, they are static and irrevertable</span>
<span class="sd">        :param kwargs: inputs are run on a product basis asusming they correspond to actual scoped vars (system.var or system.slot.var)</span>


<span class="sd">        :returns: system or list of systems. If transient a set of systems that have been run with permutations of the input, otherwise a single system with all permutations input run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.system</span> <span class="kn">import</span> <span class="n">System</span>
        <span class="kn">from</span> <span class="nn">engforge.problem_context</span> <span class="kn">import</span> <span class="n">ProblemExec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;running [Solver].</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s2"> with input </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ProblemExec</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">),</span> <span class="s1">&#39;must be active context!&#39;</span>
        <span class="c1"># create iterable null for sequence</span>
        <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="p">[{}]</span>

        <span class="k">if</span> <span class="n">method_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create Keys List</span>
        <span class="n">sequence_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="n">sequence_keys</span> <span class="o">=</span> <span class="n">sequence_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c1"># RUN when not solved, or anything changed, or arguments or if forced</span>
        <span class="k">if</span> <span class="n">force_solve</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">solved</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">anything_changed</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_run_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span> <span class="s2">&quot;input_sets&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">}</span>

            <span class="c1"># Pre Run Callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_run_callback</span><span class="p">(</span><span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span> <span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Premute the input as per SS or Transient Logic</span>
            <span class="n">ingrp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Iterate over components (they are assigned to the system by call)</span>
            <span class="k">for</span> <span class="n">itercomp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_components</span><span class="p">():</span>
                <span class="c1"># Iterate over inputs</span>
                <span class="k">for</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">ingrp</span><span class="p">):</span>
                    <span class="c1"># Set the reference aliases</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)}</span>

                    <span class="c1"># Iterate over Sequence (or run once)</span>
                    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
                        <span class="c1">#apply sequence values</span>
                        <span class="n">icur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="c1">#apply sequence values</span>
                        <span class="k">if</span> <span class="n">seq</span><span class="p">:</span>
                            <span class="n">icur</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">seq</span><span class="p">)</span>

                        <span class="c1"># Run The Method with inputs provisioned</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span>
                            <span class="n">icur</span><span class="p">,</span> <span class="n">eval_kw</span><span class="p">,</span> <span class="n">sys_kw</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kw</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                            <span class="c1"># store the output</span>
                            <span class="n">output</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">output</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
                            <span class="c1"># store the input</span>
                            <span class="n">inputs</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">inputs</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">icur</span>

            <span class="c1"># nice</span>
            <span class="c1">#TODO: wrap this with context manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solved</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Pre Run Callback with current state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_run_callback</span><span class="p">(</span><span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span> <span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">anything_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nothing changed, not running </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Analysis Already Solved&quot;</span><span class="p">)</span>

    <span class="c1"># IO Functions</span>
<div class="viewcode-block" id="SolveableMixin.parse_simulation_input">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.parse_simulation_input">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_simulation_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;parses the simulation input</span>

<span class="sd">        :param dt: timestep in s, required for transients</span>
<span class="sd">        :param endtime: when to end the simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># timestep</span>
        <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;transients require `dt` to run&quot;</span><span class="p">)</span>
        <span class="c1"># f&quot;transients require timestep input `dt`&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">))</span>

        <span class="c1"># endtime</span>
        <span class="k">if</span> <span class="s2">&quot;endtime&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;transients require `endtime` to run&quot;</span><span class="p">)</span>

        <span class="c1"># add data</span>
        <span class="n">_trans_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;endtime&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">_trans_opts</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>

        <span class="c1"># f&quot;transients require `endtime` to specify &quot;</span>
        <span class="n">_trans_opts</span><span class="p">[</span><span class="s2">&quot;endtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endtime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;endtime&quot;</span><span class="p">))</span>
        <span class="n">_trans_opts</span><span class="p">[</span><span class="s2">&quot;Nrun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endtime</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># TODO: expose integrator choices</span>
        <span class="c1"># TODO: add delay and signal &amp; feedback options</span>

        <span class="k">return</span> <span class="n">_trans_opts</span></div>


<div class="viewcode-block" id="SolveableMixin.parse_run_kwargs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.parse_run_kwargs">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_run_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ensures correct input for simulation.</span>
<span class="sd">        :returns: first set of input for initalization, and all input dictionaries as tuple.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate OTher Arguments By Parameter Or Comp-Recursive</span>
        <span class="n">var_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>
        <span class="n">comp_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>

        <span class="c1"># check vars</span>
        <span class="n">inpossible</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_fields</span><span class="p">()),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">argdiff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">var_args</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">inpossible</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">argdiff</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;bad input </span><span class="si">{</span><span class="n">argdiff</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># check components</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comp_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="n">compdiff</span> <span class="o">=</span> <span class="n">comps</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">compdiff</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;bad slot references </span><span class="si">{</span><span class="n">compdiff</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">_input</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">test</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">add</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">add</span><span class="p">))</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># vars input</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># If a slot check the type is applicable</span>
            <span class="n">subslot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_slot_type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subslot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># log.debug(f&#39;found subslot {k}: {subslot}&#39;)</span>
                <span class="n">addty</span> <span class="o">=</span> <span class="n">subslot</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addty</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Ensure Its a List</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">test</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">addty</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;bad values </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">test</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">addty</span><span class="p">)</span> <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;bad values: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_input</span><span class="p">:</span>
                <span class="n">_input</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_input</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_input</span></div>


    <span class="c1"># REFERENCE FUNCTIONS</span>
    <span class="c1"># Location Funcitons</span>
<div class="viewcode-block" id="SolveableMixin.locate">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.locate">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">locate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:returns: the class or attribute by key if its in this system class or a subcomponent. If nothing is found raise an error&quot;&quot;&quot;</span>
        <span class="c1"># Nested</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;locating </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> | key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">comp</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">assert</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">comp_cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()[</span><span class="n">comp</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">accepted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">comp_cls</span><span class="o">.</span><span class="n">locate</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">input_fields</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">input_fields</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Fail on comand but otherwise return val</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">val</span></div>


<div class="viewcode-block" id="SolveableMixin.locate_ref">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.locate_ref">[docs]</a>
    <span class="k">def</span> <span class="nf">locate_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass a string of a relative var or property on this system or pass a callable to get a reference to a function. If the key has a `.` in it the comp the lowest level component will be returned, unless a callable is passed in which case this component will be used or the `comp` passed in the kw will be used.</span>
<span class="sd">        :param key: the key to locate, or a callable to be used as a reference</span>
<span class="sd">        :param comp: the component to use if a callable is passed</span>
<span class="sd">        :returns: the instance assigned to this system. If the key has a `.` in it the comp the lowest level component will be returned</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;locating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s2"> | key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#Handle callable key override</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;comp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;comp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;comp kwarg not allowed with string key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">comp</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">assert</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># comp_cls = cls.slots_attributes()[comp].type.accepted[0]</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">locate_ref</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="n">fail</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_fields</span><span class="p">():</span>
            <span class="c1"># val= cls.input_fields()[key]</span>
            <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_properties_classdef</span><span class="p">():</span>
            <span class="c1"># val= cls.system_properties_classdef()[key]</span>
            <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_configurations</span><span class="p">()</span>
            <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_attributes</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="c1"># Fail on comand but otherwise return val</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">val</span></div>


    <span class="c1"># Reference Caching</span>
    <span class="c1">#TODO: move to problem context</span>
<div class="viewcode-block" id="SolveableMixin.system_references">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.system_references">[docs]</a>
    <span class="k">def</span> <span class="nf">system_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;gather a list of references to attributes and&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kw</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prv_system_references&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_system_references</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_references</span><span class="p">(</span><span class="n">recache</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="n">numeric_only</span><span class="p">)</span>
        <span class="n">tatr</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
        <span class="n">tprp</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
        <span class="n">comp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_set_ref</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># component iternals</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_references</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sout</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">internal_references</span><span class="p">(</span><span class="n">recache</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="n">numeric_only</span><span class="p">)</span>
            <span class="n">satr</span> <span class="o">=</span> <span class="n">sout</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
            <span class="n">sprp</span> <span class="o">=</span> <span class="n">sout</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
            
            <span class="c1">#find the parent component</span>
            <span class="n">key_segs</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_segs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_segs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1">#parent refs for assigning a component</span>
            <span class="n">comp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="p">:</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">comp_set_ref</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">comp_dict</span><span class="p">[</span><span class="n">parent</span><span class="p">],</span><span class="n">attr_name</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Fill in</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">satr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skipa_attr_names</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">tatr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sprp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tprp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kw</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prv_system_references</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span></div>

    
<div class="viewcode-block" id="SolveableMixin.collect_comp_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.collect_comp_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_comp_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conf</span><span class="p">:</span><span class="s2">&quot;Configuration&quot;</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;collects all the references for the system grouped by component&quot;&quot;&quot;</span>    
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">comp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comps&#39;</span><span class="p">:</span><span class="n">comp_dict</span><span class="p">,</span><span class="s1">&#39;attrs&#39;</span><span class="p">:</span><span class="n">attr_dict</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="n">cls_dict</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">comp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">collect_inst_attributes</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span></div>

    
    
<div class="viewcode-block" id="SolveableMixin.collect_solver_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.collect_solver_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_solver_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conf</span><span class="p">:</span><span class="s2">&quot;Configuration&quot;</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">check_atr_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">check_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">check_dynamics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;collects all the references for the system grouped by function and prepended with the system key&quot;&quot;&quot;</span>    
        <span class="kn">from</span> <span class="nn">engforge.attributes</span> <span class="kn">import</span> <span class="n">ATTR_BASE</span>
        <span class="kn">from</span> <span class="nn">engforge.engforge_attributes</span> <span class="kn">import</span> <span class="n">AttributedBaseMixin</span>
        
        <span class="n">confobj</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="k">if</span> <span class="n">confobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">confobj</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">comp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comps&#39;</span><span class="p">:</span><span class="n">comp_dict</span><span class="p">,</span><span class="s1">&#39;attrs&#39;</span><span class="p">:</span><span class="n">attr_dict</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="n">cls_dict</span><span class="p">,</span><span class="s1">&#39;skipped&#39;</span><span class="p">:</span><span class="n">skipped</span><span class="p">}</span>
        
        <span class="c1">#Go through all components</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">confobj</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="s1">&#39;_solver_override&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conf</span><span class="o">.</span><span class="n">_solver_override</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1">#Get attributes &amp; attribute instances</span>
            <span class="n">atrs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">collect_inst_attributes</span><span class="p">()</span>
            <span class="n">rawattr</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">collect_inst_attributes</span><span class="p">(</span><span class="n">handle_inst</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="c1">#you need a dot if there&#39;s a key</span>
            <span class="n">comp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
            <span class="c1">#Gather attribute heirarchy and make key.var the dictionary entry</span>
            <span class="k">for</span> <span class="n">atype</span><span class="p">,</span><span class="n">aval</span> <span class="ow">in</span> <span class="n">atrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                
                <span class="n">ck_type</span> <span class="o">=</span> <span class="n">rawattr</span><span class="p">[</span><span class="n">atype</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_dict</span><span class="p">:</span>
                    <span class="n">cls_dict</span><span class="p">[</span><span class="n">atype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aval</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">aval</span><span class="p">:</span>
                                       
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">pre</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">ATTR_BASE</span><span class="o">.</span><span class="n">unpack_atrs</span><span class="p">(</span><span class="n">aval</span><span class="p">,</span><span class="n">atype</span><span class="p">):</span>

                        <span class="c1">#No Room For Components (SLOTS feature)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,(</span><span class="n">AttributedBaseMixin</span><span class="p">,</span><span class="n">ATTR_BASE</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">conf</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skipping comp attr </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>   

                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got val: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  

                        <span class="n">slv_type</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">pre_var</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">pre_var</span><span class="p">):</span>
                            <span class="n">_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">pre_var</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_var</span><span class="p">,</span><span class="n">AttributeInstance</span><span class="p">):</span>
                                <span class="n">slv_type</span> <span class="o">=</span> <span class="n">_var</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;slv type: </span><span class="si">{</span><span class="n">conf</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">pre_var</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">_var</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="n">val_type</span> <span class="o">=</span> <span class="n">ck_type</span><span class="p">[</span><span class="n">pre_var</span><span class="p">]</span>

                        <span class="c1">#Otherwise assign the data from last var and the compoenent name</span>
                        <span class="n">var_name</span> <span class="o">=</span> <span class="n">pre_var</span> <span class="c1">#prer alias</span>
                        <span class="k">if</span> <span class="n">slv_type</span><span class="p">:</span>
                            <span class="n">var_name</span> <span class="o">=</span> <span class="n">slv_type</span><span class="o">.</span><span class="n">get_alias</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
                        
                        <span class="c1">#Keep reference to the original type and name</span>
                        <span class="n">scope_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">var_name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">cls_dict</span><span class="p">[</span><span class="n">atype</span><span class="p">][</span><span class="n">scope_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_type</span>
                        
                        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rec: </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">slv_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="c1">#Check to skip this item</span>
                        <span class="c1">#keep references even if null</span>
                        <span class="n">pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">atype</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1">#pre switch</span>
                        <span class="k">if</span> <span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="p">:</span>
                            <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">Ref</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">allow_set</span><span class="p">:</span>
                            <span class="c1">#its a var, skip it if it&#39;s already been skipped</span>
                            <span class="n">current_skipped</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">skipped</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                            <span class="k">if</span> <span class="n">current_skipped</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">current_skipped</span><span class="p">):</span>
                                <span class="k">continue</span>
                        
                        <span class="c1">#Perform the check</span>
                        <span class="k">if</span> <span class="n">check_atr_f</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_atr_f</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">scope_name</span><span class="p">,</span><span class="n">val_type</span><span class="p">,</span><span class="n">check_kw</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chk skip </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped</span><span class="p">:</span>
                                <span class="n">skipped</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">Ref</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">allow_set</span><span class="p">:</span>
                                <span class="c1">#its a var</span>
                                <span class="n">skipped</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">val</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1">#not objective or settable, must be a obj/cond</span>
                                <span class="n">skipped</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1">#if the value is a dictionary, unpack it with comp key</span>
                        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                            <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">scope_name</span><span class="p">:</span><span class="n">val</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]:</span>
                                <span class="k">continue</span> <span class="c1">#keep it!</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#reset it</span>

                <span class="k">elif</span> <span class="n">atype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_dict</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">attr_dict</span><span class="p">[</span><span class="n">atype</span><span class="p">]:</span>
                   <span class="c1">#print(f&#39;unpacking {atype} {aval}&#39;)</span>
                   <span class="n">attr_dict</span><span class="p">[</span><span class="n">atype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1">#Dynamic Variables Add, following the skipped items</span>
        <span class="k">if</span> <span class="n">check_dynamics</span><span class="p">:</span>
            <span class="n">dyn_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_dynamic_refs</span><span class="p">(</span><span class="n">confobj</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#house keeping to organize special returns </span>
            
            <span class="c1">#TODO: generalize this with a function to update the attr dict serach result when changing components</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyn_comp</span> <span class="o">=</span> <span class="n">dyn_refs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">,{})</span>
            
            <span class="c1">#Check the dynamics for the system</span>
            <span class="k">if</span> <span class="n">check_atr_f</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">skipped</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>

                <span class="n">skipd</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="c1">#check each group of dynamics</span>
                <span class="k">for</span> <span class="n">pre</span><span class="p">,</span><span class="n">refs</span> <span class="ow">in</span> <span class="n">dyn_refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    
                    <span class="k">if</span> <span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped</span><span class="p">:</span>
                        <span class="n">skipped</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="p">:</span>
                        <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{}</span> <span class="c1">#initalize dynamic group</span>
                    
                    <span class="c1">#eval each ref for inclusion</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="n">refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        
                        <span class="n">key_segs</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_segs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_segs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">scoped_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="n">dyn_comp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>                        

                        <span class="n">is_ref</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">Ref</span><span class="p">)</span> 
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ref</span><span class="p">:</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;not ref </span><span class="si">{</span><span class="n">scoped_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">is_ref</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ref</span><span class="o">.</span><span class="n">allow_set</span><span class="p">:</span>
                            <span class="c1">#adding unsettables (likely rates)</span>
                            <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">var</span><span class="p">:</span><span class="n">ref</span><span class="p">})</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;set escape: </span><span class="si">{</span><span class="n">scoped_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        
                        <span class="n">val_type</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">comp</span>
                        <span class="k">if</span> <span class="n">check_atr_f</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">check_atr_f</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">val_type</span><span class="p">,</span><span class="n">check_kw</span><span class="p">):</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dynvar add </span><span class="si">{</span><span class="n">pre</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">val_type</span><span class="p">,</span><span class="n">skipd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">attr_dict</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">var</span><span class="p">:</span><span class="n">ref</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">conf</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dynvar endskip </span><span class="si">{</span><span class="n">pre</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">val_type</span><span class="p">,</span><span class="n">skipd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">check_atr_f</span><span class="p">:</span> <span class="c1">#then it didn&#39;t checkout</span>
                                <span class="n">skipped</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#There&#39;s no checks to be done, just add these</span>
                <span class="n">attr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dyn_refs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpy</span> <span class="o">=</span> <span class="n">dflt_dynamics</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">,{})</span>
            <span class="n">attr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cpy</span><span class="p">)</span>
            
                         

        <span class="k">return</span> <span class="n">out</span></div>


    <span class="c1">#Dynamics info refs</span>
<div class="viewcode-block" id="SolveableMixin.collect_dynamic_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.collect_dynamic_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_dynamic_refs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="s2">&quot;Configuration&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;collects the dynamics of the systems</span>
<span class="sd">        1. Time.integrate</span>
<span class="sd">        2. Dynamic Instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.dynamics</span> <span class="kn">import</span> <span class="n">DynamicsMixin</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">dynamics</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dflt_dynamics</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="c1"># FIXME: add a check for the dynamics mixin, that isn&#39;t hacky</span>
            <span class="c1"># BUG: importing dynamicsmixin resolves as different class in different modules, weird</span>
            <span class="c1"># if &quot;dynamicsmixin&quot; not in str(conf.__class__.mro()).lower():</span>
            <span class="c1">#     continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">DynamicsMixin</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">is_dynamic</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">sval</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sval</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">dynamics</span><span class="p">[</span><span class="s1">&#39;dynamics.state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">Xt_ref</span><span class="p">))</span>
            <span class="n">dynamics</span><span class="p">[</span><span class="s1">&#39;dynamics.input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">Ut_ref</span><span class="p">))</span>
            <span class="n">dynamics</span><span class="p">[</span><span class="s1">&#39;dynamics.output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">Yt_ref</span><span class="p">))</span>
            <span class="n">dynamics</span><span class="p">[</span><span class="s1">&#39;dynamics.rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">dXtdt_ref</span><span class="p">))</span>
            <span class="n">dynamics</span><span class="p">[</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>

        <span class="k">return</span> <span class="n">dynamics</span></div>



<div class="viewcode-block" id="SolveableMixin.get_system_input_refs">
<a class="viewcode-back" href="../../_autosummary/engforge.solveable.SolveableMixin.html#engforge.solveable.SolveableMixin.get_system_input_refs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_system_input_refs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">strings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">misc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">boolean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the references to system input based on the specified criteria.</span>

<span class="sd">        :param strings: Include system properties of string type.</span>
<span class="sd">        :param numeric: Include system properties of numeric type (float, int).</span>
<span class="sd">        :param misc: Include system properties of miscellaneous type.</span>
<span class="sd">        :param all: Include all system properties regardless of type.</span>
<span class="sd">        :param boolean: Include system properties of boolean type.</span>
<span class="sd">        :param kw: Additional keyword arguments passed to recursive config loop</span>
<span class="sd">        :return: A dictionary of system property references.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.tabulation</span> <span class="kn">import</span> <span class="n">SKIP_REF</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ckey</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">atr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">input_fields</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">SKIP_REF</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
                    <span class="n">refs</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">ckey</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span>
                        <span class="n">comp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">atr</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">ty</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">type</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">boolean</span><span class="p">:</span>
                            <span class="k">continue</span>  <span class="c1"># prevent catch at int type</span>
                        <span class="n">refs</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">ckey</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span>
                            <span class="n">comp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="n">numeric</span><span class="p">:</span>
                        <span class="n">refs</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">ckey</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span>
                            <span class="n">comp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="n">strings</span><span class="p">:</span>
                        <span class="n">refs</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">ckey</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span>
                            <span class="n">comp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">misc</span><span class="p">:</span>
                        <span class="n">refs</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">ckey</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span>
                            <span class="n">comp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">refs</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>