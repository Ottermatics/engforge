<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.dynamics &mdash; engforge 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/readthedocs-custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/test.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.dynamics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.dynamics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Combines the tabulation and component mixins to create a mixin for systems and components that have dynamics, such as state space models, while allowing nonlinear dynamics via matrix modification</span>

<span class="sd">This module is intended to work alongside the solver module and the Time integrating attributes, and will raise an error if a conflict is detected.</span>

<span class="sd">The DynamicsMixin works by establishing a state matricies A, B, C, and D, which are used to define the dynamics of the system. The state matrix A is the primary matrix, and is used to define the state dynamics of the system. The input matrix B is used to define the input dynamics of the system. The output matrix C is used to define the output dynamics of the system. The feedthrough matrix D is used to define the feedthrough dynamics of the system.</span>

<span class="sd">As opposed to the Time attribute, which modifies the state of the system, the DynamicsMixin copies the initial values of the state and input which then are integrated over time. At predefined intervals the control and output will stored in the tabulation.</span>

<span class="sd">#TODO: The top level system will collect the underlying dynamical systems and combine them to an index and overall state space model. This will allow for the creation of a system of systems, and the ability to create a system of systems with a single state space model.</span>

<span class="sd">#TODO: integration is done by the solver, where DynamicSystems have individual solver control, solver control is set for a smart default scipy </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">engforge.configuration</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">forge</span>
<span class="kn">from</span> <span class="nn">engforge.tabulation</span> <span class="kn">import</span> <span class="n">TabulationMixin</span>
<span class="kn">from</span> <span class="nn">engforge</span> <span class="kn">import</span> <span class="n">properties</span> <span class="k">as</span> <span class="n">prop</span>
<span class="kn">from</span> <span class="nn">engforge.attributes</span> <span class="kn">import</span> <span class="n">ATTR_BASE</span>
<span class="kn">from</span> <span class="nn">engforge.properties</span> <span class="kn">import</span> <span class="n">instance_cached</span><span class="p">,</span> <span class="n">solver_cached</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">engforge.problem_context</span> <span class="kn">import</span> <span class="n">ProblemExec</span>
<span class="kn">from</span> <span class="nn">engforge.solveable</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SolveableMixin</span><span class="p">,</span>
    <span class="n">refmin_solve</span><span class="p">,</span>
    <span class="n">refset_get</span><span class="p">,</span>
    <span class="n">refset_input</span><span class="p">,</span>
<span class="p">)</span>


<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">expiringdict</span>
<span class="kn">import</span> <span class="nn">attr</span><span class="o">,</span> <span class="nn">attrs</span>


<span class="c1"># Index maps are used to translate between different indexes (local &amp; global)</span>

<div class="viewcode-block" id="valid_mtx">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.valid_mtx.html#engforge.dynamics.valid_mtx">[docs]</a>
<span class="k">def</span> <span class="nf">valid_mtx</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1">##TODO: compile problems using index_map</span>
<span class="c1">#TODO: move to problem module</span>
<div class="viewcode-block" id="INDEX_MAP">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.INDEX_MAP.html#engforge.dynamics.INDEX_MAP">[docs]</a>
<span class="k">class</span> <span class="nc">INDEX_MAP</span><span class="p">:</span>
    <span class="n">oppo</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datas</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="INDEX_MAP.__call__">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.INDEX_MAP.html#engforge.dynamics.INDEX_MAP.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">indify</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">arr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">remap_indexes_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_index</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">old_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">old_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">old_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">opt1</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indify</span><span class="p">(</span><span class="n">old_data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">}</span>
        <span class="n">opt2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indify</span><span class="p">(</span><span class="n">old_data</span><span class="p">,</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
            <span class="k">else</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">opt1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">oop1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indify</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">opt2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">oop2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indify</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">!=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oppo</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]))</span>
            <span class="k">else</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">oop1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">oop2</span></div>






<span class="c1"># Quickly create a state space model</span>
<span class="c1"># TODO: How to add delay, and feedback?</span>
<span class="c1"># TODO: How to add control and limits in general?</span>
<span class="c1"># TODO: add time as a state variable</span>
<div class="viewcode-block" id="DynamicsMixin">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">DynamicsMixin</span><span class="p">(</span><span class="n">Configuration</span><span class="p">,</span> <span class="n">SolveableMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dynamic mixin for components and systems that have dynamics, such as state space models, while allowing nonlinear dynamics via matrix modification. This mixin is intended to work alongside the solver module and the Time integrating attributes, and will raise an error if a conflict is detected #TODO.&quot;&quot;&quot;</span>

    <span class="c1">#time: float = attrs.field(default=0.0)</span>

    <span class="n">dynamic_state_vars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span><span class="c1">#attrs.field(factory=list)</span>
    <span class="n">dynamic_input_vars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span>  <span class="p">[]</span><span class="c1">#attrs.field(factory=list)</span>
    <span class="n">dynamic_output_vars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span>  <span class="p">[]</span><span class="c1">#attrs.field(factory=list)</span>

    <span class="c1"># state variables</span>
    <span class="n">dynamic_A</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dynamic_B</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dynamic_C</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dynamic_D</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dynamic_F</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dynamic_K</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Static linear state</span>
    <span class="n">static_A</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">static_B</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">static_C</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">static_D</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">static_F</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">static_K</span><span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO:</span>
    <span class="c1"># dynamic_control_module = None</span>
    <span class="c1"># control_interval:float = 0.0 ##TODO: how often to update the control</span>
    <span class="c1"># TODO: how often to update the physics, 0 is everytime</span>
    <span class="n">update_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span>  <span class="mi">0</span>
    <span class="c1">#delay_ms: float = attrs.field(default=None)</span>
    <span class="n">nonlinear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># TODO: add integration state dynamic cache to handle relative time steps</span>
    <span class="c1"># TODO: add control module with PID control and pole placement design</span>

    <span class="c1">#### State Space Model</span>
    <span class="k">def</span> <span class="nf">__pre_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override this method to define the class&quot;&quot;&quot;</span>
        <span class="c1"># fields =</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fields_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">system_property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_properties_def</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;state var </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> not in attr: </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;output var </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> not in attr: </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_vars</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;input var </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> not in attr: </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#convience function </span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;last_context&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="s1">&#39;_time&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">time</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">is_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">dynamic_state_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">)</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">dynamic_input_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_vars</span><span class="p">)</span>

    <span class="nd">@instance_cached</span>
    <span class="k">def</span> <span class="nf">dynamic_output_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_vars</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">]</span>
        <span class="p">)</span>


<div class="viewcode-block" id="DynamicsMixin.create_state_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_state_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">create_state_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the state matrix for the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_size</span><span class="p">))</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_input_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_input_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">create_input_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the input matrix for the system, called B&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_size</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_output_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_output_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">create_output_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the input matrix for the system, called C&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_size</span><span class="p">))</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_feedthrough_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_feedthrough_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">create_feedthrough_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the input matrix for the system, called D&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_state_constants">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_state_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">create_state_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the input matrix for the system, called F&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_output_constants">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_output_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">create_output_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates the input matrix for the system, called O&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicsMixin.create_dynamic_matricies">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.create_dynamic_matricies">[docs]</a>
    <span class="k">def</span> <span class="nf">create_dynamic_matricies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates a dynamics object for the system&quot;&quot;&quot;</span>
        <span class="c1"># State + Control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_state_matrix</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_input_matrix</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="c1"># Output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_matrix</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_feedthrough_matrix</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_state_constants</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_constants</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input</span><span class="p">)</span></div>


    <span class="c1"># Nonlinear Support</span>
    <span class="c1"># Override these callbacks to modify the state space model</span>
<div class="viewcode-block" id="DynamicsMixin.update_state">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_state">[docs]</a>
    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_input">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_input">[docs]</a>
    <span class="k">def</span> <span class="nf">update_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">B</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_output_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_output_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">update_output_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">C</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_feedthrough">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_feedthrough">[docs]</a>
    <span class="k">def</span> <span class="nf">update_feedthrough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">D</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_state_constants">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_state_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">update_state_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">F</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_output_constants">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_output_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">update_output_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">O</span></div>


<div class="viewcode-block" id="DynamicsMixin.update_dynamics">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.update_dynamics">[docs]</a>
    <span class="k">def</span> <span class="nf">update_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates dynamics when nonlinear is enabled, otherwise it will do nothing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># try: #NOTE: try catch adds a lot of overhead</span>
        <span class="c1"># State + Control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_A</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_input</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_B</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

        <span class="c1"># Output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_output_matrix</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_C</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_feedthrough</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_D</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_state_constants</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_F</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_output_constants</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_K</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span><span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update_dynamics A:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span><span class="si">}</span><span class="s1"> B:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span><span class="si">}</span><span class="s1"> C:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_C</span><span class="si">}</span><span class="s1"> D:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_D</span><span class="si">}</span><span class="s1"> F:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span><span class="si">}</span><span class="s1"> K:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_K</span><span class="si">}</span><span class="s1">| time:</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> X:</span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s1"> U:</span><span class="si">{</span><span class="n">U</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


        <span class="c1"># except Exception as e:</span>
        <span class="c1">#     self.warning(f&#39;update dynamics failed! A:{self.dynamic_A} B:{self.dynamic_B} C:{self.dynamic_C} D:{self.dynamic_D} F:{self.dynamic_F} K:{self.dynamic_K}| time:{t} X:{X} U:{U}&#39;)</span>
        <span class="c1">#     raise e         </span>

    <span class="c1"># linear and nonlinear system level IO</span>

<div class="viewcode-block" id="DynamicsMixin.rate">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.rate">[docs]</a>
    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time.</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): interval to integrate over in time</span>
<span class="sd">            X (np.ndarray): state input</span>
<span class="sd">            U (np.ndarray): control input</span>
<span class="sd">            subsystems (bool, optional): simulate subsystems. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe: tabulated data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_nonlinear</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_linear</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>            </div>


<div class="viewcode-block" id="DynamicsMixin.rate_linear">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.rate_linear">[docs]</a>
    <span class="k">def</span> <span class="nf">rate_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time. Return time differential of the state.&quot;&quot;&quot;</span>
        
        <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_A</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_A</span> <span class="o">@</span> <span class="n">X</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_B</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_B</span> <span class="o">@</span> <span class="n">U</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_F</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_F</span>

        <span class="k">return</span> <span class="n">O</span></div>


<div class="viewcode-block" id="DynamicsMixin.linear_output">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.linear_output">[docs]</a>
    <span class="k">def</span> <span class="nf">linear_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time. Return time differential of the state.</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): interval to integrate over in time</span>
<span class="sd">            X (np.ndarray): state input</span>
<span class="sd">            U (np.ndarray): control input</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: time differential of the state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_C</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_C</span> <span class="o">@</span> <span class="n">X</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_D</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_D</span> <span class="o">@</span> <span class="n">U</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_K</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_K</span>
        <span class="k">return</span> <span class="n">O</span></div>


<div class="viewcode-block" id="DynamicsMixin.rate_nonlinear">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.rate_nonlinear">[docs]</a>
    <span class="k">def</span> <span class="nf">rate_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time. Return time differential of the state.</span>

<span class="sd">        Args:</span>
<span class="sd">            t (float): time</span>
<span class="sd">            dt (float): interval to integrate over in time</span>
<span class="sd">            X (np.ndarray): state input</span>
<span class="sd">            U (np.ndarray): control input</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: time differential of the state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        
        <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span> <span class="o">@</span> <span class="n">X</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span> <span class="o">@</span> <span class="n">U</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span>
        <span class="k">return</span> <span class="n">O</span></div>


<div class="viewcode-block" id="DynamicsMixin.nonlinear_output">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.nonlinear_output">[docs]</a>
    <span class="k">def</span> <span class="nf">nonlinear_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time. Return time differential of the state.</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): interval to integrate over in time</span>
<span class="sd">            X (np.ndarray): state input</span>
<span class="sd">            U (np.ndarray): control input</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: time differential of the state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        
        <span class="n">O</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_C</span><span class="p">)</span><span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_C</span> <span class="o">@</span> <span class="n">X</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_D</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_D</span> <span class="o">@</span> <span class="n">U</span>

        <span class="k">if</span> <span class="n">valid_mtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_K</span><span class="p">):</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">O</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_K</span>
        <span class="k">return</span> <span class="n">O</span></div>


<div class="viewcode-block" id="DynamicsMixin.set_time">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.set_time">[docs]</a>
    <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">subcomponents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sets the time of the system and context&quot;&quot;&quot;</span>
        <span class="k">pass</span>        
        <span class="c1">#set components</span>
        <span class="c1">#if subcomponents:</span>
        <span class="c1">#    for cdyn_name, comp in self.comp_times.items():</span>
        <span class="c1">#        comp.set_value(t)</span>

        <span class="c1"># if system: #set system time only</span>
        <span class="c1">#     self.time = t</span>


    <span class="c1">#@instance_cached #TODO: cache on solver due to changes of components</span>
    <span class="c1">#def comp_times(self) -&gt; dict:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns a dictionary of time references to components which will be set to the current time&quot;&quot;&quot;</span></div>

        <span class="c1"># return {k: Ref(comp,&#39;time&#39;,False,True) for k,l,comp in self.go_through_configurations() if isinstance(comp,DynamicsMixin)}</span>

    <span class="c1"># optimized convience funcitons</span>
<div class="viewcode-block" id="DynamicsMixin.nonlinear_step">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.nonlinear_step">[docs]</a>
    <span class="k">def</span> <span class="nf">nonlinear_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_Y</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimal nonlinear steps&quot;&quot;&quot;</span>
        <span class="c1">#self.time = t #important for simulation, moved to context.integrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        
        <span class="n">dXdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_nonlinear</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_output</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_Y</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Yt_ref</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">dXdt</span></div>


<div class="viewcode-block" id="DynamicsMixin.linear_step">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.linear_step">[docs]</a>
    <span class="k">def</span> <span class="nf">linear_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_Y</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimal nonlinear steps&quot;&quot;&quot;</span>
        <span class="c1">#self.time = t #important for simulation, moved to context.integrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">dXdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_linear</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_output</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_Y</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Yt_ref</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">dXdt</span></div>


    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_Y</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">set_Y</span><span class="o">=</span><span class="n">set_Y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">set_Y</span><span class="o">=</span><span class="n">set_Y</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update dynamics failed </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">! A:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span><span class="si">}</span><span class="s1"> B:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span><span class="si">}</span><span class="s1"> C:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_C</span><span class="si">}</span><span class="s1"> D:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_D</span><span class="si">}</span><span class="s1"> F:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span><span class="si">}</span><span class="s1"> K:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_K</span><span class="si">}</span><span class="s1">| time:</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> X:</span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s1"> U:</span><span class="si">{</span><span class="n">U</span><span class="si">}</span><span class="s1"> setY:</span><span class="si">{</span><span class="n">set_Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="c1">#Solver Refs</span>
    <span class="c1">#TODO: move to problem context</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Xt_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alias for state values&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Yt_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alias for output values&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_output_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ut_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alias for input values&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dXtdt_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a dictionary of state var rates&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_dXdt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@solver_cached</span>
    <span class="k">def</span> <span class="nf">cache_dXdt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;caches the time differential of the state,</span>
<span class="sd">        uses current state of X and U to determine the dXdt</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#we need to check the active session to determine if we should refresh the problem matrix</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ProblemExec</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">):</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">ProblemExec</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">dynamic_solve</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dynamic</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">dxdt</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#integration update is handeled, all others are some kind of SS.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_dynamic_matricies</span><span class="p">()</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;last_context&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="s1">&#39;_time&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s2">&quot;_last_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">lt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cache dXdt </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">| </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">step</span>

<div class="viewcode-block" id="DynamicsMixin.ref_dXdt">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.ref_dXdt">[docs]</a>
    <span class="k">def</span> <span class="nf">ref_dXdt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the reference to the time differential of the state&quot;&quot;&quot;</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state_vars</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not in state vars&quot;</span>
        <span class="n">inx</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">accss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sys</span><span class="p">,</span><span class="n">prob</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dXdt</span><span class="p">[</span><span class="n">inx</span><span class="p">]</span>
        <span class="n">accss</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref_dXdt_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accss</span><span class="p">)</span></div>

    

<div class="viewcode-block" id="DynamicsMixin.determine_nearest_stationary_state">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.DynamicsMixin.html#engforge.dynamics.DynamicsMixin.determine_nearest_stationary_state">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_nearest_stationary_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;determine the nearest stationary state&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span>
        <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
            <span class="n">Mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_B</span> <span class="o">@</span> <span class="n">U</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">Mx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_F</span> <span class="o">+</span> <span class="n">Mb</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_A</span><span class="p">,</span> <span class="o">-</span><span class="n">Mx</span><span class="p">)</span>

        <span class="c1"># static state</span>
        <span class="n">Mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_B</span> <span class="o">@</span> <span class="n">U</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_input_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">Mx</span> <span class="o">=</span> <span class="n">Mb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_F</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_A</span><span class="p">,</span> <span class="o">-</span><span class="n">Mx</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>



<div class="viewcode-block" id="GlobalDynamics">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.GlobalDynamics.html#engforge.dynamics.GlobalDynamics">[docs]</a>
<span class="nd">@forge</span>
<span class="k">class</span> <span class="nc">GlobalDynamics</span><span class="p">(</span><span class="n">DynamicsMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This object is inherited by configurations that collect other dynamicMixins and orchestrates their simulation, and steady state analysis</span>

<span class="sd">    #TODO: establish bounds in solver</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GlobalDynamics.setup_global_dynamics">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.GlobalDynamics.html#engforge.dynamics.GlobalDynamics.setup_global_dynamics">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_global_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;recursively creates numeric matricies for the simulation&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">skey</span><span class="p">,</span><span class="n">lvl</span><span class="p">,</span><span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_through_configurations</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="n">DynamicsMixin</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conf</span><span class="o">.</span><span class="n">is_dynamic</span><span class="p">:</span>
                <span class="n">conf</span><span class="o">.</span><span class="n">create_dynamic_matricies</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    

<div class="viewcode-block" id="GlobalDynamics.sim_matrix">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.GlobalDynamics.html#engforge.dynamics.GlobalDynamics.sim_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">sim_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sys_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;simulate the system over the course of time.</span>
<span class="sd">        return a dictionary of dataframes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#from engforge.solver import SolveableMixin</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;endtime&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ProblemExec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kwargs</span><span class="p">,</span><span class="n">level_name</span><span class="o">=</span><span class="s1">&#39;simmtx&#39;</span><span class="p">,</span><span class="n">dxdt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">copy_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbx</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SolveableMixin</span><span class="p">):</span>
                <span class="c1">#adapt simulate to use the solver            </span>
                <span class="n">sim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Xo</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
                    <span class="n">dt</span><span class="p">,</span> <span class="n">endtime</span><span class="p">,</span><span class="n">Xo</span><span class="p">,</span> <span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span> <span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">,</span>  <span class="o">**</span><span class="n">kw</span>
                <span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_input_matrix</span><span class="p">(</span>
                    <span class="n">sim</span><span class="p">,</span>
                    <span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span>
                    <span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">,</span>
                    <span class="n">return_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">endtime</span><span class="p">,</span> <span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span> <span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="c1">#TODO: swap between vars and constraints depending on dxdt=True</span>
<div class="viewcode-block" id="GlobalDynamics.simulate">
<a class="viewcode-back" href="../../_autosummary/engforge.dynamics.GlobalDynamics.html#engforge.dynamics.GlobalDynamics.simulate">[docs]</a>
    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">,</span>
        <span class="n">endtime</span><span class="p">,</span>
        <span class="n">X0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sys_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_system</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">debug_fail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;runs a simulation over the course of time, and returns a dataframe of the results.</span>

<span class="sd">        A copy of this system is made, and the simulation is run on the copy, so as to not affect the state of the original system.</span>

<span class="sd">        #TODO: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_kw_dflt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">}</span>
        <span class="c1">#&#39;tol&#39;:1e-6,&#39;options&#39;:{&#39;maxiter&#39;:100}}</span>
        <span class="c1"># min_kw_dflt = {&#39;doset&#39;:True,&#39;reset&#39;:False,&#39;fail&#39;:True}</span>
        <span class="k">if</span> <span class="n">min_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_kw</span> <span class="o">=</span> <span class="n">min_kw_dflt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_kw_dflt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">min_kw</span><span class="p">)</span>
        <span class="n">mkw</span> <span class="o">=</span> <span class="n">min_kw_dflt</span>

        <span class="c1">#force transient</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dxdt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#variables if failed</span>
        <span class="n">pbx</span><span class="p">,</span><span class="n">system</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1">#Time Iteration Context</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">ProblemExec</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">kwargs</span><span class="p">,</span><span class="n">level_name</span><span class="o">=</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span><span class="n">dxdt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">copy_system</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">run_solver</span><span class="o">=</span><span class="n">run_solver</span><span class="p">,</span><span class="n">post_callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sim_ans</span> <span class="o">=</span> <span class="n">pbx</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">endtime</span><span class="o">=</span><span class="n">endtime</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span><span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span><span class="n">eval_kw</span><span class="o">=</span><span class="n">eval_kw</span><span class="p">,</span><span class="n">sys_kw</span><span class="o">=</span><span class="n">sys_kw</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">system</span> <span class="o">=</span> <span class="n">pbx</span><span class="o">.</span><span class="n">system</span> <span class="c1">#hello copy</span>

                <span class="c1">#data = [{&quot;time&quot;: k, **v} for k, v in  pbx.data.items()]</span>

                <span class="c1">#this will affect the context copy, not self</span>
                <span class="n">pbx</span><span class="o">.</span><span class="n">exit_to_level</span><span class="p">(</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> 

            <span class="c1"># convert to list with time</span>
            <span class="c1">#df = pandas.DataFrame(data)</span>
            <span class="c1">#self.format_columns(df)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pbx</span><span class="o">.</span><span class="n">dataframe</span>

            <span class="c1">#TODO: move to context</span>
            <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">system</span><span class="p">,(</span><span class="n">data</span> <span class="k">if</span> <span class="n">return_data</span> <span class="k">else</span> <span class="n">df</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_system</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">system</span>        
            <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>        
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;simulation failed, return (sys,prob)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_fail</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">system</span><span class="p">,</span><span class="n">pbx</span>
            <span class="k">raise</span> <span class="n">e</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>