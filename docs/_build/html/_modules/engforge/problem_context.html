<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engforge.problem_context &mdash; engforge 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/readthedocs-custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            engforge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/test.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/engforge.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">engforge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">engforge.problem_context</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engforge.problem_context</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The ProblemExec provides a uniform set of options for managing the state of the system and its solvables, establishing the selection of combos or de/active attributes to Solvables. Once once created any further entracnces to ProblemExec will return the same instance until finally the last exit is called. </span>

<span class="sd">The ProblemExec class allows entrance to a its context to the same instance until finally the last exit is called. The first entrance to the context will create the instance, each subsequent entrance will return the same instance. The ProblemExec arguments are set the first time and remove keyword arguments from the input dictionary (passed as a dict ie stateful) to subsequent methods. </span>
<span class="sd">This isn&#39;t technically a singleton pattern, but it does provide a similar interface. Instead mutliple problem instances will be clones of the first instance, with the optional difference of input/output/event criteria. The first instance will be returned by each context entry, so for that reason it may always appear to have same instance, however each instance is unique in a recusive setting so it may record its own state and be reverted to its own state as per the options defined.</span>

<span class="sd">#TODO: allow update of kwargs on re-entrance</span>

<span class="sd">## Example:</span>
<span class="sd">.. code-block:: python</span>

<span class="sd">    #Application code (arguments passed in kw)</span>
<span class="sd">    with ProblemExec(sys,combos=&#39;default&#39;,slv_vars&#39;*&#39;,**kw) as pe:</span>
<span class="sd">        pe._sys_refs #get the references and compiled problem</span>
<span class="sd">        for i in range(10):</span>
<span class="sd">            pe.solve_min(pe.Xref,pe.Yref,**other_args)</span>
<span class="sd">            pe.set_checkpoint() #save the state of the system </span>
<span class="sd">            self.save_data()</span>
<span class="sd">            </span>

<span class="sd">    #Solver Module (can use without knowledge of the runtime system)</span>
<span class="sd">    with ProblemExec(sys,{},Xnew=Xnext,ctx_fail_new=True) as pe:</span>
<span class="sd">        #do revertable math on the state of the system without concern for the state of the system</span>
<span class="sd">...</span>

<span class="sd"># Combos Selection</span>
<span class="sd">By default no arguments run will select all active items with combo=&quot;default&quot;. The `combos` argument can be used to select a specific set of combos, a outer select. From this set, the `ign_combos` and `only_combos` arguments can be used to ignore or select specific combos based on exclusion or inclusion respectively.</span>

<span class="sd"># Parameter Name Selection</span>
<span class="sd">The `slv_vars` argument can be used to select a specific set of solvables. From this set, the `ign_vars` and `only_vars` arguments can be used to ignore or select specific solvables based on exclusion or inclusion respectively. The `add_vars` argument can be used to add a specific set of solvables to the solver.</span>

<span class="sd"># Active Mode Handiling</span>
<span class="sd">The `only_active` argument can be used to select only active items. The `activate` and `deactivate` arguments can be used to activate or deactivate specific solvables.</span>

<span class="sd">`add_obj` can be used to add an objective to the solver. </span>

<span class="sd"># Exit Mode Handling</span>

<span class="sd">The ProblemExec supports the following exit mode handling vars:</span>

<span class="sd">- `fail_revert`: Whether to raise an error if no solvables are selected. Default is True.</span>
<span class="sd">- `revert_last`: Whether to revert the last change. Default is True.</span>
<span class="sd">- `revert_every`: Whether to revert every change. Default is True.</span>
<span class="sd">- `exit_on_failure`: Whether to exit on first failure. Default is True.</span>

<span class="sd">These vars control the behavior of the ProblemExec when an error occurs or when no solvables are selected.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#TODO: define the </span>

<span class="kn">from</span> <span class="nn">engforge.logging</span> <span class="kn">import</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span> <span class="nn">engforge.system_reference</span> <span class="kn">import</span> <span class="n">Ref</span>
<span class="kn">from</span> <span class="nn">engforge.dataframe</span> <span class="kn">import</span> <span class="n">DataframeMixin</span><span class="p">,</span><span class="n">pandas</span>
<span class="kn">from</span> <span class="nn">engforge.solver_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">engforge.env_var</span> <span class="kn">import</span> <span class="n">EnvVariable</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">solve_ivp</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">expiringdict</span>
<span class="kn">import</span> <span class="nn">attr</span><span class="o">,</span> <span class="nn">attrs</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<div class="viewcode-block" id="ProbLog">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProbLog.html#engforge.problem_context.ProbLog">[docs]</a>
<span class="k">class</span> <span class="nc">ProbLog</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">):</span> <span class="k">pass</span></div>

<span class="n">log</span> <span class="o">=</span> <span class="n">ProbLog</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1">#TODO: implement add_vars feature, ie it creates a solver variable, or activates one if it doesn&#39;t exist from in system.heirarchy.format</span>
<span class="c1">#TODO: define the dataframe / data storage feature</span>

<span class="n">min_opt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;finite_diff_rel_step&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">10000</span><span class="p">}</span>
<span class="n">min_kw_dflt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tol&quot;</span><span class="p">:</span><span class="mf">1e-10</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span><span class="s1">&#39;jac&#39;</span><span class="p">:</span><span class="s1">&#39;cs&#39;</span><span class="p">,</span> <span class="s1">&#39;hess&#39;</span><span class="p">:</span><span class="s1">&#39;cs&#39;</span><span class="p">,</span><span class="s1">&#39;options&#39;</span><span class="p">:</span><span class="n">min_opt</span><span class="p">}</span>


<span class="c1">#The KW Defaults for Solver via kw_dict</span>
<span class="c1"># IMPORTANT:!!! these group parameter names by behavior, they are as important as the following class, add/remove variables with caution</span>
<span class="c1">#these choices affect how solver-items are selected and added to the solver</span>
<span class="n">slv_dflt_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">combos</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span><span class="n">ign_combos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">only_combos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">add_obj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">slv_vars</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">add_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ign_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">only_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">activate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">deactivate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dxdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">both_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1">#KW Defaults for the local context (what saves state for contexts / reverts ect)</span>
<span class="n">dflt_parse_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fail_revert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">revert_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">revert_every</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exit_on_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pre_exec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">post_exec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">opt_fail</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">level_name</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">post_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">success_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">copy_system</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">run_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">save_mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">x_start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">save_on_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">enter_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#can be found on session._&lt;parm&gt; or session.&lt;parm&gt;</span>
<span class="n">root_defined</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="n">last_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">update_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">post_update_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sys_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slv_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">minimizer_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dxdt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">run_start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">run_end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">run_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">all_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">num_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">converged</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comp_changed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">save_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span><span class="s1">&#39;nums&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span>
<span class="n">transfer_kw</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="s1">&#39;_dxdt&#39;</span><span class="p">]</span>

<span class="n">root_possible</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_defined</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">root_defined</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1">#TODO: output options extend_dataframe=True,return_dataframe=True,condensed_dataframe=True,return_system=True,return_problem=True,return_df=True,return_data=True</span>
<span class="c1">#TODO: connect save_data() output to _data table.</span>
<span class="c1">#TODO: move dataframe mixin here, system should return a dataframe, and the problem should be able to save data to the dataframe, call this class Problem(). With default behavior it could seem like a normal dataframe is returned on problem.return(*state,exit,revert...)</span>

<span class="c1">#Special exception classes handled in exit</span>
<div class="viewcode-block" id="IllegalArgument">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.IllegalArgument.html#engforge.problem_context.IllegalArgument">[docs]</a>
<span class="k">class</span> <span class="nc">IllegalArgument</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an exception to exit the problem context as specified&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ProblemExit">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExit.html#engforge.problem_context.ProblemExit">[docs]</a>
<span class="k">class</span> <span class="nc">ProblemExit</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an exception to exit the problem context, without error&quot;&quot;&quot;</span>
    <span class="n">revert</span><span class="p">:</span><span class="nb">bool</span>
    <span class="n">prob</span><span class="p">:</span><span class="s2">&quot;ProblemExec&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prob</span><span class="p">:</span><span class="s2">&quot;ProblemExec&quot;</span><span class="p">,</span><span class="n">revert</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revert</span> <span class="o">=</span> <span class="n">revert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ProblemExit[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="si">}</span><span class="s1">|rvt=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revert</span><span class="si">}</span><span class="s1">]&#39;</span>        </div>


<div class="viewcode-block" id="ProblemExitAtLevel">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExitAtLevel.html#engforge.problem_context.ProblemExitAtLevel">[docs]</a>
<span class="k">class</span> <span class="nc">ProblemExitAtLevel</span><span class="p">(</span><span class="n">ProblemExit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an exception to exit the problem context, without error&quot;&quot;&quot;</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prob</span><span class="p">:</span><span class="s2">&quot;ProblemExec&quot;</span><span class="p">,</span><span class="n">level</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">revert</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;level must be defined&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;level must be a string&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revert</span> <span class="o">=</span> <span class="n">revert</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ProblemExit[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="si">}</span><span class="s1">|lvl=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1">|rvt=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revert</span><span class="si">}</span><span class="s1">]&#39;</span></div>



<span class="c1">#TODO: determine when components are updated, and refresh the system references accordingly.</span>
<span class="c1">#TODO: Map attributes/properties by component key and then autofix refs! (this is a big one), no refresh required. Min work</span>
<div class="viewcode-block" id="ProblemExec">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec">[docs]</a>
<span class="k">class</span> <span class="nc">ProblemExec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the execution context for a problem in the system. The ProblemExec class provides a uniform set of options for managing the state of the system and its solvables, establishing the selection of combos or de/active attributes to Solvables. Once once created any further entracnces to ProblemExec will return the same instance until finally the last exit is called.</span>

<span class="sd">    ## params:</span>
<span class="sd">    -  _problem_id: uuid for subproblems, or True for top level, None means uninitialized</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: convert this to a system based cache where there is a unique problem for each system instance. On subprobem copy a system and add o dictionary.</span>
    <span class="n">class_cache</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#ProblemExec is assigned below</span>
    
    <span class="c1">#this class, wide, dont redefine it</span>
    <span class="n">problems_dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>

    <span class="n">system</span><span class="p">:</span> <span class="s2">&quot;System&quot;</span>
    <span class="n">session</span><span class="p">:</span> <span class="s2">&quot;ProblemExec&quot;</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#problem state / per level</span>
    <span class="n">problem_id</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="n">entered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">exited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  

    <span class="c1">#solution control (point to singleton/subproblem via magic getattr)</span>
    <span class="n">_last_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="n">_update_refs</span><span class="p">:</span> <span class="nb">dict</span> 
    <span class="n">_post_update_refs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_sys_refs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_slv_kw</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_minimizer_kw</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_data</span><span class="p">:</span> <span class="nb">list</span> 
    <span class="n">_weights</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">x_start</span><span class="p">:</span><span class="nb">dict</span>
    <span class="n">_dxdt</span><span class="p">:</span><span class="nb">float</span>
    <span class="n">_run_start</span><span class="p">:</span><span class="nb">float</span>
    <span class="n">_run_end</span><span class="p">:</span><span class="nb">float</span>
    <span class="n">_run_time</span><span class="p">:</span><span class="nb">float</span>
    <span class="n">_converged</span><span class="p">:</span><span class="nb">bool</span>
    

    <span class="c1">#Interior Context Options</span>
    <span class="n">enter_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">save_on_exit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">save_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">level_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#target this context with the level name</span>
    <span class="n">level_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#TODO: keep track of level on the global context  </span>
    <span class="n">pre_exec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">post_exec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fail_revert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">revert_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">revert_every</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exit_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">opt_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">raise_on_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">copy_system</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">success_thresh</span> <span class="o">=</span> <span class="mf">1E6</span> <span class="c1">#if system has `success_thresh` it will be assigned to the context</span>
    <span class="n">post_callback</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="kc">None</span><span class="c1">#callback that will be called on the system each time it is reverted, it should take args(system,current_problem_exec)</span>
    <span class="n">run_solver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#for transient #i would love this to be=true, but there&#39;s just too much possible variation in application to make it so without some kind of control / continuity strategy. Dynamics are natural responses anyways, so solver use should be an advanced case for now (MPC/Filtering/ect later)</span>

    


    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;This is a special method that is called when an attribute is not found in the usual places, like when interior contexts (anything not the root (session_id=True)) are created that dont have the top level&#39;s attributes. some attributes will look to the parent session&#39;&#39;&#39;</span>

        <span class="c1">#interior context lookup (when in active context, ie session exists)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">root_possible</span><span class="p">:</span>
            <span class="c1">#revert to the parent session</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="c1">#self.info(f&#39;get parent private {name}&#39;)</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">root_defined</span><span class="p">:</span>
                <span class="c1">#self.info(f&#39;get parent public {name}&#39;)</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">root_defined</span><span class="p">:</span> <span class="c1">#public interface</span>
            <span class="c1">#self.info(f&#39;get root fallback {name}&#39;)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Default behaviour</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">system</span><span class="p">,</span><span class="n">kw_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xnew</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ctx_fail_new</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">opts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ProblemExec.</span>
<span class="sd">        </span>
<span class="sd">        #TODO: exit system should abide by update / signals options</span>

<span class="sd">        #TODO: provide data storage options for dataframe / table storage history/ record keeping (ss vs transient data)</span>
<span class="sd">        </span>
<span class="sd">        #TODO: create an option to copy the system and run operations on it, and options for applying the state from the optimized copy to the original system</span>

<span class="sd">        :param system: The system to be executed.</span>
<span class="sd">        :param Xnew: The new state of the system to set wrt. reversion, optional</span>
<span class="sd">        :param ctx_fail_new: Whether to raise an error if no execution context is available, use in utility methods ect. Default is False.</span>
<span class="sd">        :param kw_dict: A keyword argument dictionary to be parsed for solver options, and removed from the outer context. Changes are made to this dictionary, so they are removed automatically from the outer context, and thus no longer passed to interior vars.</span>
<span class="sd">        :param dxdt: The dynamics integration method. Default is None meaning that dynamic vars are not considered for minimization unless otherwise specified. Steady State can be specified by dxdt=0 all dynamic vars are considered as solver variables, with the constraint that their rate of change is zero. If a dictionary is passed then the dynamic vars are considered as solver variables, with the constraint that their rate of change is equal to the value in the dictionary, and all other unspecified rates are zero (steady).</span>

<span class="sd">        #### Solver Selection Options</span>
<span class="sd">        :param combos: The selection of combos. Default is &#39;*&#39; (select all).</span>
<span class="sd">        :param  ign_combos: The combos to be ignored.</span>
<span class="sd">        :param  only_combos: The combos to be selected.</span>
<span class="sd">        :param  add_obj: Whether to add an objective to the solver. Default is True.</span>
<span class="sd">        :param  slv_vars: The selection of solvables. Default is &#39;*&#39; (select all).</span>
<span class="sd">        :param  add_vars: The solvables to be added to the solver.</span>
<span class="sd">        :param  ign_vars: The solvables to be ignored.</span>
<span class="sd">        :param  only_vars: The solvables to be selected.</span>
<span class="sd">        :param  only_active: Whether to select only active items. Default is True.</span>
<span class="sd">        :param  activate: The solvables to be activated.</span>
<span class="sd">        :param  deactivate: The solvables to be deactivated.</span>
<span class="sd">        :param  fail_revert: Whether to raise an error if no solvables are selected. Default is True.</span>
<span class="sd">        :param  revert_last: Whether to revert the last change. Default is True.</span>
<span class="sd">        :param  revert_every: Whether to revert every change. Default is True.</span>
<span class="sd">        :param  exit_on_failure: Whether to exit on failure, or continue on. Default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_updated</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#it is known</span>

        <span class="k">if</span> <span class="n">kw_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#kw_dict is stateful so you can mix system &amp; context args together, and ensure context args are removed. in the case this is unused, we&#39;ll create an empty dict to avoid errors</span>
            <span class="n">kw_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1">#storage optoins</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;persist&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;persist&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persist_contexts</span><span class="p">()</span>

        <span class="c1"># temp solver storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_hist</span> <span class="o">=</span> <span class="n">expiringdict</span><span class="o">.</span><span class="n">ExpiringDict</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>  

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;subctx</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">|  keywords: </span><span class="si">{</span><span class="n">kw_dict</span><span class="si">}</span><span class="s1"> and misc: </span><span class="si">{</span><span class="n">opts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;context| keywords: </span><span class="si">{</span><span class="n">kw_dict</span><span class="si">}</span><span class="s1"> and misc: </span><span class="si">{</span><span class="n">opts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#special cases for parsing</span>
        <span class="c1">#parse the options to change behavior of the context</span>
        <span class="n">level_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">and</span> <span class="s1">&#39;level_name&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">level_name</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;level_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kw_dict</span> <span class="ow">and</span> <span class="s1">&#39;level_name&#39;</span> <span class="ow">in</span> <span class="n">kw_dict</span><span class="p">:</span>
            <span class="n">level_name</span> <span class="o">=</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;level_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1">#solver min-args wrt defaults</span>
        <span class="n">min_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">and</span> <span class="s1">&#39;min_kw&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span> 
            <span class="n">min_kw</span> <span class="o">=</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_kw&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kw_dict</span> <span class="ow">and</span> <span class="s1">&#39;min_kw&#39;</span> <span class="ow">in</span> <span class="n">kw_dict</span><span class="p">:</span>
            <span class="n">min_kw</span> <span class="o">=</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_kw&#39;</span><span class="p">)</span>

        
        <span class="n">mkw</span> <span class="o">=</span><span class="n">min_kw_dflt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">min_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_kw</span> <span class="o">=</span> <span class="n">mkw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">min_kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_kw</span> <span class="o">=</span> <span class="n">mkw</span>

        <span class="c1">#Merge kwdict(stateful) and opts (current level)</span>
        <span class="c1">#solver vars should be static for a problem and subcontexts, however the default vars can change. Subproblems allow for the solver vars to be changed on its creation.</span>
        <span class="n">opt_in</span><span class="p">,</span><span class="n">opt_out</span> <span class="o">=</span> <span class="p">{},{}</span>
        <span class="k">if</span> <span class="n">opts</span><span class="p">:</span>
            <span class="c1">#these go to the context instance optoins</span>
            <span class="n">opt_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dflt_parse_kw</span><span class="p">}</span>
            <span class="c1">#these go to system establishment</span>
            <span class="n">opt_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt_in</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">kw_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kw_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#these go to the context instance optoins</span>
            <span class="n">kw_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dflt_parse_kw</span><span class="p">}</span>
            <span class="n">opt_in</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw_in</span><span class="p">)</span>
            <span class="n">kw_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt_in</span><span class="p">}</span>
            <span class="c1">#these go to system establishment</span>
            <span class="n">opt_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw_out</span><span class="p">)</span>
            <span class="c1">#remove problem options from dict (otherwise passed along to system!)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw_in</span><span class="p">:</span>
                <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>


        <span class="c1">#Define the handiling of rate integrals</span>
        <span class="k">if</span> <span class="s1">&#39;dxdt&#39;</span> <span class="ow">in</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;dxdt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dxdt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;dxdt&#39;</span> <span class="ow">in</span> <span class="n">kw_dict</span> <span class="ow">and</span> <span class="n">kw_dict</span><span class="p">[</span><span class="s1">&#39;dxdt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">kw_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dxdt&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dxdt</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#by default dont consider dynamics</span>

        <span class="k">if</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dxdt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># dxdt is a dictionary</span>
                <span class="c1">#provide a set of values or function to have the solver solve for</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IllegalArgument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bad dxdt value </span><span class="si">{</span><span class="n">dxdt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">):</span>                        
            <span class="c1">#mirror the state of session (exactly)</span>
            <span class="n">copy_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dflt_parse_kw</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transfer_kw</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy_vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span> <span class="c1">#carry that weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_prob_levels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="c1">#error if the system is different (it shouldn&#39;t be!)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">system</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IllegalArgument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;somethings wrong! change of comp! </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1">#modify things from the input</span>
            <span class="k">if</span> <span class="n">level_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#your new id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span> <span class="o">=</span> <span class="s1">&#39;ctx_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span> <span class="o">=</span> <span class="n">level_name</span>

            <span class="k">if</span> <span class="n">opt_in</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opt_in</span><span class="p">)</span> <span class="c1">#level options ASAP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="n">Xnew</span> <span class="c1">#input state exception to this</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting execution context with </span><span class="si">{</span><span class="n">opt_in</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">opt_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1">#each state request to be reverted, then we need to store the state of each execution context overriding the outer context x_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_checkpoint</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">ctx_fail_new</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalArgument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no execution context available&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#add the prob options to the context</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opt_in</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#this is the top level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span> <span class="c1">#carry that weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prob_levels</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="o">=</span> <span class="n">dxdt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_data</span><span class="p">()</span>

            <span class="c1">#supply the level name default as top if not set</span>
            <span class="k">if</span> <span class="n">level_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span> <span class="o">=</span> <span class="n">level_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="n">Xnew</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">establish_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">kw_dict</span><span class="o">=</span><span class="n">kw_dict</span><span class="p">,</span><span class="o">**</span><span class="n">opt_out</span><span class="p">)</span>                  

            <span class="c1">#Finally we record where we started!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_checkpoint</span><span class="p">()</span>       

        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;new execution context for </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">opts</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;new execution context for </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ProblemExec.reset_data">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.reset_data">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;reset the data storage&#39;&#39;&#39;</span>
        <span class="c1">#the data storage!!</span>
        <span class="c1">#TODO: add buffer type, or disk cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#index:row_dict </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># works for time or index</span></div>



<div class="viewcode-block" id="ProblemExec.establish_system">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.establish_system">[docs]</a>
    <span class="k">def</span> <span class="nf">establish_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">system</span><span class="p">,</span><span class="n">kw_dict</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;caches the system references, and parses the system arguments&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.solver</span> <span class="kn">import</span> <span class="n">SolverMixin</span>
        <span class="kn">from</span> <span class="nn">engforge.system</span> <span class="kn">import</span> <span class="n">System</span> 
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_system</span><span class="p">:</span>
            <span class="n">system</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">copy_config_at_state</span><span class="p">()</span>

        <span class="c1">#place me here after system has been modified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="c1">#cache as much as possible before running the problem (stitch in time saves 9 or whatever)</span>


        <span class="c1">#pass args without creating singleton (yet)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;establish </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">kw_dict</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">SolverMixin</span><span class="p">),</span> <span class="s1">&#39;only solveable interfaces are supported for execution context&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_last_context</span> <span class="o">=</span> <span class="bp">self</span> <span class="c1">#set the last context to this one</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="s1">&#39;success_thresh&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">success_thresh</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">success_thresh</span>
        <span class="c1">#Extract solver vars and set them on this object, they will be distributed to any new further execution context&#39;s via monkey patch above</span>
        <span class="n">in_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_kws</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span><span class="n">slv_dflt_options</span><span class="p">,</span><span class="n">use_defaults</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_kws</span><span class="p">(</span><span class="n">kw_dict</span><span class="p">,</span><span class="n">slv_dflt_options</span><span class="p">,</span><span class="n">rmv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">in_kw</span><span class="p">)</span> <span class="c1">#update with input!</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_references</span><span class="p">()</span>

        <span class="c1">#Get solver weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#Grab inputs and set to system</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dflt_parse_kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;established sys context: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  </div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;caches the property for the session&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;inst_sesh&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst_sesh</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sesh</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sesh</span>

<div class="viewcode-block" id="ProblemExec.get_sesh">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.get_sesh">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get the session&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">sesh</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sesh</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">inst_sesh</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="c1">#Update Methods</span>
<div class="viewcode-block" id="ProblemExec.refresh_references">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.refresh_references">[docs]</a>
    <span class="k">def</span> <span class="nf">refresh_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;refresh the system references&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;refreshing system references&#39;</span><span class="p">)</span>
        <span class="n">check_dynamics</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">check_dynamics</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">_num_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">system_references</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">solver_vars</span><span class="p">(</span><span class="n">check_dynamics</span><span class="o">=</span><span class="n">check_dynamics</span><span class="p">,</span><span class="n">addable</span><span class="o">=</span><span class="n">sesh</span><span class="o">.</span><span class="n">_num_refs</span><span class="p">,</span><span class="o">**</span><span class="n">sesh</span><span class="o">.</span><span class="n">_slv_kw</span><span class="p">)</span>
        
        <span class="n">sesh</span><span class="o">.</span><span class="n">update_methods</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">min_refresh</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span></div>

                

    <span class="k">def</span> <span class="nf">update_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Get the update method refs</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="n">sesh</span> <span class="k">if</span> <span class="n">sesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>

        <span class="n">sesh</span><span class="o">.</span><span class="n">_update_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">collect_update_refs</span><span class="p">()</span>
        <span class="c1">#TODO: find subsystems that are not-subsolvers and execute them</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">_post_update_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">collect_post_update_refs</span><span class="p">()</span>

        <span class="n">sesh</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#apply changes to the dynamics models</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="n">sesh</span> <span class="k">if</span> <span class="n">sesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_comps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;update dynamics&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">setup_global_dynamics</span><span class="p">()</span>            

    <span class="k">def</span> <span class="nf">min_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="n">sesh</span> <span class="k">if</span> <span class="n">sesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;min refresh&#39;</span><span class="p">)</span>

        <span class="c1">#final ref&#39;s after update</span>
        <span class="c1">#after updates</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">_all_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">system_references</span><span class="p">(</span><span class="n">recache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">check_config</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ignore_none_comp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        

        <span class="c1">#Problem Variable Definitions</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">Xref</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_problem_vars</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">Yref</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">sys_solver_objectives</span><span class="p">()</span>
        
        <span class="n">cons</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#TODO: parse additional constraints</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">sys_solver_constraints</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span> 


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">check_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">return</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>

    <span class="c1">#Context Manager Interface</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Set the new state</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entered</span><span class="p">:</span>
            <span class="c1">#TODO: enable env-var STRICT MODE to fail on things like this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;context already entered!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;enter context: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics_updated</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1">#Important managed updates / refs from Xnew input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_temp_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#signals / updates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>            

        <span class="c1">#TODO: create a component-slot ref-update graph, and update the system references accordingly.</span>
        <span class="c1">#TODO: map the signals to the system references, and update the system references accordingly.</span>
        <span class="c1">#TODO: </span>
        <span class="c1">#transients wont update components/ methods dynamically (or shouldn&#39;t) so we can just update the system references once and be done with it for other cases, but that is not necessary unless a component changes or a component has in general a unique reference update system (economics / component-iterators)</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">enter_refresh</span><span class="p">:</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">update_methods</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">min_refresh</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">sesh</span><span class="o">.</span><span class="n">dynamics_updated</span><span class="p">:</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">sesh</span><span class="o">=</span><span class="n">sesh</span><span class="p">)</span>

        <span class="c1">#Check for existing session        </span>
        <span class="k">if</span> <span class="n">sesh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="bp">self</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;entering existing execution context&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;change of execution class!&#39;</span><span class="p">)</span>
            <span class="c1">#global level number</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">level_number</span> <span class="o">+=</span> <span class="mi">1</span>     
            <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_prob_levels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span>
        
        <span class="c1">#return New</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">level_number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;creating execution context for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slv_kw</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">refs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1">#define exit action, to handle the error here return True. Otherwise error propigates up to top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exit action </span><span class="si">{</span><span class="n">exc_type</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">exc_value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#Last opprotunity to update the system  at tsate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exec</span><span class="p">:</span>
            <span class="c1">#a component cutsom callback + signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_execute</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_callback</span><span class="p">:</span>
            <span class="c1">#a context custom callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_callback</span><span class="p">()</span>

        <span class="c1">#save state to dataframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_on_exit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>

        <span class="c1">#sesh = self.sesh #this should be here</span>
        <span class="c1">#if self.level_name in sesh._prob_levels:</span>
        <span class="c1">#    sesh._prob_levels.pop(self.level_name)</span>

        <span class="c1">#Exit Scenerio (boolean return important for context manager exit handling in heirarchy)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_value</span><span class="p">,</span><span class="n">ProblemExit</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exit action </span><span class="si">{</span><span class="n">exc_type</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">exc_value</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1">#first things first</span>
            <span class="k">if</span> <span class="n">exc_value</span><span class="o">.</span><span class="n">revert</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revert_to_start</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>

            <span class="n">lvl_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#Decide our exit conditon (if we should exit)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_value</span><span class="p">,</span><span class="n">ProblemExitAtLevel</span><span class="p">):</span>
                <span class="c1">#should we stop?</span>
                <span class="n">lvl_match</span> <span class="o">=</span> <span class="n">exc_value</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span>
                <span class="k">if</span> <span class="n">lvl_match</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exit at level </span><span class="si">{</span><span class="n">exc_value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="kc">True</span>                     
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exit not at level </span><span class="si">{</span><span class="n">exc_value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1">#Check if we missed a level name and its the top level, if so then we raise a real error!</span>
                <span class="c1">#always exit with level_name=&#39;top&#39; at outer context</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">exc_value</span><span class="o">.</span><span class="n">level</span><span class="o">==</span><span class="s1">&#39;top&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exit at top&#39;</span><span class="p">)</span>

                    <span class="n">ext</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#top override</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
                    <span class="c1">#never ever leave the top level without deleting the session</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">level_number</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> 
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cant exit to level! </span><span class="si">{</span><span class="n">exc_value</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1"> not found!!&#39;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">18</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem exit revert=</span><span class="si">{</span><span class="n">exc_value</span><span class="o">.</span><span class="n">revert</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">ext</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#basic exit is one level up</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_context</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ext</span>
        
        <span class="c1">#default exit scenerios</span>
        <span class="k">elif</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_action</span><span class="p">(</span><span class="n">exc_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_action</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ext</span>
        
<div class="viewcode-block" id="ProblemExec.debug_levels">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.debug_levels">[docs]</a>
    <span class="k">def</span> <span class="nf">debug_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;debug the levels of the context&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_prob_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;level: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">x_start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalArgument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no session available&#39;</span><span class="p">)</span></div>

    
    <span class="c1">#Multi Context Exiting:</span>
<div class="viewcode-block" id="ProblemExec.persist_contexts">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.persist_contexts">[docs]</a>
    <span class="k">def</span> <span class="nf">persist_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;convert all contexts to a new storage format&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;persisting contexts!&#39;</span><span class="p">)</span>
        <span class="n">current_problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span> 
        <span class="n">ProblemExec</span><span class="o">.</span><span class="n">problems_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">current_problems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="c1">#you will go on!</span></div>


<div class="viewcode-block" id="ProblemExec.discard_contexts">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.discard_contexts">[docs]</a>
    <span class="k">def</span> <span class="nf">discard_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;discard all contexts&quot;&quot;&quot;</span>
        <span class="n">current_problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span> 
        <span class="n">ProblemExec</span><span class="o">.</span><span class="n">problems_dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">current_problems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ProblemExec</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="c1">#you will go on!             </span></div>


<div class="viewcode-block" id="ProblemExec.reset_contexts">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.reset_contexts">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fail_if_discardmode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;reset all contexts to a new storage format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">ProblemExec</span><span class="o">.</span><span class="n">problems_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">fail_if_discardmode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalArgument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cant reset contexts! </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">problems_dict</span><span class="si">}</span><span class="s1"> while not in persistance mode&#39;</span><span class="p">)</span>       </div>


    <span class="k">def</span> <span class="nf">exit_with_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProblemExit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">revert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">exit_and_revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProblemExit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">revert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exit_to_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">revert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProblemExitAtLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span><span class="n">revert</span><span class="o">=</span><span class="n">revert</span><span class="p">)</span>

<div class="viewcode-block" id="ProblemExec.exit_action">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.exit_action">[docs]</a>
    <span class="k">def</span> <span class="nf">exit_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;handles the exit action wrt system&quot;&quot;&quot;</span>
        <span class="n">EOL</span> <span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_name</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revert_last</span> <span class="ow">and</span> <span class="n">EOL</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revert last!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revert to</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x_start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revert_to_start</span><span class="p">()</span>
            
            <span class="c1">#run execute</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">revert_every</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revert to</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x_start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revert_to_start</span><span class="p">()</span>
            
            <span class="c1">#run execute </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>

        <span class="c1">#TODO: add exit on success option</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="c1">#continue as normal</span></div>


<div class="viewcode-block" id="ProblemExec.error_action">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.error_action">[docs]</a>
    <span class="k">def</span> <span class="nf">error_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;handles the error action wrt to the problem&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; with input: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_revert</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revert_to_start</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;error in execution context&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1">#send me up</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error in execution context: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span> <span class="c1">#our problem will go on</span></div>

    

<div class="viewcode-block" id="ProblemExec.save_data">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.save_data">[docs]</a>
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">add_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;save data to the context&quot;&quot;&quot;</span>
        
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exited</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exec</span><span class="p">:</span>
            <span class="c1">#a context custom callback</span>
                <span class="n">sesh</span><span class="o">.</span><span class="n">post_execute</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sesh</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">anything_changed</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">output_state</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#integration</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_time</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_index</span>

            <span class="k">if</span> <span class="n">add_data</span><span class="p">:</span> <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">add_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_time</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="c1">#if we are integrating, then we dont increment the index</span>
            <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sesh</span><span class="o">.</span><span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1">#reset the data for changed items</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_anything_changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data saved = </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no data saved, nothing changed&#39;</span><span class="p">)</span></div>


    
    <span class="k">def</span> <span class="nf">clean_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;closing execution session&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">level_number</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">session</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="p">,</span><span class="s1">&#39;session&#39;</span><span class="p">):</span>
            <span class="c1">#global level number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_cache</span><span class="o">.</span><span class="n">level_number</span> <span class="o">-=</span> <span class="mi">1</span>  

        <span class="c1">#if we are the top level, then we mark the session runtime/messages</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EXIT[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s2">] run time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">#time context</span>
    <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="n">lt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="n">dt_calc</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">lt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="k">if</span> <span class="n">dt_calc</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dt_calc</span>
        <span class="c1">#self.system.set_time(time) #system times / subcomponents too</span>
        

    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">endtime</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">max_step_dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">X0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1">#Unpack Transient Problem</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">intl_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">integrator_var_refs</span> <span class="c1">#order forms problem basis</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">prv_ingtegral_refs</span> <span class="o">=</span> <span class="n">intl_refs</span> <span class="c1">#for rate function</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span>

        <span class="n">min_kw</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_minimizer_kw</span>
        <span class="k">if</span> <span class="n">min_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">min_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">max_step_dt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dt </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1"> &gt; max_step_dt </span><span class="si">{</span><span class="n">max_step_dt</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">max_step_dt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;simulating </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">sesh</span><span class="si">}</span><span class="s1">| int:</span><span class="si">{</span><span class="n">intl_refs</span><span class="si">}</span><span class="s1"> | refs: </span><span class="si">{</span><span class="n">refs</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>            

        <span class="k">if</span> <span class="ow">not</span> <span class="n">intl_refs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no transient parameters found&#39;</span><span class="p">)</span>            
        
        <span class="n">x_cur</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">sesh</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">intl_refs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;initial state </span><span class="si">{</span><span class="n">X0</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">intl_refs</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">refs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get current</span>
            <span class="n">X0</span> <span class="o">=</span> <span class="n">x_cur</span>
        <span class="c1">#add any missing solver vars existing in the system</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">X0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x_cur</span><span class="p">):</span>
            <span class="n">X0</span> <span class="o">=</span> <span class="n">x_cur</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">X0</span><span class="p">)</span> 
        
        <span class="c1">#this will fail if X0 doesn&#39;t have solver vars!</span>
        <span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X0</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">intl_refs</span><span class="p">])</span>
        <span class="n">Time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">endtime</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="n">rate_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min_kw&#39;</span><span class="p">:</span><span class="n">min_kw</span><span class="p">,</span><span class="s1">&#39;dt&#39;</span><span class="p">:</span><span class="n">dt</span><span class="p">}</span>

        <span class="c1">#get the probelem variables</span>
        <span class="n">Xss</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">problem_opt_vars</span>
        <span class="n">Yobj</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">final_objectives</span>

        <span class="c1">#run the simulation from the current state to the endtime</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">integral_rate</span><span class="p">,</span> <span class="p">[</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">endtime</span><span class="p">],</span> <span class="n">X0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">Time</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="n">max_step_dt</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">Xss</span><span class="p">,</span><span class="n">Yobj</span><span class="p">),</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ans</span>

<div class="viewcode-block" id="ProblemExec.integral_rate">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.integral_rate">[docs]</a>
    <span class="k">def</span> <span class="nf">integral_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span><span class="n">Xss</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Yobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;provides the dynamic rate of the system at time t, and state x&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">intl_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">prv_ingtegral_refs</span> <span class="c1">#cached in self.integral()</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">intl_refs</span><span class="p">}</span>
        <span class="n">Xin</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intl_refs</span><span class="p">)}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sim_iter </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">Xin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ProblemExec</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">level_name</span><span class="o">=</span><span class="s1">&#39;tr_slvr&#39;</span><span class="p">,</span><span class="n">Xnew</span><span class="o">=</span><span class="n">Xin</span><span class="p">,</span><span class="n">revert_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">revert_every</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dxdt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbx</span><span class="p">:</span>
            <span class="c1"># test for record time </span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
            
            <span class="c1">#save data at the start</span>
            <span class="n">pbx</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span> <span class="c1">#TODO: check_enable/ rate_check</span>

            <span class="c1">#ad hoc time integration</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trdct</span> <span class="ow">in</span> <span class="n">pbx</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span><span class="mi">10</span><span class="p">:</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;updating </span><span class="si">{</span><span class="n">trdct</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">trdct</span><span class="o">.</span><span class="n">var_ref</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;-</span><span class="si">{</span><span class="n">trdct</span><span class="o">.</span><span class="n">rate</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">trdct</span><span class="o">.</span><span class="n">current_rate</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">trdct</span><span class="o">.</span><span class="n">rate_ref</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">trdct</span><span class="o">.</span><span class="n">var</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">trdct</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
                        
                <span class="n">out</span><span class="p">[</span><span class="n">trdct</span><span class="o">.</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">trdct</span><span class="o">.</span><span class="n">current_rate</span>

            <span class="c1"># dynamics</span>
            <span class="k">for</span> <span class="n">compnm</span><span class="p">,</span> <span class="n">compdict</span> <span class="ow">in</span> <span class="n">pbx</span><span class="o">.</span><span class="n">dynamic_comps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">compdict</span><span class="c1">#[&quot;comp&quot;]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">dynamic_state_vars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">dynamic_input_vars</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1">#nothing to do...</span>

                <span class="n">Xds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">Xt_ref</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                <span class="n">Uds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">Ut_ref</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                <span class="c1"># time updated in step</span>
                <span class="c1">#system.info(f&#39;comp {comp} {compnm} {Xds} {Uds}&#39;)</span>
                <span class="n">dxdt</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Xds</span><span class="p">,</span> <span class="n">Uds</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">Xt_ref</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">out</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">compnm</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">if</span> <span class="n">compnm</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1">#solvers</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_solver</span>  <span class="ow">and</span> <span class="n">Xss</span> <span class="ow">and</span> <span class="n">Yobj</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveable</span><span class="p">:</span>
                <span class="c1"># TODO: add in any transient</span>
                <span class="k">with</span> <span class="n">ProblemExec</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">level_name</span><span class="o">=</span><span class="s1">&#39;ss_slvr&#39;</span><span class="p">,</span><span class="n">revert_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">revert_every</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dxdt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbx</span><span class="p">:</span>

                    <span class="n">ss_out</span> <span class="o">=</span> <span class="n">pbx</span><span class="o">.</span><span class="n">solve_min</span><span class="p">(</span><span class="n">Xss</span><span class="p">,</span> <span class="n">Yobj</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ss_out</span><span class="p">[</span><span class="s1">&#39;ans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exiting solver </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ss_out</span><span class="p">[</span><span class="s2">&quot;Xans&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ss_out</span><span class="p">[</span><span class="s2">&quot;Xstart&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>             
                        <span class="n">pbx</span><span class="o">.</span><span class="n">set_ref_values</span><span class="p">(</span><span class="n">ss_out</span><span class="p">[</span><span class="s1">&#39;Xans&#39;</span><span class="p">])</span>
                        <span class="n">pbx</span><span class="o">.</span><span class="n">exit_to_level</span><span class="p">(</span><span class="s1">&#39;ss_slvr&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;solver failed to converge </span><span class="si">{</span><span class="n">ss_out</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ss_out</span><span class="p">[</span><span class="s2">&quot;Xans&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ss_out</span><span class="p">[</span><span class="s2">&quot;X0&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pbx</span><span class="o">.</span><span class="n">opt_fail</span><span class="p">:</span>
                            <span class="n">pbx</span><span class="o">.</span><span class="n">exit_to_level</span><span class="p">(</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span><span class="n">pbx</span><span class="o">.</span><span class="n">fail_revert</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pbx</span><span class="o">.</span><span class="n">exit_to_level</span><span class="p">(</span><span class="s1">&#39;ss_slvr&#39;</span><span class="p">,</span><span class="n">pbx</span><span class="o">.</span><span class="n">fail_revert</span><span class="p">)</span>

            <span class="n">V_dxdt</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">out</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">intl_refs</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;exiting transient </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">V_dxdt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">Xin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pbx</span><span class="o">.</span><span class="n">exit_to_level</span><span class="p">(</span><span class="s1">&#39;tr_slvr&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">V_dxdt</span><span class="p">)</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;solver got infeasible: </span><span class="si">{</span><span class="n">V_dxdt</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">Xin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pbx</span><span class="o">.</span><span class="n">exit_and_revert</span><span class="p">()</span>
            <span class="c1">#TODO: handle this better, seems to cause a warning</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;infeasible! nan result </span><span class="si">{</span><span class="n">V_dxdt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">Xin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rate </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&lt;-</span><span class="si">{</span><span class="n">V_dxdt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">Xin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">V_dxdt</span></div>


<div class="viewcode-block" id="ProblemExec.solve_min">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.solve_min">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_min</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span><span class="n">Xref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Yref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the minimization problem using the given vars and constraints. And sets the system state to the solution depending on input of the following:</span>

<span class="sd">        Solve the root problem using the given vars.</span>
<span class="sd">        :param Xref: The reference input values.</span>
<span class="sd">        :param Yref: The reference objective values to minimize.</span>
<span class="sd">        :param output: The output dictionary to store the results. (default: None)</span>
<span class="sd">        :param fail: Flag indicating whether to raise an exception if the solver doesn&#39;t converge. (default: True)</span>
<span class="sd">        :param kw: Additional keyword arguments.</span>
<span class="sd">        :return: The output dictionary containing the results.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="n">Xref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Xref</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">Xref</span>

        <span class="k">if</span> <span class="n">Yref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Yref</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">final_objectives</span>

        <span class="n">thresh</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;thresh&quot;</span><span class="p">,</span> <span class="n">sesh</span><span class="o">.</span><span class="n">success_thresh</span><span class="p">)</span>

        <span class="c1">#TODO: options for solver detail in response</span>
        <span class="n">dflt</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Xstart&quot;</span><span class="p">:</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_get</span><span class="p">(</span><span class="n">Xref</span><span class="p">,</span><span class="n">sys</span><span class="o">=</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">prob</span><span class="o">=</span><span class="n">sesh</span><span class="p">),</span>
                <span class="s2">&quot;Ystart&quot;</span><span class="p">:</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_get</span><span class="p">(</span><span class="n">Yref</span><span class="p">,</span><span class="n">sys</span><span class="o">=</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">prob</span><span class="o">=</span><span class="n">sesh</span><span class="p">),</span>
                <span class="s2">&quot;Xans&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Xans&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Yobj&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Ycon&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ans&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;weights&quot;</span><span class="p">:</span><span class="n">sesh</span><span class="o">.</span><span class="n">_weights</span><span class="p">,</span>
                <span class="s2">&quot;constraints&quot;</span><span class="p">:</span><span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">dflt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">dflt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">dflt</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no variables found for solver: </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#None for `ans` will not trigger optimization failure        </span>
            <span class="k">return</span> <span class="n">output</span>
        
        <span class="c1">#override constraints input</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xref</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bounds </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> != Xref </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Xref</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;minimize </span><span class="si">{</span><span class="n">Xref</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">Yref</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_weights</span>

        <span class="n">sesh</span><span class="o">.</span><span class="n">_ans</span> <span class="o">=</span> <span class="n">refmin_solve</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">Xref</span><span class="p">,</span> <span class="n">Yref</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_ans</span>

        <span class="n">sesh</span><span class="o">.</span><span class="n">handle_solution</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">_ans</span><span class="p">,</span><span class="n">Xref</span><span class="p">,</span><span class="n">Yref</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>


    <span class="k">def</span> <span class="nf">handle_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">answer</span><span class="p">,</span><span class="n">Xref</span><span class="p">,</span><span class="n">Yref</span><span class="p">,</span><span class="n">output</span><span class="p">):</span>
        <span class="c1">#TODO: move exit condition handiling somewhere else, reduce cross over from process_ans</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">success_thresh</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xref</span><span class="p">)</span>

        <span class="c1">#Output Results</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">answer</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">)}</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Xans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xa</span>
        <span class="n">Ref</span><span class="o">.</span><span class="n">refset_input</span><span class="p">(</span><span class="n">Xref</span><span class="p">,</span><span class="n">Xa</span><span class="p">)</span>

        <span class="n">Yout</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">Yref</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Yref</span><span class="p">}</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Yobj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yout</span>

        <span class="n">Ycon</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">]:</span>
            <span class="n">x_in</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">x</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">],</span><span class="n">sesh</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]):</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">](</span><span class="n">x_in</span><span class="p">,</span><span class="bp">self</span><span class="p">,{})</span>
                <span class="n">Ycon</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;Ycon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ycon</span>   

        <span class="n">de</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">fun</span>
        <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">de</span> <span class="o">&lt;</span> <span class="n">thresh</span> <span class="k">if</span> <span class="n">thresh</span> <span class="k">else</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_converged</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#TODO: put in context</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">answer</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># out of threshold condition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;solver didnt meet threshold: </span><span class="si">{</span><span class="n">de</span><span class="si">}</span><span class="s2"> &lt;? </span><span class="si">{</span><span class="n">thresh</span><span class="si">}</span><span class="s2"> ! </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2"> -&gt; residual: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">fun</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_converged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># only false with threshold</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_converged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_fail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;solver didnt converge: </span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;solver didnt converge: </span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
        <span class="k">return</span> <span class="n">output</span> 

    <span class="c1">#Solver Parsing Methods</span>
    
<div class="viewcode-block" id="ProblemExec.sys_solver_objectives">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.sys_solver_objectives">[docs]</a>
    <span class="k">def</span> <span class="nf">sys_solver_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;gathers variables from solver vars, and attempts to locate any input_vars to add as well. use exclude_vars to eliminate a variable from  the solver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sys_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span>

        <span class="c1">#Convert result per kind of objective (min/max ect)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="n">sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.obj&#39;</span><span class="p">,{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">objs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

    
<div class="viewcode-block" id="ProblemExec.pos_obj">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.pos_obj">[docs]</a>
    <span class="k">def</span> <span class="nf">pos_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;converts an objective to a positive value&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">prob</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ref</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">final_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the final objective of the system&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">Yobj</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">problem_objs</span>
        <span class="n">Yeq</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">problem_eq</span>
        <span class="n">Xss</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">problem_opt_vars</span>
        <span class="k">if</span> <span class="n">Yobj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Yobj</span> <span class="c1">#here is your application objective, sir</span>
        
        <span class="c1">#now make up an objective</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">Yobj</span> <span class="ow">and</span> <span class="n">Yeq</span><span class="p">:</span>
            <span class="c1">#TODO: handle case of Yineq == None with root solver</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;making Yobj from Yeq: </span><span class="si">{</span><span class="n">Yeq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">Yobj</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_obj</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">Yeq</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">Yobj</span><span class="p">:</span>
            <span class="c1">#minimize the product of all vars, so the smallest value is the best that satisfies all constraints</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;making Yobj from X: </span><span class="si">{</span><span class="n">Xss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">dflt</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">problem_opt_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span>
                    <span class="c1"># The code snippet is calculating the linear norm of positive</span>
                    <span class="c1"># values greater than 1 by adding the square root of the sum</span>
                    <span class="c1"># of 1 and the square of the value to the variable `out`. This</span>
                    <span class="c1"># operation is intended to apply a large penalty to positive</span>
                    <span class="c1"># values greater than 1.</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">val</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1">#linear norm of positive values &gt; 1 should be very large penalty </span>
                <span class="k">return</span> <span class="mi">1</span>
            
            <span class="n">Yobj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smallness&#39;</span><span class="p">:</span> <span class="n">Ref</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">dflt</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">Yobj</span> <span class="c1">#our residual based objective</span>

<div class="viewcode-block" id="ProblemExec.sys_solver_constraints">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.sys_solver_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">sys_solver_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">add_con</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">combo_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;formatted as arguments for the solver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">engforge.solver_utils</span> <span class="kn">import</span> <span class="n">create_constraint</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">Xrefs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">Xref</span>

        <span class="n">system</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">system</span>
        <span class="n">sys_refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span>
        <span class="n">all_refz</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">ref_attrs</span>

        <span class="n">extra_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
        
        <span class="c1">#TODO: move to kwarg parsing on setup</span>
        <span class="n">deactivated</span> <span class="o">=</span> <span class="n">ext_str_list</span><span class="p">(</span><span class="n">extra_kw</span><span class="p">,</span><span class="s1">&#39;deactivate&#39;</span><span class="p">,[])</span> <span class="k">if</span> <span class="s1">&#39;deactivate&#39;</span> <span class="ow">in</span> <span class="n">extra_kw</span> <span class="ow">and</span> <span class="n">extra_kw</span><span class="p">[</span><span class="s1">&#39;deactivate&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">activated</span> <span class="o">=</span> <span class="n">ext_str_list</span><span class="p">(</span><span class="n">extra_kw</span><span class="p">,</span><span class="s1">&#39;activate&#39;</span><span class="p">,[])</span> <span class="k">if</span> <span class="s1">&#39;activate&#39;</span> <span class="ow">in</span> <span class="n">extra_kw</span> <span class="ow">and</span>  <span class="n">extra_kw</span><span class="p">[</span><span class="s1">&#39;activate&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">slv_inst</span> <span class="o">=</span> <span class="n">sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,{})</span>
        <span class="n">trv_inst</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="n">sys_refs</span> <span class="o">=</span> <span class="n">sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,{})</span>

        <span class="k">if</span> <span class="n">add_con</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_con</span> <span class="o">=</span> <span class="p">{}</span>
        

        <span class="c1">#The official definition of X var order</span>
        <span class="n">Nstates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xrefs</span><span class="p">)</span>
        <span class="n">Xvars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xrefs</span><span class="p">)</span> <span class="c1">#get names of solvers + dynamics</span>

        <span class="c1"># constraints lookup</span>
        <span class="n">bnd_list</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">*</span> <span class="n">Nstates</span>
        <span class="n">con_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">con_info</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#names of constraints </span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="n">con_list</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">bnd_list</span><span class="p">,</span><span class="s2">&quot;info&quot;</span><span class="p">:</span><span class="n">con_info</span><span class="p">}</span>
        

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_con</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Remove None Values</span>
            <span class="n">nones</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">add_con</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">nones</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">add_con</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;all custom input for constraints must be callable with X as argument&quot;</span>
            <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">add_con</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">add_con</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#youre free!</span>
            <span class="k">return</span> <span class="n">constraints</span>
        
        <span class="c1"># Add Constraints</span>
        <span class="n">ex_arg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;con_args&quot;</span><span class="p">:</span> <span class="p">(),</span><span class="o">**</span><span class="n">kw</span><span class="p">}</span>
        
        <span class="c1">#Variable limit (function -&gt; ineq, numeric -&gt; bounds)</span>
        <span class="c1">#TODO: dynamic limits</span>
        <span class="k">for</span> <span class="n">slvr</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">sesh</span><span class="o">.</span><span class="n">problem_opt_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#TODO: solution to this is to combine the independent variables into one, but allow multiple dependent objectives for constraints/objectives</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">slvr</span> <span class="ow">in</span> <span class="n">slv_inst</span><span class="p">,</span><span class="n">slvr</span> <span class="ow">in</span> <span class="n">trv_inst</span><span class="p">)),</span> <span class="sa">f</span><span class="s1">&#39;solver and integrator share parameter </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="k">if</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">slv_inst</span><span class="p">:</span>
                <span class="n">slv</span> <span class="o">=</span> <span class="n">slv_inst</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
                <span class="n">slv_var</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#mark a static varible</span>
            <span class="k">elif</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">trv_inst</span><span class="p">:</span>
                <span class="n">slv</span> <span class="o">=</span> <span class="n">trv_inst</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
                <span class="n">slv_var</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#a dynamic variable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no solver instance for </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="n">slv_constraints</span> <span class="o">=</span> <span class="n">slv</span><span class="o">.</span><span class="n">constraints</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;constraints </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">slv_constraints</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="k">for</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="n">slv_constraints</span><span class="p">:</span>
                <span class="n">cval</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>       
                <span class="n">var</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;const: </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">Xvars</span><span class="p">:</span>
                    
                    <span class="c1">#Check for combos &amp; activation</span>
                    <span class="n">combos</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="s1">&#39;combos&#39;</span> <span class="ow">in</span> <span class="n">ctype</span><span class="p">:</span>
                        <span class="n">combos</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;combos&#39;</span><span class="p">]</span>
                        <span class="n">combo_var</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;combo_var&#39;</span><span class="p">]</span>
                        <span class="n">active</span> <span class="o">=</span> <span class="n">ctype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">in_activate</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">arg_var_compare</span><span class="p">(</span><span class="n">combo_var</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">activated</span><span class="p">])</span> <span class="k">if</span> <span class="n">activated</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="n">in_deactivate</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">arg_var_compare</span><span class="p">(</span><span class="n">combo_var</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deactivated</span><span class="p">])</span> <span class="k">if</span> <span class="n">deactivated</span> <span class="k">else</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;filter combo: </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s1">=?</span><span class="si">{</span><span class="n">extra_kw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 

                        <span class="c1">#Check active or activated</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">activated</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skip con: inactive </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_activate</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skip con: inactive </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">active</span> <span class="ow">and</span> <span class="n">in_deactivate</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;skip con: deactivated </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
                            <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">combos</span> <span class="ow">and</span> <span class="n">combo_filter</span><span class="p">:</span>
                        <span class="n">filt</span> <span class="o">=</span> <span class="n">filter_combos</span><span class="p">(</span><span class="n">combo_var</span><span class="p">,</span><span class="n">slv</span><span class="p">,</span> <span class="n">extra_kw</span><span class="p">,</span><span class="n">combos</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">filt</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;filtering constraint=</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> |</span><span class="si">{</span><span class="n">combos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
                            <span class="k">continue</span>
                    
                    <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding var constraint </span><span class="si">{</span><span class="n">var</span><span class="p">,</span><span class="n">slvr</span><span class="p">,</span><span class="n">ctype</span><span class="p">,</span><span class="n">combos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 

                    <span class="c1">#get the index of the variable</span>
                    <span class="n">x_inx</span> <span class="o">=</span> <span class="n">Xvars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">slvr</span><span class="p">)</span>        
                    
                    <span class="c1">#lookup rates for overlapping dynamic variables</span>
                    <span class="n">rate_val</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slv_var</span><span class="p">:</span>
                            <span class="n">rate_val</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slvr</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">slv_var</span><span class="p">:</span>
                            <span class="n">rate_val</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1">#add the dynamic parameters when configured</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">slv_var</span> <span class="ow">and</span> <span class="n">rate_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1">#print(f&#39;adding dynamic constraint {slvr} {rate_val}&#39;)</span>
                        <span class="c1">#if kind in (&#39;min&#39;,&#39;max&#39;) and slvr in Xvars:</span>
                        <span class="n">varref</span> <span class="o">=</span> <span class="n">Xrefs</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
                        <span class="c1">#varref = slv.rate_ref</span>
                        <span class="c1">#Ref Case</span>
                        <span class="n">ccst</span> <span class="o">=</span> <span class="n">ref_to_val_constraint</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">system</span><span class="o">.</span><span class="n">last_context</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span><span class="n">varref</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">rate_val</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                        <span class="c1">#con_list.append(ccst)</span>
                        <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dxdt_</span><span class="si">{</span><span class="n">varref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cval</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccst</span><span class="p">)</span> 

                    <span class="c1"># elif slv_var:                       </span>
                    <span class="k">elif</span> <span class="n">slv_var</span><span class="p">:</span>
                        <span class="c1">#establish simple bounds w/ solver  </span>
                        <span class="k">if</span> <span class="p">(</span> 
                            <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">Xvars</span>
                            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cval</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                        <span class="p">):</span>
                            <span class="n">minv</span><span class="p">,</span> <span class="n">maxv</span> <span class="o">=</span> <span class="n">bnd_list</span><span class="p">[</span><span class="n">x_inx</span><span class="p">]</span>
                            <span class="n">bnd_list</span><span class="p">[</span><span class="n">x_inx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">cval</span> <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span> <span class="k">else</span> <span class="n">minv</span><span class="p">,</span>
                                <span class="n">cval</span> <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">maxv</span><span class="p">,</span>
                                <span class="p">]</span>
                                
                        <span class="c1">#add the bias of cval to the objective function</span>
                        <span class="k">elif</span>  <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">Xvars</span><span class="p">:</span>
                            <span class="n">varref</span> <span class="o">=</span> <span class="n">Xrefs</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
                            <span class="c1">#Ref Case</span>
                            <span class="n">ccst</span> <span class="o">=</span> <span class="n">ref_to_val_constraint</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">system</span><span class="o">.</span><span class="n">last_context</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span><span class="n">varref</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">cval</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                            <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;val_</span><span class="si">{</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccst</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bad constraint: </span><span class="si">{</span><span class="n">cval</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">slv_var</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add Constraints</span>
        <span class="k">for</span> <span class="n">slvr</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_ineq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">slv</span> <span class="o">=</span> <span class="n">slv_inst</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
            <span class="n">slv_constraints</span> <span class="o">=</span> <span class="n">slv</span><span class="o">.</span><span class="n">constraints</span>
            <span class="n">parent</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parent_key</span><span class="p">(</span><span class="n">slvr</span><span class="p">,</span><span class="n">look_back_num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#get the parent comp</span>
            <span class="k">for</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="n">slv_constraints</span><span class="p">:</span>
                <span class="n">cval</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>                    
                <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ineq_</span><span class="si">{</span><span class="n">parent</span><span class="si">}{</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cval</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;filtering constraint </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> |</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">create_constraint</span><span class="p">(</span>
                            <span class="n">system</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">for</span> <span class="n">slvr</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_eq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parent_key</span><span class="p">(</span><span class="n">slvr</span><span class="p">,</span><span class="n">look_back_num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#get the parent comp</span>
            <span class="k">if</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">slv_inst</span> <span class="ow">and</span> <span class="n">slvr</span> <span class="ow">in</span> <span class="n">all_refz</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.eq&#39;</span><span class="p">,{}):</span>
                <span class="n">slv</span> <span class="o">=</span> <span class="n">slv_inst</span><span class="p">[</span><span class="n">slvr</span><span class="p">]</span>
                <span class="n">slv_constraints</span> <span class="o">=</span> <span class="n">slv</span><span class="o">.</span><span class="n">constraints</span>
                
                <span class="k">for</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="n">slv_constraints</span><span class="p">:</span>
                    <span class="n">cval</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">kind</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>                    
                    <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;eq_</span><span class="si">{</span><span class="n">parent</span><span class="si">}{</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cval</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;filtering constraint </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> |</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>                        
                        <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;eq_</span><span class="si">{</span><span class="n">parent</span><span class="si">}{</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cval</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">create_constraint</span><span class="p">(</span>
                                <span class="n">system</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#This must be a dynamic rate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dynamic rate eq </span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
                <span class="n">con_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;eq_</span><span class="si">{</span><span class="n">parent</span><span class="si">}{</span><span class="n">ref</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">classname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">slvr</span><span class="si">}</span><span class="s1">_rate&#39;</span><span class="p">)</span>
                <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">create_constraint</span><span class="p">(</span>
                        <span class="n">system</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                


        <span class="k">return</span> <span class="n">constraints</span> </div>


    <span class="c1"># General method to distribute input to internal components</span>
<div class="viewcode-block" id="ProblemExec.parse_default">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.parse_default">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">defaults</span><span class="p">,</span><span class="n">input_dict</span><span class="p">,</span><span class="n">rmv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">empty_str</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;splits strings or lists and returns a list of options for the key, if nothing found returns None if fail set to True raises an exception, otherwise returns the default value&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
            <span class="c1">#kwargs will no longer have key!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rmv</span><span class="p">:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c1">#print(f&#39;removing option {key} {option}&#39;)</span>
            <span class="k">if</span> <span class="n">option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">option</span><span class="p">,</span><span class="kc">False</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">option</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">option</span><span class="p">,</span><span class="kc">False</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">option</span><span class="p">:</span>
                     <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="kc">False</span>
                
                <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    
            <span class="k">return</span> <span class="n">option</span><span class="p">,</span><span class="kc">False</span>
        
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span></div>

        

<div class="viewcode-block" id="ProblemExec.get_extra_kws">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.get_extra_kws">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extra_kws</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">kwargs</span><span class="p">,</span><span class="n">_check_keys</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="n">slv_dflt_options</span><span class="p">,</span><span class="n">rmv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extracts the combo input from the kwargs&quot;&quot;&quot;</span>
        <span class="c1"># extract combo input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">_check_keys</span> <span class="o">=</span> <span class="n">_check_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#TODO: allow extended check_keys / defaults to be passed in, now every value in check_keys has a default</span>
        <span class="n">cur_in</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">dflt</span> <span class="ow">in</span> <span class="n">_check_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span><span class="p">,</span><span class="n">is_dflt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">_check_keys</span><span class="p">,</span><span class="n">cur_in</span><span class="p">,</span><span class="n">rmv</span><span class="o">=</span><span class="n">rmv</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dflt</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">use_defaults</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">rmv</span><span class="p">:</span>
                <span class="n">cur_in</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#copy from data</span>
        <span class="n">filtr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_check_keys</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="c1">#print(f&#39;got {combos} -&gt; {comboos} from {kwargs} with {_check_keys}&#39;)</span>
        <span class="k">return</span> <span class="n">filtr</span>    </div>


    <span class="c1">#State Interfaces</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">record_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;records the state of the system using session&quot;&quot;&quot;</span>
        <span class="c1">#refs = self.all_variable_refs</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_comps_and_vars</span> <span class="c1">#no need for properties</span>
        <span class="k">return</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_get</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span><span class="n">sys</span><span class="o">=</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">prob</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;records the state of the system&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="c1">#TODO: add system_properties to num_refs / all_system_refs ect.</span>
        <span class="k">if</span> <span class="s1">&#39;nums&#39;</span> <span class="o">==</span> <span class="n">sesh</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">num_refs</span>
        <span class="k">elif</span> <span class="s1">&#39;all&#39;</span> <span class="o">==</span> <span class="n">sesh</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_system_references</span>
        <span class="k">elif</span> <span class="s1">&#39;vars&#39;</span> <span class="o">==</span> <span class="n">sesh</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_variable_refs</span>
        <span class="k">elif</span> <span class="s1">&#39;prob&#39;</span> <span class="o">==</span> <span class="n">sesh</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem save mode not implemented&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown save mode </span><span class="si">{</span><span class="n">sesh</span><span class="o">.</span><span class="n">save_mode</span><span class="si">}</span><span class="s1">, not in </span><span class="si">{</span><span class="n">save_modes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_get</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span><span class="n">sys</span><span class="o">=</span><span class="n">sesh</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">prob</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1">#Integration</span>
        <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_time</span>

        <span class="k">return</span> <span class="n">out</span>
    
    
<div class="viewcode-block" id="ProblemExec.get_ref_values">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.get_ref_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ref_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the values of the refs&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_system_references</span>
        <span class="k">return</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_get</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span><span class="n">sys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span><span class="n">prob</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ProblemExec.set_ref_values">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.set_ref_values">[docs]</a>
    <span class="k">def</span> <span class="nf">set_ref_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">refs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the values of the refs&quot;&quot;&quot;</span>
        <span class="c1">#TODO: add checks for the refs</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_comps_and_vars</span>        
        <span class="k">return</span> <span class="n">Ref</span><span class="o">.</span><span class="n">refset_input</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span><span class="n">values</span><span class="p">)</span>    </div>


<div class="viewcode-block" id="ProblemExec.set_checkpoint">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.set_checkpoint">[docs]</a>
    <span class="k">def</span> <span class="nf">set_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sets the checkpoint&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_state</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;set checkpoint: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_start</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">revert_to_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_start</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_state</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;reverting to start: </span><span class="si">{</span><span class="n">xs</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">rs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#TODO: STRICT MODE Fail for refset_input</span>
        <span class="n">Ref</span><span class="o">.</span><span class="n">refset_input</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">all_comps_and_vars</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_start</span><span class="p">,</span><span class="n">fail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">activate_temp_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#TODO: determine when components change, and update refs accordingly!</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="c1">#TODO: STRICT MODE Fail for refset_input</span>
        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;new-state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">Ref</span><span class="o">.</span><span class="n">refset_input</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">all_comps_and_vars</span><span class="p">,</span><span class="n">new_state</span><span class="p">,</span><span class="n">fail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;act-state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">Ref</span><span class="o">.</span><span class="n">refset_input</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">all_comps_and_vars</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="p">,</span><span class="n">fail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no-state: </span><span class="si">{</span><span class="n">new_state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#initial establishment costs / ect</span>
        <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">:</span>
            <span class="n">sesh</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>                
        

    <span class="c1">#System Events</span>
<div class="viewcode-block" id="ProblemExec.apply_pre_signals">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.apply_pre_signals">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_pre_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;applies all pre signals&quot;&quot;&quot;</span>
        <span class="n">msg_lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying pre signals&quot;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">signame</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span> <span class="ow">or</span> <span class="n">sig</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg_lvl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying post signals: </span><span class="si">{</span><span class="n">signame</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>                
                <span class="n">sig</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProblemExec.apply_post_signals">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.apply_post_signals">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_post_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;applies all post signals&quot;&quot;&quot;</span>
        <span class="n">msg_lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying post signals&quot;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">signame</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;post&quot;</span> <span class="ow">or</span> <span class="n">sig</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg_lvl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying post signals: </span><span class="si">{</span><span class="n">signame</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">lvl</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">sig</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProblemExec.update_system">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.update_system">[docs]</a>
    <span class="k">def</span> <span class="nf">update_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;updates the system&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ukey</span><span class="p">,</span><span class="n">uref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_update_refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;context updating </span><span class="si">{</span><span class="n">ukey</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">uref</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemExec.post_update_system">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.post_update_system">[docs]</a>
    <span class="k">def</span> <span class="nf">post_update_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;updates the system&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ukey</span><span class="p">,</span><span class="n">uref</span> <span class="ow">in</span>  <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_post_update_refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;context post updating </span><span class="si">{</span><span class="n">ukey</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">uref</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemExec.pre_execute">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.pre_execute">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the pre/both signals after the solver has been executed. This is useful for updating the system state after the solver has been executed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre execute&quot;</span><span class="p">)</span>

        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">apply_pre_signals</span><span class="p">()</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">update_system</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="ProblemExec.post_execute">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.post_execute">[docs]</a>
    <span class="k">def</span> <span class="nf">post_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the post/both signals after the solver has been executed. This is useful for updating the system state after the solver has been executed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;post execute&quot;</span><span class="p">)</span>

        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">apply_post_signals</span><span class="p">()</span>
        <span class="n">sesh</span><span class="o">.</span><span class="n">post_update_system</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    


    <span class="c1">#Logging to class logger</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;PROB|</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span>

    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">|[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_number</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">}</span><span class="s1">]  </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="c1">#Safe Access Methods</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attr_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_sys_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamic_comps&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1">#Instances</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integrators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_inst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signal_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_inst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solver_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_inst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;copy of slv_kw args&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">_slv_kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamics.state&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamics.rate&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">problem_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamics.input&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>      

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integrator_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time.var&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integrator_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time.rate&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1">#Y solver variables</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">problem_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.obj&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">problem_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.eq&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_eq</span> <span class="c1">#wysiwyg</span>
        <span class="n">base_eq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_rate_eq</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_eq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xref</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem_eq has more items than variables </span><span class="si">{</span><span class="n">base_eq</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Xref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#TODO: in this case combine the rate_eq to prevent this error</span>

        <span class="k">return</span> <span class="n">base_eq</span>
        

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_rate_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Add Dynamics Rate Equalities</span>
        <span class="n">base_eq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#zero case</span>
            <span class="k">return</span> <span class="n">base_eq</span>
        
        <span class="n">Xrefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xref</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="c1">#henceforth, the rate shall be equal to somethign!</span>
        <span class="n">base_eq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_rate</span><span class="p">)</span>
        <span class="n">base_eq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrator_rates</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#TODO: handle callable case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1">#add in the dynamic rate constraints</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">varref</span> <span class="ow">in</span> <span class="n">base_eq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">):</span>
                    <span class="n">rate_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#zero default rate</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
                    <span class="n">rate_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdt</span>
                    <span class="n">con_ref</span> <span class="o">=</span> <span class="n">ref_to_val_constraint</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="n">system</span><span class="o">.</span><span class="n">last_context</span><span class="p">,</span><span class="n">Xrefs</span><span class="p">,</span><span class="n">varref</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="n">rate_val</span><span class="p">,</span><span class="n">return_ref</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_ref</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">varref</span> <span class="c1">#zip rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#thou shalt be zero (no ref modifications)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">base_eq</span>

        <span class="k">return</span> <span class="n">out</span>      
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">problem_ineq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.ineq&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signals_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal.source&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signals_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal.target&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal.signal&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#formatted output</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;checks if the context has been entered and not exited&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exited</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solveable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;checks the system&#39;s references to determine if its solveabl&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span><span class="o">.</span><span class="n">problem_opt_vars</span><span class="p">:</span>
            <span class="c1">#TODO: expand this</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integrator_rate_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;combine the dynamic state and the integrator rates to get the transient state of the system, but convert their keys to the target var names &quot;&quot;&quot;</span>
        <span class="n">dc</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">int_name</span><span class="p">,</span><span class="n">intinst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">intinst</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="n">dc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conflict with integrator name </span><span class="si">{</span><span class="n">intinst</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1"> and dynamic state&#39;</span><span class="p">)</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">intinst</span><span class="o">.</span><span class="n">var</span><span class="p">:</span><span class="n">intinst</span><span class="o">.</span><span class="n">rate_ref</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">dc</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integrator_var_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;combine the dynamic state and the integrator rates to get the transient state of the system, but convert their keys to the target var names &quot;&quot;&quot;</span>
        <span class="n">dc</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">int_name</span><span class="p">,</span><span class="n">intinst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">intinst</span><span class="o">.</span><span class="n">var_ref</span> <span class="ow">in</span> <span class="n">dc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conflict with integrator name </span><span class="si">{</span><span class="n">intinst</span><span class="o">.</span><span class="n">var_ref</span><span class="si">}</span><span class="s1"> and dynamic state&#39;</span><span class="p">)</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">intinst</span><span class="o">.</span><span class="n">var</span><span class="p">:</span><span class="n">intinst</span><span class="o">.</span><span class="n">var_ref</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">dc</span>    
    
    <span class="c1">#Dataframe support</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the dataframe of the system&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">kv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                   <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">format_columns</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c1">#TODO: expose optoin for saving all or part of the system information, for now lets default to all (saftey first, then performance :)</span>
<div class="viewcode-block" id="ProblemExec.get_parent_key">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.get_parent_key">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parent_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">look_back_num</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the parent key of the key&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">look_back_num</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="n">look_back_num</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

        
    <span class="c1">#Dynamics Interface</span>
<div class="viewcode-block" id="ProblemExec.filter_vars">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.ProblemExec.html#engforge.problem_context.ProblemExec.filter_vars">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refs</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;selects only settable refs&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parent_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}{</span><span class="n">v</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">refs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">allow_set</span><span class="p">}</span>   </div>


    <span class="c1">#X solver variable refs</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">problem_opt_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solver variables&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.var&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_problem_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solver variables + dynamics states when dynamic_solve is True&quot;&quot;&quot;</span>
        <span class="n">varx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver.var&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#Add the dynamic states to be optimized (ignore if integrating)</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="k">if</span> <span class="n">sesh</span><span class="o">.</span><span class="n">dynamic_solve</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">varx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">dynamic_state</span><span class="p">)</span>
            <span class="n">varx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_vars</span><span class="p">(</span><span class="n">sesh</span><span class="o">.</span><span class="n">integrator_vars</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">varx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;indicates if the system is dynamic&quot;&quot;&quot;</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">dxdt</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">_dxdt</span>

        <span class="k">if</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">dxdt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="n">in_type</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,(</span><span class="nb">dict</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">bool_type</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dxdt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">in_type</span> <span class="ow">or</span> <span class="n">bool_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_variable_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">ing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator_vars</span>
        <span class="n">stt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_state</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_opt_vars</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">ing</span><span class="p">,</span><span class="o">**</span><span class="n">stt</span><span class="p">,</span><span class="o">**</span><span class="nb">vars</span><span class="p">}</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns all variables in the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_refs</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns all variables in the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_refs</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns all variables in the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_refs</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_comps_and_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="c1">#TODO: ensure system refes are fresh per system runtime events</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_refs</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_system_references</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="n">sesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sesh</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">sesh</span><span class="o">.</span><span class="n">all_refs</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#TODO: expand this</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ProblemContext[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level_name</span><span class="si">:</span><span class="s1">^12</span><span class="si">}</span><span class="s1">][</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">][</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">identity</span><span class="si">}</span><span class="s1">]&#39;</span></div>

    

<span class="c1">#TODO: move all system_reference concept inside problem context, remove from system/tabulation ect.</span>
<span class="c1">#TODO: use prob.register/change(comp,key=&#39;&#39;) to add components to the problem context, mapping subcomponents to the problem context</span>
<span class="c1">#TODO: make a graph of all problem dependencies and use that to determine the order of operations, and subsequent updates.</span>

    
<span class="c1">#subclass before altering please!</span>
<span class="n">ProblemExec</span><span class="o">.</span><span class="n">class_cache</span> <span class="o">=</span> <span class="n">ProblemExec</span>

<div class="viewcode-block" id="Problem">
<a class="viewcode-back" href="../../_autosummary/engforge.problem_context.Problem.html#engforge.problem_context.Problem">[docs]</a>
<span class="k">class</span> <span class="nc">Problem</span><span class="p">(</span><span class="n">ProblemExec</span><span class="p">,</span><span class="n">DataframeMixin</span><span class="p">):</span>
    <span class="c1">#TODO: implement checks to ensure that problem is defined as the top level context to be returned to</span>
    <span class="c1">#TODO: also define return options for data/system/dataframe and indexing</span>
    <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;top&#39;</span> <span class="c1">#fixed top output, garuntees exit to here.</span>
    
    <span class="nd">@level_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">level_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot set level_name of top level problem context&#39;</span><span class="p">)</span></div>




</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Russell.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>